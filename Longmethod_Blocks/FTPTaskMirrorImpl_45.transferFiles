int#transferFiles#(#final#FTPClient#ftp#,#FileSet#fs#)#throws#IOException#,#BuildException#{#DirectoryScanner#ds#;##if#(#task#.#getAction#(#)#==#FTPTask#.#SEND_FILES#)#{#ds#=#fs#.#getDirectoryScanner#(#task#.#getProject#(#)#)#;#}#else#{#ds#=#new#FTPDirectoryScanner#(#ftp#)#;#fs#.#setupDirectoryScanner#(#ds#,#task#.#getProject#(#)#)#;#ds#.#setFollowSymlinks#(#fs#.#isFollowSymlinks#(#)#)#;#ds#.#scan#(#)#;#}##String#[#]#dsfiles#=#null#;##if#(#task#.#getAction#(#)#==#FTPTask#.#RM_DIR#)#{#dsfiles#=#ds#.#getIncludedDirectories#(#)#;#}#else#{#dsfiles#=#ds#.#getIncludedFiles#(#)#;#}##String#dir#=#null#;##if#(#(#ds#.#getBasedir#(#)#==#null#)#&&#(#(#task#.#getAction#(#)#==#FTPTask#.#SEND_FILES#)#||#(#task#.#getAction#(#)#==#FTPTask#.#GET_FILES#)#)#)#{#throw#new#BuildException#(#"the dir attribute must be set for send "#+#"and get actions"#)#;#}#else#{##if#(#(#task#.#getAction#(#)#==#FTPTask#.#SEND_FILES#)#||#(#task#.#getAction#(#)#==#FTPTask#.#GET_FILES#)#)#{#dir#=#ds#.#getBasedir#(#)#.#getAbsolutePath#(#)#;#}#}##// If we are doing a listing, we need the output stream created now.#BufferedWriter#bw#=#null#;##try#{##if#(#task#.#getAction#(#)#==#FTPTask#.#LIST_FILES#)#{#File#pd#=#task#.#getListing#(#)#.#getParentFile#(#)#;##if#(#!#pd#.#exists#(#)#)#{#pd#.#mkdirs#(#)#;#}##bw#=#new#BufferedWriter#(#new#FileWriter#(#task#.#getListing#(#)#)#)#;#}##RetryHandler#h#=#new#RetryHandler#(#task#.#getRetriesAllowed#(#)#,#task#)#;##if#(#task#.#getAction#(#)#==#FTPTask#.#RM_DIR#)#{##// to remove directories, start by the end of the list##// the trunk does not let itself be removed before the leaves#for#(#int#i#=#dsfiles#.#length#-#1#;##i#>=#0#;#i#--#)#{#final#String#dsfile#=#dsfiles#[#i#]#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#rmDir#(#ftp#,#dsfile#)#;#}#}##,#dsfile#)#;#}#}#else#{#final#BufferedWriter#fbw#=#bw#;#final#String#fdir#=#dir#;##if#(#task#.#isNewer#(#)#)#{#task#.#setGranularityMillis#(#task#.#getTimestampGranularity#(#)#.#getMilliseconds#(#task#.#getAction#(#)#)#)#;#}##for#(#int#i#=#0#;##i#<#dsfiles#.#length#;#i#++#)#{#final#String#dsfile#=#dsfiles#[#i#]#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#switch#(#task#.#getAction#(#)#)#{#case#FTPTask#.#SEND_FILES#:#sendFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#FTPTask#.#GET_FILES#:#getFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#FTPTask#.#DEL_FILES#:#delFile#(#ftp#,#dsfile#)#;#break#;#case#FTPTask#.#LIST_FILES#:#listFile#(#ftp#,#fbw#,#dsfile#)#;#break#;#case#FTPTask#.#CHMOD#:#doSiteCommand#(#ftp#,#"chmod "#+#task#.#getChmod#(#)#+#" "#+#resolveFile#(#dsfile#)#)#;#transferred#++#;#break#;#default#:#throw#new#BuildException#(#"unknown ftp action "#+#task#.#getAction#(#)#)#;#}#}#}##,#dsfile#)#;#}#}#}##finally#{##if#(#bw#!=#null#)#{#bw#.#close#(#)#;#}#}##return#dsfiles#.#length#;#}