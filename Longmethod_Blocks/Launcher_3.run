int#run#(#String#[#]#args#)#throws#LaunchException#,#MalformedURLException#{#String#antHomeProperty#=#System#.#getProperty#(#ANTHOME_PROPERTY#)#;#File#antHome#=#null#;#File#sourceJar#=#Locator#.#getClassSource#(#getClass#(#)#)#;#File#jarDir#=#sourceJar#.#getParentFile#(#)#;#String#mainClassname#=#MAIN_CLASS#;##if#(#antHomeProperty#!=#null#)#{#antHome#=#new#File#(#antHomeProperty#)#;#}##if#(#antHome#==#null#||#!#antHome#.#exists#(#)#)#{#antHome#=#jarDir#.#getParentFile#(#)#;#setProperty#(#ANTHOME_PROPERTY#,#antHome#.#getAbsolutePath#(#)#)#;#}##if#(#!#antHome#.#exists#(#)#)#{#throw#new#LaunchException#(#"Ant home is set incorrectly or "#+#"ant could not be located (estimated value="#+#antHome#.#getAbsolutePath#(#)#+#")"#)#;#}##List#libPaths#=#new#ArrayList#(#)#;#String#cpString#=#null#;#List#argList#=#new#ArrayList#(#)#;#String#[#]#newArgs#;#boolean#noUserLib#=#false#;#boolean#noClassPath#=#false#;##for#(#int#i#=#0#;##i#<#args#.#length#;#++#i#)#{##if#(#args#[#i#]#.#equals#(#"-lib"#)#)#{##if#(#i#==#args#.#length#-#1#)#{#throw#new#LaunchException#(#"The -lib argument must "#+#"be followed by a library location"#)#;#}##libPaths#.#add#(#args#[#++#i#]#)#;#}#else##if#(#args#[#i#]#.#equals#(#"-cp"#)#)#{##if#(#i#==#args#.#length#-#1#)#{#throw#new#LaunchException#(#"The -cp argument must "#+#"be followed by a classpath expression"#)#;#}##if#(#cpString#!=#null#)#{#throw#new#LaunchException#(#"The -cp argument must "#+#"not be repeated"#)#;#}##cpString#=#args#[#++#i#]#;#}#else##if#(#args#[#i#]#.#equals#(#"--nouserlib"#)#||#args#[#i#]#.#equals#(#"-nouserlib"#)#)#{#noUserLib#=#true#;#}#else##if#(#args#[#i#]#.#equals#(#"--launchdiag"#)#)#{#launchDiag#=#true#;#}#else##if#(#args#[#i#]#.#equals#(#"--noclasspath"#)#||#args#[#i#]#.#equals#(#"-noclasspath"#)#)#{#noClassPath#=#true#;#}#else##if#(#args#[#i#]#.#equals#(#"-main"#)#)#{##if#(#i#==#args#.#length#-#1#)#{#throw#new#LaunchException#(#"The -main argument must "#+#"be followed by a library location"#)#;#}##mainClassname#=#args#[#++#i#]#;#}#else#{#argList#.#add#(#args#[#i#]#)#;#}#}##logPath#(#"Launcher JAR"#,#sourceJar#)#;#logPath#(#"Launcher JAR directory"#,#sourceJar#.#getParentFile#(#)#)#;#logPath#(#"java.home"#,#new#File#(#System#.#getProperty#(#"java.home"#)#)#)#;##//decide whether to copy the existing arg set, or##//build a new one from the list of all args excluding the special##//operations that only we handle##if#(#argList#.#size#(#)#==#args#.#length#)#{#newArgs#=#args#;#}#else#{#newArgs#=#(#String#[#]#)#argList#.#toArray#(#new#String#[#argList#.#size#(#)#]#)#;#}##URL#[#]#libURLs#=#getLibPathURLs#(#noClassPath#?#null#:#cpString#,#libPaths#)#;#URL#[#]#systemURLs#=#getSystemURLs#(#jarDir#)#;#URL#[#]#userURLs#=#noUserLib#?#new#URL#[#0#]#:#getUserURLs#(#)#;#File#toolsJAR#=#Locator#.#getToolsJar#(#)#;#logPath#(#"tools.jar"#,#toolsJAR#)#;#URL#[#]#jars#=#getJarArray#(#libURLs#,#userURLs#,#systemURLs#,#toolsJAR#)#;##// now update the class.path property#StringBuffer#baseClassPath#=#new#StringBuffer#(#System#.#getProperty#(#JAVA_CLASS_PATH#)#)#;##if#(#baseClassPath#.#charAt#(#baseClassPath#.#length#(#)#-#1#)#==#File#.#pathSeparatorChar#)#{#baseClassPath#.#setLength#(#baseClassPath#.#length#(#)#-#1#)#;#}##for#(#int#i#=#0#;##i#<#jars#.#length#;#++#i#)#{#baseClassPath#.#append#(#File#.#pathSeparatorChar#)#;#baseClassPath#.#append#(#Locator#.#fromURI#(#jars#[#i#]#.#toString#(#)#)#)#;#}##setProperty#(#JAVA_CLASS_PATH#,#baseClassPath#.#toString#(#)#)#;#URLClassLoader#loader#=#new#URLClassLoader#(#jars#)#;#Thread#.#currentThread#(#)#.#setContextClassLoader#(#loader#)#;#Class#mainClass#=#null#;#int#exitCode#=#0#;#Throwable#thrown#=#null#;##try#{#mainClass#=#loader#.#loadClass#(#mainClassname#)#;#AntMain#main#=#(#AntMain#)#mainClass#.#newInstance#(#)#;#main#.#startAnt#(#newArgs#,#null#,#null#)#;#}##catch#(#InstantiationException#ex#)#{#System#.#err#.#println#(#"Incompatible version of "#+#mainClassname#+#" detected"#)#;#File#mainJar#=#Locator#.#getClassSource#(#mainClass#)#;#System#.#err#.#println#(#"Location of this class "#+#mainJar#)#;#thrown#=#ex#;#}##catch#(#ClassNotFoundException#cnfe#)#{#System#.#err#.#println#(#"Failed to locate"#+#mainClassname#)#;#thrown#=#cnfe#;#}##catch#(#Throwable#t#)#{#t#.#printStackTrace#(#System#.#err#)#;#thrown#=#t#;#}##if#(#thrown#!=#null#)#{#System#.#err#.#println#(#ANTHOME_PROPERTY#+#": "#+#antHome#.#getAbsolutePath#(#)#)#;#System#.#err#.#println#(#"Classpath: "#+#baseClassPath#.#toString#(#)#)#;#System#.#err#.#println#(#"Launcher JAR: "#+#sourceJar#.#getAbsolutePath#(#)#)#;#System#.#err#.#println#(#"Launcher Directory: "#+#jarDir#.#getAbsolutePath#(#)#)#;#exitCode#=#EXIT_CODE_ERROR#;#}##return#exitCode#;#}