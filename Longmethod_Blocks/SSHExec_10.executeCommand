void#executeCommand#(#Session#session#,#String#cmd#,#StringBuffer#sb#)#throws#BuildException#{#ByteArrayOutputStream#out#=#new#ByteArrayOutputStream#(#)#;#TeeOutputStream#tee#=#new#TeeOutputStream#(#out#,#KeepAliveOutputStream#.#wrapSystemOut#(#)#)#;#InputStream#istream#=#null#;##if#(#inputFile#!=#null#)#{#try#{#istream#=#new#FileInputStream#(#inputFile#)#;#}##catch#(#IOException#e#)#{##// because we checked the existence before, this one##// shouldn't happen What if the file exists, but there##// are no read permissions?#log#(#"Failed to read "#+#inputFile#+#" because of: "#+#e#.#getMessage#(#)#,#Project#.#MSG_WARN#)#;#}#}##if#(#inputProperty#!=#null#)#{#String#inputData#=#getProject#(#)#.#getProperty#(#inputProperty#)#;##if#(#inputData#!=#null#)#{#istream#=#new#ByteArrayInputStream#(#inputData#.#getBytes#(#)#)#;#}#}##try#{#final#ChannelExec#channel#;#session#.#setTimeout#(#(#int#)#maxwait#)#;##/* execute the command */#channel#=#(#ChannelExec#)#session#.#openChannel#(#"exec"#)#;#channel#.#setCommand#(#cmd#)#;#channel#.#setOutputStream#(#tee#)#;#channel#.#setExtOutputStream#(#tee#)#;##if#(#istream#!=#null#)#{#channel#.#setInputStream#(#istream#)#;#}##channel#.#connect#(#)#;##// wait for it to finish#thread#=#new#Thread#(#)#{#public#void#run#(#)#{#while#(#!#channel#.#isClosed#(#)#)#{##if#(#thread#==#null#)#{##return#;#}##try#{#sleep#(#RETRY_INTERVAL#)#;#}##catch#(#Exception#e#)#{##// ignored#}#}#}#}#;#thread#.#start#(#)#;#thread#.#join#(#maxwait#)#;##if#(#thread#.#isAlive#(#)#)#{##// ran out of time#thread#=#null#;##if#(#getFailonerror#(#)#)#{#throw#new#BuildException#(#TIMEOUT_MESSAGE#)#;#}#else#{#log#(#TIMEOUT_MESSAGE#,#Project#.#MSG_ERR#)#;#}#}#else#{##//success##if#(#outputFile#!=#null#)#{#writeToFile#(#out#.#toString#(#)#,#append#,#outputFile#)#;#}##// this is the wrong test if the remote OS is OpenVMS,##// but there doesn't seem to be a way to detect it.#int#ec#=#channel#.#getExitStatus#(#)#;##if#(#ec#!=#0#)#{#String#msg#=#"Remote command failed with exit status "#+#ec#;##if#(#getFailonerror#(#)#)#{#throw#new#BuildException#(#msg#)#;#}#else#{#log#(#msg#,#Project#.#MSG_ERR#)#;#}#}#}#}##catch#(#BuildException#e#)#{#throw#e#;#}##catch#(#JSchException#e#)#{##if#(#e#.#getMessage#(#)#.#indexOf#(#"session is down"#)#>=#0#)#{##if#(#getFailonerror#(#)#)#{#throw#new#BuildException#(#TIMEOUT_MESSAGE#,#e#)#;#}#else#{#log#(#TIMEOUT_MESSAGE#,#Project#.#MSG_ERR#)#;#}#}#else#{##if#(#getFailonerror#(#)#)#{#throw#new#BuildException#(#e#)#;#}#else#{#log#(#"Caught exception: "#+#e#.#getMessage#(#)#,#Project#.#MSG_ERR#)#;#}#}#}##catch#(#Exception#e#)#{##if#(#getFailonerror#(#)#)#{#throw#new#BuildException#(#e#)#;#}#else#{#log#(#"Caught exception: "#+#e#.#getMessage#(#)#,#Project#.#MSG_ERR#)#;#}#}##finally#{#sb#.#append#(#out#.#toString#(#)#)#;#FileUtils#.#close#(#istream#)#;#}#}