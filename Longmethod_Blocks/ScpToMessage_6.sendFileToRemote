void#sendFileToRemote#(#File#localFile#,#InputStream#in#,#OutputStream#out#)#throws#IOException#{##// send "C0644 filesize filename", where filename should not include '/'#long#filesize#=#localFile#.#length#(#)#;#String#command#=#"C0644 "#+#filesize#+#" "#;#command#+=#localFile#.#getName#(#)#;#command#+=#"\n"#;#out#.#write#(#command#.#getBytes#(#)#)#;#out#.#flush#(#)#;#waitForAck#(#in#)#;##// send a content of lfile#FileInputStream#fis#=#new#FileInputStream#(#localFile#)#;#byte#[#]#buf#=#new#byte#[#BUFFER_SIZE#]#;#long#startTime#=#System#.#currentTimeMillis#(#)#;#long#totalLength#=#0#;##// only track progress for files larger than 100kb in verbose mode#boolean#trackProgress#=#getVerbose#(#)#&&#filesize#>#HUNDRED_KILOBYTES#;##// since filesize keeps on decreasing we have to store the##// initial filesize#long#initFilesize#=#filesize#;#int#percentTransmitted#=#0#;##try#{##if#(#this#.#getVerbose#(#)#)#{#log#(#"Sending: "#+#localFile#.#getName#(#)#+#" : "#+#localFile#.#length#(#)#)#;#}##while#(#true#)#{#int#len#=#fis#.#read#(#buf#,#0#,#buf#.#length#)#;##if#(#len#<=#0#)#{#break#;#}##out#.#write#(#buf#,#0#,#len#)#;#totalLength#+=#len#;##if#(#trackProgress#)#{#percentTransmitted#=#trackProgress#(#initFilesize#,#totalLength#,#percentTransmitted#)#;#}#}##out#.#flush#(#)#;#sendAck#(#out#)#;#waitForAck#(#in#)#;#}##finally#{##if#(#this#.#getVerbose#(#)#)#{#long#endTime#=#System#.#currentTimeMillis#(#)#;#logStats#(#startTime#,#endTime#,#totalLength#)#;#}##fis#.#close#(#)#;#}#}