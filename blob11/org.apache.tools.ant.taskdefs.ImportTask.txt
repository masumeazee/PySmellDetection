void#setOptional#(#boolean#optional#)#{#this#.#optional#=#optional#;#}##void#setFile#(#String#file#)#{#// I don't think we can use File - different rules#// for relative paths.#this#.#file#=#file#;#}##void#setAs#(#String#prefix#)#{#targetPrefix#=#prefix#;#}##void#setPrefixSeparator#(#String#s#)#{#prefixSeparator#=#s#;#}##void#add#(#ResourceCollection#r#)#{#resources#.#add#(#r#)#;#}##void#execute#(#)#{#if#(#file#==#null#&&#resources#.#size#(#)#==#0#)#{#throw#new#BuildException#(#"import requires file attribute or"#+#" at least one nested resource"#)#;#}#if#(#getOwningTarget#(#)#==#null#||#!#""#.#equals#(#getOwningTarget#(#)#.#getName#(#)#)#)#{#throw#new#BuildException#(#"import only allowed as a top-level task"#)#;#}#ProjectHelper#helper#=#(#ProjectHelper#)#getProject#(#)#.#getReference#(#ProjectHelper#.#PROJECTHELPER_REFERENCE#)#;#if#(#helper#==#null#)#{#// this happens if the projecthelper was not registered with the project.#throw#new#BuildException#(#"import requires support in ProjectHelper"#)#;#}#Vector#importStack#=#helper#.#getImportStack#(#)#;#if#(#importStack#.#size#(#)#==#0#)#{#// this happens if ant is used with a project#// helper that doesn't set the import.#throw#new#BuildException#(#"import requires support in ProjectHelper"#)#;#}#if#(#getLocation#(#)#==#null#||#getLocation#(#)#.#getFileName#(#)#==#null#)#{#throw#new#BuildException#(#"Unable to get location of import task"#)#;#}#Union#resourcesToImport#=#new#Union#(#getProject#(#)#,#resources#)#;#Resource#fromFileAttribute#=#getFileAttributeResource#(#)#;#if#(#fromFileAttribute#!=#null#)#{#resources#.#add#(#fromFileAttribute#)#;#}#for#(#Iterator#i#=#resourcesToImport#.#iterator#(#)#;#i#.#hasNext#(#)#;#)#{#importResource#(#helper#,#(#Resource#)#i#.#next#(#)#)#;#}#}##void#importResource#(#ProjectHelper#helper#,#Resource#importedResource#)#{#Vector#importStack#=#helper#.#getImportStack#(#)#;#getProject#(#)#.#log#(#"Importing file "#+#importedResource#+#" from "#+#getLocation#(#)#.#getFileName#(#)#,#Project#.#MSG_VERBOSE#)#;#if#(#!#importedResource#.#isExists#(#)#)#{#String#message#=#"Cannot find "#+#importedResource#+#" imported from "#+#getLocation#(#)#.#getFileName#(#)#;#if#(#optional#)#{#getProject#(#)#.#log#(#message#,#Project#.#MSG_VERBOSE#)#;#return#;#}#else#{#throw#new#BuildException#(#message#)#;#}#}#File#importedFile#=#null#;#FileProvider#fp#=#(#FileProvider#)#importedResource#.#as#(#FileProvider#.#class#)#;#if#(#fp#!=#null#)#{#importedFile#=#fp#.#getFile#(#)#;#}#if#(#!#isInIncludeMode#(#)#&&#(#importStack#.#contains#(#importedResource#)#||#(#importedFile#!=#null#&&#importStack#.#contains#(#importedFile#)#)#)#)#{#getProject#(#)#.#log#(#"Skipped already imported file:\n   "#+#importedResource#+#"\n"#,#Project#.#MSG_VERBOSE#)#;#return#;#}#// nested invokations are possible like an imported file#// importing another one#String#oldPrefix#=#ProjectHelper#.#getCurrentTargetPrefix#(#)#;#boolean#oldIncludeMode#=#ProjectHelper#.#isInIncludeMode#(#)#;#String#oldSep#=#ProjectHelper#.#getCurrentPrefixSeparator#(#)#;#try#{#String#prefix#=#targetPrefix#;#if#(#isInIncludeMode#(#)#&&#oldPrefix#!=#null#&&#targetPrefix#!=#null#)#{#prefix#=#oldPrefix#+#oldSep#+#targetPrefix#;#}#setProjectHelperProps#(#prefix#,#prefixSeparator#,#isInIncludeMode#(#)#)#;#helper#.#parse#(#getProject#(#)#,#importedResource#)#;#}#catch#(#BuildException#ex#)#{#throw#ProjectHelper#.#addLocationToBuildException#(#ex#,#getLocation#(#)#)#;#}#finally#{#setProjectHelperProps#(#oldPrefix#,#oldSep#,#oldIncludeMode#)#;#}#}##Resource#getFileAttributeResource#(#)#{#// Paths are relative to the build file they're imported from,#// *not* the current directory (same as entity includes).#if#(#file#!=#null#)#{#File#buildFile#=#new#File#(#getLocation#(#)#.#getFileName#(#)#)#.#getAbsoluteFile#(#)#;#if#(#buildFile#.#exists#(#)#)#{#File#buildFileParent#=#new#File#(#buildFile#.#getParent#(#)#)#;#File#importedFile#=#FILE_UTILS#.#resolveFile#(#buildFileParent#,#file#)#;#return#new#FileResource#(#importedFile#)#;#}#// maybe this import tasks is inside an imported URL?#try#{#URL#buildFileURL#=#new#URL#(#getLocation#(#)#.#getFileName#(#)#)#;#URL#importedFile#=#new#URL#(#buildFileURL#,#file#)#;#return#new#URLResource#(#importedFile#)#;#}#catch#(#MalformedURLException#ex#)#{#log#(#ex#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#}#throw#new#BuildException#(#"failed to resolve "#+#file#+#" relative to "#+#getLocation#(#)#.#getFileName#(#)#)#;#}#return#null#;#}##boolean#isInIncludeMode#(#)#{#return#"include"#.#equals#(#getTaskType#(#)#)#;#}##void#setProjectHelperProps#(#String#prefix#,#String#prefixSep#,#boolean#inIncludeMode#)#{#ProjectHelper#.#setCurrentTargetPrefix#(#prefix#)#;#ProjectHelper#.#setCurrentPrefixSeparator#(#prefixSep#)#;#ProjectHelper#.#setInIncludeMode#(#inIncludeMode#)#;#}##