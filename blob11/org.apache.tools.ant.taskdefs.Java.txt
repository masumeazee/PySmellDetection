void#execute#(#)#throws#BuildException#{#File#savedDir#=#dir#;#Permissions#savedPermissions#=#perm#;#int#err#=#-#1#;#try#{#checkConfiguration#(#)#;#err#=#executeJava#(#)#;#if#(#err#!=#0#)#{#if#(#failOnError#)#{#throw#new#ExitStatusException#(#"Java returned: "#+#err#,#err#,#getLocation#(#)#)#;#}#else#{#log#(#"Java Result: "#+#err#,#Project#.#MSG_ERR#)#;#}#}#maybeSetResultPropertyValue#(#err#)#;#}#finally#{#dir#=#savedDir#;#perm#=#savedPermissions#;#}#}##int#executeJava#(#)#throws#BuildException#{#return#executeJava#(#getCommandLine#(#)#)#;#}##void#checkConfiguration#(#)#throws#BuildException#{#String#classname#=#getCommandLine#(#)#.#getClassname#(#)#;#if#(#classname#==#null#&&#getCommandLine#(#)#.#getJar#(#)#==#null#)#{#throw#new#BuildException#(#"Classname must not be null."#)#;#}#if#(#!#fork#&&#getCommandLine#(#)#.#getJar#(#)#!=#null#)#{#throw#new#BuildException#(#"Cannot execute a jar in non-forked mode."#+#" Please set fork='true'. "#)#;#}#if#(#spawn#&&#!#fork#)#{#throw#new#BuildException#(#"Cannot spawn a java process in non-forked mode."#+#" Please set fork='true'. "#)#;#}#if#(#getCommandLine#(#)#.#getClasspath#(#)#!=#null#&&#getCommandLine#(#)#.#getJar#(#)#!=#null#)#{#log#(#"When using 'jar' attribute classpath-settings are ignored. "#+#"See the manual for more information."#,#Project#.#MSG_VERBOSE#)#;#}#if#(#spawn#&&#incompatibleWithSpawn#)#{#getProject#(#)#.#log#(#"spawn does not allow attributes related to input, "#+#"output, error, result"#,#Project#.#MSG_ERR#)#;#getProject#(#)#.#log#(#"spawn also does not allow timeout"#,#Project#.#MSG_ERR#)#;#getProject#(#)#.#log#(#"finally, spawn is not compatible "#+#"with a nested I/O <redirector>"#,#Project#.#MSG_ERR#)#;#throw#new#BuildException#(#"You have used an attribute "#+#"or nested element which is not compatible with spawn"#)#;#}#if#(#getCommandLine#(#)#.#getAssertions#(#)#!=#null#&&#!#fork#)#{#log#(#"Assertion statements are currently ignored in non-forked mode"#)#;#}#if#(#fork#)#{#if#(#perm#!=#null#)#{#log#(#"Permissions can not be set this way in forked mode."#,#Project#.#MSG_WARN#)#;#}#log#(#getCommandLine#(#)#.#describeCommand#(#)#,#Project#.#MSG_VERBOSE#)#;#}#else#{#if#(#getCommandLine#(#)#.#getVmCommand#(#)#.#size#(#)#>#1#)#{#log#(#"JVM args ignored when same JVM is used."#,#Project#.#MSG_WARN#)#;#}#if#(#dir#!=#null#)#{#log#(#"Working directory ignored when same JVM is used."#,#Project#.#MSG_WARN#)#;#}#if#(#newEnvironment#||#null#!=#env#.#getVariables#(#)#)#{#log#(#"Changes to environment variables are ignored when same "#+#"JVM is used."#,#Project#.#MSG_WARN#)#;#}#if#(#getCommandLine#(#)#.#getBootclasspath#(#)#!=#null#)#{#log#(#"bootclasspath ignored when same JVM is used."#,#Project#.#MSG_WARN#)#;#}#if#(#perm#==#null#)#{#perm#=#new#Permissions#(#true#)#;#log#(#"running "#+#this#.#getCommandLine#(#)#.#getClassname#(#)#+#" with default permissions (exit forbidden)"#,#Project#.#MSG_VERBOSE#)#;#}#log#(#"Running in same VM "#+#getCommandLine#(#)#.#describeJavaCommand#(#)#,#Project#.#MSG_VERBOSE#)#;#}#setupRedirector#(#)#;#}##int#executeJava#(#CommandlineJava#commandLine#)#{#try#{#if#(#fork#)#{#if#(#!#spawn#)#{#return#fork#(#commandLine#.#getCommandline#(#)#)#;#}#else#{#spawn#(#commandLine#.#getCommandline#(#)#)#;#return#0#;#}#}#else#{#try#{#run#(#commandLine#)#;#return#0#;#}#catch#(#ExitException#ex#)#{#return#ex#.#getStatus#(#)#;#}#}#}#catch#(#BuildException#e#)#{#if#(#e#.#getLocation#(#)#==#null#&&#getLocation#(#)#!=#null#)#{#e#.#setLocation#(#getLocation#(#)#)#;#}#if#(#failOnError#)#{#throw#e#;#}#else#{#if#(#TIMEOUT_MESSAGE#.#equals#(#e#.#getMessage#(#)#)#)#{#log#(#TIMEOUT_MESSAGE#)#;#}#else#{#log#(#e#)#;#}#return#-#1#;#}#}#catch#(#ThreadDeath#t#)#{#throw#t#;#// cf. NB #47191#}#catch#(#Throwable#t#)#{#if#(#failOnError#)#{#throw#new#BuildException#(#t#,#getLocation#(#)#)#;#}#else#{#log#(#t#)#;#return#-#1#;#}#}#}##void#setSpawn#(#boolean#spawn#)#{#this#.#spawn#=#spawn#;#}##void#setClasspath#(#Path#s#)#{#createClasspath#(#)#.#append#(#s#)#;#}##Path#createClasspath#(#)#{#return#getCommandLine#(#)#.#createClasspath#(#getProject#(#)#)#.#createPath#(#)#;#}##Path#createBootclasspath#(#)#{#return#getCommandLine#(#)#.#createBootclasspath#(#getProject#(#)#)#.#createPath#(#)#;#}##Permissions#createPermissions#(#)#{#perm#=#(#perm#==#null#)#?#new#Permissions#(#)#:#perm#;#return#perm#;#}##void#setClasspathRef#(#Reference#r#)#{#createClasspath#(#)#.#setRefid#(#r#)#;#}##void#setJar#(#File#jarfile#)#throws#BuildException#{#if#(#getCommandLine#(#)#.#getClassname#(#)#!=#null#)#{#throw#new#BuildException#(#"Cannot use 'jar' and 'classname' "#+#"attributes in same command."#)#;#}#getCommandLine#(#)#.#setJar#(#jarfile#.#getAbsolutePath#(#)#)#;#}##void#setClassname#(#String#s#)#throws#BuildException#{#if#(#getCommandLine#(#)#.#getJar#(#)#!=#null#)#{#throw#new#BuildException#(#"Cannot use 'jar' and 'classname' "#+#"attributes in same command"#)#;#}#getCommandLine#(#)#.#setClassname#(#s#)#;#}##void#setArgs#(#String#s#)#{#log#(#"The args attribute is deprecated. "#+#"Please use nested arg elements."#,#Project#.#MSG_WARN#)#;#getCommandLine#(#)#.#createArgument#(#)#.#setLine#(#s#)#;#}##void#setCloneVm#(#boolean#cloneVm#)#{#getCommandLine#(#)#.#setCloneVm#(#cloneVm#)#;#}##Commandline#.#Argument#createArg#(#)#{#return#getCommandLine#(#)#.#createArgument#(#)#;#}##void#setResultProperty#(#String#resultProperty#)#{#this#.#resultProperty#=#resultProperty#;#incompatibleWithSpawn#=#true#;#}##void#maybeSetResultPropertyValue#(#int#result#)#{#String#res#=#Integer#.#toString#(#result#)#;#if#(#resultProperty#!=#null#)#{#getProject#(#)#.#setNewProperty#(#resultProperty#,#res#)#;#}#}##void#setFork#(#boolean#s#)#{#this#.#fork#=#s#;#}##void#setJvmargs#(#String#s#)#{#log#(#"The jvmargs attribute is deprecated. "#+#"Please use nested jvmarg elements."#,#Project#.#MSG_WARN#)#;#getCommandLine#(#)#.#createVmArgument#(#)#.#setLine#(#s#)#;#}##Commandline#.#Argument#createJvmarg#(#)#{#return#getCommandLine#(#)#.#createVmArgument#(#)#;#}##void#setJvm#(#String#s#)#{#getCommandLine#(#)#.#setVm#(#s#)#;#}##void#addSysproperty#(#Environment#.#Variable#sysp#)#{#getCommandLine#(#)#.#addSysproperty#(#sysp#)#;#}##void#addSyspropertyset#(#PropertySet#sysp#)#{#getCommandLine#(#)#.#addSyspropertyset#(#sysp#)#;#}##void#setFailonerror#(#boolean#fail#)#{#failOnError#=#fail#;#incompatibleWithSpawn#|=#fail#;#}##void#setDir#(#File#d#)#{#this#.#dir#=#d#;#}##void#setOutput#(#File#out#)#{#this#.#output#=#out#;#incompatibleWithSpawn#=#true#;#}##void#setInput#(#File#input#)#{#if#(#inputString#!=#null#)#{#throw#new#BuildException#(#"The \"input\" and \"inputstring\" "#+#"attributes cannot both be specified"#)#;#}#this#.#input#=#input#;#incompatibleWithSpawn#=#true#;#}##void#setInputString#(#String#inputString#)#{#if#(#input#!=#null#)#{#throw#new#BuildException#(#"The \"input\" and \"inputstring\" "#+#"attributes cannot both be specified"#)#;#}#this#.#inputString#=#inputString#;#incompatibleWithSpawn#=#true#;#}##void#setLogError#(#boolean#logError#)#{#redirector#.#setLogError#(#logError#)#;#incompatibleWithSpawn#|=#logError#;#}##void#setError#(#File#error#)#{#this#.#error#=#error#;#incompatibleWithSpawn#=#true#;#}##void#setOutputproperty#(#String#outputProp#)#{#redirector#.#setOutputProperty#(#outputProp#)#;#incompatibleWithSpawn#=#true#;#}##void#setErrorProperty#(#String#errorProperty#)#{#redirector#.#setErrorProperty#(#errorProperty#)#;#incompatibleWithSpawn#=#true#;#}##void#setMaxmemory#(#String#max#)#{#getCommandLine#(#)#.#setMaxmemory#(#max#)#;#}##void#setJVMVersion#(#String#value#)#{#getCommandLine#(#)#.#setVmversion#(#value#)#;#}##void#addEnv#(#Environment#.#Variable#var#)#{#env#.#addVariable#(#var#)#;#}##void#setNewenvironment#(#boolean#newenv#)#{#newEnvironment#=#newenv#;#}##void#setAppend#(#boolean#append#)#{#redirector#.#setAppend#(#append#)#;#incompatibleWithSpawn#=#true#;#}##void#setTimeout#(#Long#value#)#{#timeout#=#value#;#incompatibleWithSpawn#|=#timeout#!=#null#;#}##void#addAssertions#(#Assertions#asserts#)#{#if#(#getCommandLine#(#)#.#getAssertions#(#)#!=#null#)#{#throw#new#BuildException#(#"Only one assertion declaration is allowed"#)#;#}#getCommandLine#(#)#.#setAssertions#(#asserts#)#;#}##void#addConfiguredRedirector#(#RedirectorElement#redirectorElement#)#{#if#(#this#.#redirectorElement#!=#null#)#{#throw#new#BuildException#(#"cannot have > 1 nested redirectors"#)#;#}#this#.#redirectorElement#=#redirectorElement#;#incompatibleWithSpawn#=#true#;#}##void#handleOutput#(#String#output#)#{#if#(#redirector#.#getOutputStream#(#)#!=#null#)#{#redirector#.#handleOutput#(#output#)#;#}#else#{#super#.#handleOutput#(#output#)#;#}#}##int#handleInput#(#byte#[#]#buffer#,#int#offset#,#int#length#)#throws#IOException#{#// Should work whether or not redirector.inputStream == null:#return#redirector#.#handleInput#(#buffer#,#offset#,#length#)#;#}##void#handleFlush#(#String#output#)#{#if#(#redirector#.#getOutputStream#(#)#!=#null#)#{#redirector#.#handleFlush#(#output#)#;#}#else#{#super#.#handleFlush#(#output#)#;#}#}##void#handleErrorOutput#(#String#output#)#{#if#(#redirector#.#getErrorStream#(#)#!=#null#)#{#redirector#.#handleErrorOutput#(#output#)#;#}#else#{#super#.#handleErrorOutput#(#output#)#;#}#}##void#handleErrorFlush#(#String#output#)#{#if#(#redirector#.#getErrorStream#(#)#!=#null#)#{#redirector#.#handleErrorFlush#(#output#)#;#}#else#{#super#.#handleErrorOutput#(#output#)#;#}#}##void#setupRedirector#(#)#{#redirector#.#setInput#(#input#)#;#redirector#.#setInputString#(#inputString#)#;#redirector#.#setOutput#(#output#)#;#redirector#.#setError#(#error#)#;#if#(#redirectorElement#!=#null#)#{#redirectorElement#.#configure#(#redirector#)#;#}#if#(#!#spawn#&&#input#==#null#&&#inputString#==#null#)#{#// #24918: send standard input to the process by default.#redirector#.#setInputStream#(#new#KeepAliveInputStream#(#getProject#(#)#.#getDefaultInputStream#(#)#)#)#;#}#}##void#run#(#CommandlineJava#command#)#throws#BuildException#{#try#{#ExecuteJava#exe#=#new#ExecuteJava#(#)#;#exe#.#setJavaCommand#(#command#.#getJavaCommand#(#)#)#;#exe#.#setClasspath#(#command#.#getClasspath#(#)#)#;#exe#.#setSystemProperties#(#command#.#getSystemProperties#(#)#)#;#exe#.#setPermissions#(#perm#)#;#exe#.#setTimeout#(#timeout#)#;#redirector#.#createStreams#(#)#;#exe#.#execute#(#getProject#(#)#)#;#redirector#.#complete#(#)#;#if#(#exe#.#killedProcess#(#)#)#{#throw#new#BuildException#(#TIMEOUT_MESSAGE#)#;#}#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#e#)#;#}#}##int#fork#(#String#[#]#command#)#throws#BuildException#{#Execute#exe#=#new#Execute#(#redirector#.#createHandler#(#)#,#createWatchdog#(#)#)#;#setupExecutable#(#exe#,#command#)#;#try#{#int#rc#=#exe#.#execute#(#)#;#redirector#.#complete#(#)#;#if#(#exe#.#killedProcess#(#)#)#{#throw#new#BuildException#(#TIMEOUT_MESSAGE#)#;#}#return#rc#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#e#,#getLocation#(#)#)#;#}#}##void#spawn#(#String#[#]#command#)#throws#BuildException#{#Execute#exe#=#new#Execute#(#)#;#setupExecutable#(#exe#,#command#)#;#try#{#exe#.#spawn#(#)#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#e#,#getLocation#(#)#)#;#}#}##void#setupExecutable#(#Execute#exe#,#String#[#]#command#)#{#exe#.#setAntRun#(#getProject#(#)#)#;#setupWorkingDir#(#exe#)#;#setupEnvironment#(#exe#)#;#setupCommandLine#(#exe#,#command#)#;#}##void#setupEnvironment#(#Execute#exe#)#{#String#[#]#environment#=#env#.#getVariables#(#)#;#if#(#environment#!=#null#)#{#for#(#int#i#=#0#;#i#<#environment#.#length#;#i#++#)#{#log#(#"Setting environment variable: "#+#environment#[#i#]#,#Project#.#MSG_VERBOSE#)#;#}#}#exe#.#setNewenvironment#(#newEnvironment#)#;#exe#.#setEnvironment#(#environment#)#;#}##void#setupWorkingDir#(#Execute#exe#)#{#if#(#dir#==#null#)#{#dir#=#getProject#(#)#.#getBaseDir#(#)#;#}#else#if#(#!#dir#.#exists#(#)#||#!#dir#.#isDirectory#(#)#)#{#throw#new#BuildException#(#dir#.#getAbsolutePath#(#)#+#" is not a valid directory"#,#getLocation#(#)#)#;#}#exe#.#setWorkingDirectory#(#dir#)#;#}##void#setupCommandLine#(#Execute#exe#,#String#[#]#command#)#{#//On VMS platform, we need to create a special java options file#//containing the arguments and classpath for the java command.#//The special file is supported by the "-V" switch on the VMS JVM.#if#(#Os#.#isFamily#(#"openvms"#)#)#{#setupCommandLineForVMS#(#exe#,#command#)#;#}#else#{#exe#.#setCommandline#(#command#)#;#}#}##void#setupCommandLineForVMS#(#Execute#exe#,#String#[#]#command#)#{#ExecuteJava#.#setupCommandLineForVMS#(#exe#,#command#)#;#}##void#run#(#String#classname#,#Vector#args#)#throws#BuildException#{#CommandlineJava#cmdj#=#new#CommandlineJava#(#)#;#cmdj#.#setClassname#(#classname#)#;#for#(#int#i#=#0#;#i#<#args#.#size#(#)#;#i#++#)#{#cmdj#.#createArgument#(#)#.#setValue#(#(#String#)#args#.#elementAt#(#i#)#)#;#}#run#(#cmdj#)#;#}##void#clearArgs#(#)#{#getCommandLine#(#)#.#clearJavaArgs#(#)#;#}##ExecuteWatchdog#createWatchdog#(#)#throws#BuildException#{#if#(#timeout#==#null#)#{#return#null#;#}#return#new#ExecuteWatchdog#(#timeout#.#longValue#(#)#)#;#}##void#log#(#Throwable#t#)#{#StringWriter#sw#=#new#StringWriter#(#)#;#PrintWriter#w#=#new#PrintWriter#(#sw#)#;#t#.#printStackTrace#(#w#)#;#w#.#close#(#)#;#log#(#sw#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}##CommandlineJava#getCommandLine#(#)#{#return#cmdl#;#}##CommandlineJava#.#SysProperties#getSysProperties#(#)#{#return#getCommandLine#(#)#.#getSystemProperties#(#)#;#}##