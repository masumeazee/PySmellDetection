void#setPackage#(#String#p#)#{#mypackage#=#p#;#}##void#setStartTag#(#String#s#)#{#mystartTag#=#s#;#}##void#setStartDate#(#String#s#)#{#mystartDate#=#s#;#}##void#setEndTag#(#String#s#)#{#myendTag#=#s#;#}##void#setEndDate#(#String#s#)#{#myendDate#=#s#;#}##void#setDestFile#(#File#f#)#{#mydestfile#=#f#;#}##void#setIgnoreRemoved#(#boolean#b#)#{#ignoreRemoved#=#b#;#}##void#execute#(#)#throws#BuildException#{#// validate the input parameters#validate#(#)#;#// build the rdiff command#addCommandArgument#(#"rdiff"#)#;#addCommandArgument#(#"-s"#)#;#if#(#mystartTag#!=#null#)#{#addCommandArgument#(#"-r"#)#;#addCommandArgument#(#mystartTag#)#;#}#else#{#addCommandArgument#(#"-D"#)#;#addCommandArgument#(#mystartDate#)#;#}#if#(#myendTag#!=#null#)#{#addCommandArgument#(#"-r"#)#;#addCommandArgument#(#myendTag#)#;#}#else#{#addCommandArgument#(#"-D"#)#;#addCommandArgument#(#myendDate#)#;#}#// force command not to be null#setCommand#(#""#)#;#File#tmpFile#=#null#;#try#{#handlePackageNames#(#)#;#tmpFile#=#FILE_UTILS#.#createTempFile#(#"cvstagdiff"#,#".log"#,#null#,#true#,#true#)#;#setOutput#(#tmpFile#)#;#// run the cvs command#super#.#execute#(#)#;#// parse the rdiff#CvsTagEntry#[#]#entries#=#parseRDiff#(#tmpFile#)#;#// write the tag diff#writeTagDiff#(#entries#)#;#}#finally#{#packageNamePrefixes#=#null#;#packageNamePrefixLengths#=#null#;#packageNames#.#clear#(#)#;#if#(#tmpFile#!=#null#)#{#tmpFile#.#delete#(#)#;#}#}#}##CvsTagEntry#[#]#parseRDiff#(#File#tmpFile#)#throws#BuildException#{#// parse the output of the command#BufferedReader#reader#=#null#;#try#{#reader#=#new#BufferedReader#(#new#FileReader#(#tmpFile#)#)#;#// entries are of the form:#//CVS 1.11#// File module/filename is new; current revision 1.1#//CVS 1.11.9#// File module/filename is new; cvstag_2003_11_03_2  revision 1.1#// or#// File module/filename changed from revision 1.4 to 1.6#// or#// File module/filename is removed; not included in#// release tag SKINLF_12#//CVS 1.11.9#// File testantoine/antoine.bat is removed; TESTANTOINE_1 revision 1.1.1.1#//#// get rid of 'File module/"#Vector#entries#=#new#Vector#(#)#;#String#line#=#reader#.#readLine#(#)#;#while#(#null#!=#line#)#{#line#=#removePackageName#(#line#,#packageNamePrefixes#,#packageNamePrefixLengths#)#;#if#(#line#!=#null#)#{#// use || in a perl like fashion#boolean#processed#=#doFileIsNew#(#entries#,#line#)#||#doFileHasChanged#(#entries#,#line#)#||#doFileWasRemoved#(#entries#,#line#)#;#}#line#=#reader#.#readLine#(#)#;#}#CvsTagEntry#[#]#array#=#new#CvsTagEntry#[#entries#.#size#(#)#]#;#entries#.#copyInto#(#array#)#;#return#array#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"Error in parsing"#,#e#)#;#}#finally#{#if#(#reader#!=#null#)#{#try#{#reader#.#close#(#)#;#}#catch#(#IOException#e#)#{#log#(#e#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}#}#}#}##boolean#doFileIsNew#(#Vector#entries#,#String#line#)#{#int#index#=#line#.#indexOf#(#FILE_IS_NEW#)#;#if#(#index#==#-#1#)#{#return#false#;#}#// it is a new file#// set the revision but not the prevrevision#String#filename#=#line#.#substring#(#0#,#index#)#;#String#rev#=#null#;#int#indexrev#=#line#.#indexOf#(#REVISION#,#index#)#;#if#(#indexrev#!=#-#1#)#{#rev#=#line#.#substring#(#indexrev#+#REVISION#.#length#(#)#)#;#}#CvsTagEntry#entry#=#new#CvsTagEntry#(#filename#,#rev#)#;#entries#.#addElement#(#entry#)#;#log#(#entry#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#return#true#;#}##boolean#doFileHasChanged#(#Vector#entries#,#String#line#)#{#int#index#=#line#.#indexOf#(#FILE_HAS_CHANGED#)#;#if#(#index#==#-#1#)#{#return#false#;#}#// it is a modified file#// set the revision and the prevrevision#String#filename#=#line#.#substring#(#0#,#index#)#;#int#revSeparator#=#line#.#indexOf#(#" to "#,#index#)#;#String#prevRevision#=#line#.#substring#(#index#+#FILE_HAS_CHANGED#.#length#(#)#,#revSeparator#)#;#String#revision#=#line#.#substring#(#revSeparator#+#TO_STRING#.#length#(#)#)#;#CvsTagEntry#entry#=#new#CvsTagEntry#(#filename#,#revision#,#prevRevision#)#;#entries#.#addElement#(#entry#)#;#log#(#entry#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#return#true#;#}##boolean#doFileWasRemoved#(#Vector#entries#,#String#line#)#{#if#(#ignoreRemoved#)#{#return#false#;#}#int#index#=#line#.#indexOf#(#FILE_WAS_REMOVED#)#;#if#(#index#==#-#1#)#{#return#false#;#}#// it is a removed file#String#filename#=#line#.#substring#(#0#,#index#)#;#String#rev#=#null#;#int#indexrev#=#line#.#indexOf#(#REVISION#,#index#)#;#if#(#indexrev#!=#-#1#)#{#rev#=#line#.#substring#(#indexrev#+#REVISION#.#length#(#)#)#;#}#CvsTagEntry#entry#=#new#CvsTagEntry#(#filename#,#null#,#rev#)#;#entries#.#addElement#(#entry#)#;#log#(#entry#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#return#true#;#}##void#writeTagDiff#(#CvsTagEntry#[#]#entries#)#throws#BuildException#{#FileOutputStream#output#=#null#;#try#{#output#=#new#FileOutputStream#(#mydestfile#)#;#PrintWriter#writer#=#new#PrintWriter#(#new#OutputStreamWriter#(#output#,#"UTF-8"#)#)#;#writer#.#println#(#"<?xml version=\"1.0\" encoding=\"UTF-8\"?>"#)#;#Document#doc#=#DOMUtils#.#newDocument#(#)#;#Element#root#=#doc#.#createElement#(#"tagdiff"#)#;#if#(#mystartTag#!=#null#)#{#root#.#setAttribute#(#"startTag"#,#mystartTag#)#;#}#else#{#root#.#setAttribute#(#"startDate"#,#mystartDate#)#;#}#if#(#myendTag#!=#null#)#{#root#.#setAttribute#(#"endTag"#,#myendTag#)#;#}#else#{#root#.#setAttribute#(#"endDate"#,#myendDate#)#;#}#root#.#setAttribute#(#"cvsroot"#,#getCvsRoot#(#)#)#;#root#.#setAttribute#(#"package"#,#CollectionUtils#.#flattenToString#(#packageNames#)#)#;#DOM_WRITER#.#openElement#(#root#,#writer#,#0#,#"\t"#)#;#writer#.#println#(#)#;#for#(#int#i#=#0#,#c#=#entries#.#length#;#i#<#c#;#i#++#)#{#writeTagEntry#(#doc#,#writer#,#entries#[#i#]#)#;#}#DOM_WRITER#.#closeElement#(#root#,#writer#,#0#,#"\t"#,#true#)#;#writer#.#flush#(#)#;#if#(#writer#.#checkError#(#)#)#{#throw#new#IOException#(#"Encountered an error writing tagdiff"#)#;#}#writer#.#close#(#)#;#}#catch#(#UnsupportedEncodingException#uee#)#{#log#(#uee#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#.#toString#(#)#,#ioe#)#;#}#finally#{#if#(#null#!=#output#)#{#try#{#output#.#close#(#)#;#}#catch#(#IOException#ioe#)#{#log#(#ioe#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}#}#}#}##void#writeTagEntry#(#Document#doc#,#PrintWriter#writer#,#CvsTagEntry#entry#)#throws#IOException#{#Element#ent#=#doc#.#createElement#(#"entry"#)#;#Element#f#=#DOMUtils#.#createChildElement#(#ent#,#"file"#)#;#DOMUtils#.#appendCDATAElement#(#f#,#"name"#,#entry#.#getFile#(#)#)#;#if#(#entry#.#getRevision#(#)#!=#null#)#{#DOMUtils#.#appendTextElement#(#f#,#"revision"#,#entry#.#getRevision#(#)#)#;#}#if#(#entry#.#getPreviousRevision#(#)#!=#null#)#{#DOMUtils#.#appendTextElement#(#f#,#"prevrevision"#,#entry#.#getPreviousRevision#(#)#)#;#}#DOM_WRITER#.#write#(#ent#,#writer#,#1#,#"\t"#)#;#}##void#validate#(#)#throws#BuildException#{#if#(#null#==#mypackage#&&#getModules#(#)#.#size#(#)#==#0#)#{#throw#new#BuildException#(#"Package/module must be set."#)#;#}#if#(#null#==#mydestfile#)#{#throw#new#BuildException#(#"Destfile must be set."#)#;#}#if#(#null#==#mystartTag#&&#null#==#mystartDate#)#{#throw#new#BuildException#(#"Start tag or start date must be set."#)#;#}#if#(#null#!=#mystartTag#&&#null#!=#mystartDate#)#{#throw#new#BuildException#(#"Only one of start tag and start date "#+#"must be set."#)#;#}#if#(#null#==#myendTag#&&#null#==#myendDate#)#{#throw#new#BuildException#(#"End tag or end date must be set."#)#;#}#if#(#null#!=#myendTag#&&#null#!=#myendDate#)#{#throw#new#BuildException#(#"Only one of end tag and end date must "#+#"be set."#)#;#}#}##void#handlePackageNames#(#)#{#if#(#mypackage#!=#null#)#{#// support multiple packages#StringTokenizer#myTokenizer#=#new#StringTokenizer#(#mypackage#)#;#while#(#myTokenizer#.#hasMoreTokens#(#)#)#{#String#pack#=#myTokenizer#.#nextToken#(#)#;#packageNames#.#add#(#pack#)#;#addCommandArgument#(#pack#)#;#}#}#for#(#Iterator#iter#=#getModules#(#)#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#AbstractCvsTask#.#Module#m#=#(#AbstractCvsTask#.#Module#)#iter#.#next#(#)#;#packageNames#.#add#(#m#.#getName#(#)#)#;#// will be added to command line in super.execute()#}#packageNamePrefixes#=#new#String#[#packageNames#.#size#(#)#]#;#packageNamePrefixLengths#=#new#int#[#packageNames#.#size#(#)#]#;#for#(#int#i#=#0#;#i#<#packageNamePrefixes#.#length#;#i#++#)#{#packageNamePrefixes#[#i#]#=#FILE_STRING#+#packageNames#.#get#(#i#)#+#"/"#;#packageNamePrefixLengths#[#i#]#=#packageNamePrefixes#[#i#]#.#length#(#)#;#}#}##String#removePackageName#(#String#line#,#String#[#]#packagePrefixes#,#int#[#]#prefixLengths#)#{#if#(#line#.#length#(#)#<#FILE_STRING_LENGTH#)#{#return#null#;#}#boolean#matched#=#false#;#for#(#int#i#=#0#;#i#<#packagePrefixes#.#length#;#i#++#)#{#if#(#line#.#startsWith#(#packagePrefixes#[#i#]#)#)#{#matched#=#true#;#line#=#line#.#substring#(#prefixLengths#[#i#]#)#;#break#;#}#}#if#(#!#matched#)#{#line#=#line#.#substring#(#FILE_STRING_LENGTH#)#;#}#return#line#;#}##