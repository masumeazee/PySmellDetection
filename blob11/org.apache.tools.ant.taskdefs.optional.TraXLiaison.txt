void#setStylesheet#(#File#stylesheet#)#throws#Exception#{#FileResource#fr#=#new#FileResource#(#)#;#fr#.#setProject#(#project#)#;#fr#.#setFile#(#stylesheet#)#;#setStylesheet#(#fr#)#;#}##void#setStylesheet#(#Resource#stylesheet#)#throws#Exception#{#if#(#this#.#stylesheet#!=#null#)#{#// resetting the stylesheet - reset transformer#transformer#=#null#;#// do we need to reset templates as well#if#(#!#this#.#stylesheet#.#equals#(#stylesheet#)#||#(#stylesheet#.#getLastModified#(#)#!=#templatesModTime#)#)#{#templates#=#null#;#}#}#this#.#stylesheet#=#stylesheet#;#}##void#transform#(#File#infile#,#File#outfile#)#throws#Exception#{#if#(#transformer#==#null#)#{#createTransformer#(#)#;#}#InputStream#fis#=#null#;#OutputStream#fos#=#null#;#try#{#fis#=#new#BufferedInputStream#(#new#FileInputStream#(#infile#)#)#;#fos#=#new#BufferedOutputStream#(#new#FileOutputStream#(#outfile#)#)#;#StreamResult#res#=#new#StreamResult#(#fos#)#;#// not sure what could be the need of this...#res#.#setSystemId#(#JAXPUtils#.#getSystemId#(#outfile#)#)#;#Source#src#=#getSource#(#fis#,#infile#)#;#// set parameters on each transformation, maybe something has changed#//(e.g. value of file name parameter)#setTransformationParameters#(#)#;#transformer#.#transform#(#src#,#res#)#;#}#finally#{#// make sure to close all handles, otherwise the garbage#// collector will close them...whenever possible and#// Windows may complain about not being able to delete files.#FileUtils#.#close#(#fis#)#;#FileUtils#.#close#(#fos#)#;#}#}##Source#getSource#(#InputStream#is#,#File#infile#)#throws#ParserConfigurationException#,#SAXException#{#// todo: is this comment still relevant ??#// FIXME: need to use a SAXSource as the source for the transform#// so we can plug in our own entity resolver#Source#src#=#null#;#if#(#entityResolver#!=#null#)#{#if#(#getFactory#(#)#.#getFeature#(#SAXSource#.#FEATURE#)#)#{#SAXParserFactory#spFactory#=#SAXParserFactory#.#newInstance#(#)#;#spFactory#.#setNamespaceAware#(#true#)#;#XMLReader#reader#=#spFactory#.#newSAXParser#(#)#.#getXMLReader#(#)#;#reader#.#setEntityResolver#(#entityResolver#)#;#src#=#new#SAXSource#(#reader#,#new#InputSource#(#is#)#)#;#}#else#{#throw#new#IllegalStateException#(#"xcatalog specified, but "#+#"parser doesn't support SAX"#)#;#}#}#else#{#// WARN: Don't use the StreamSource(File) ctor. It won't work with#// xalan prior to 2.2 because of systemid bugs.#src#=#new#StreamSource#(#is#)#;#}#src#.#setSystemId#(#JAXPUtils#.#getSystemId#(#infile#)#)#;#return#src#;#}##Source#getSource#(#InputStream#is#,#Resource#resource#)#throws#ParserConfigurationException#,#SAXException#{#// todo: is this comment still relevant ??#// FIXME: need to use a SAXSource as the source for the transform#// so we can plug in our own entity resolver#Source#src#=#null#;#if#(#entityResolver#!=#null#)#{#if#(#getFactory#(#)#.#getFeature#(#SAXSource#.#FEATURE#)#)#{#SAXParserFactory#spFactory#=#SAXParserFactory#.#newInstance#(#)#;#spFactory#.#setNamespaceAware#(#true#)#;#XMLReader#reader#=#spFactory#.#newSAXParser#(#)#.#getXMLReader#(#)#;#reader#.#setEntityResolver#(#entityResolver#)#;#src#=#new#SAXSource#(#reader#,#new#InputSource#(#is#)#)#;#}#else#{#throw#new#IllegalStateException#(#"xcatalog specified, but "#+#"parser doesn't support SAX"#)#;#}#}#else#{#// WARN: Don't use the StreamSource(File) ctor. It won't work with#// xalan prior to 2.2 because of systemid bugs.#src#=#new#StreamSource#(#is#)#;#}#// The line below is a hack: the system id must an URI, but it is not#// cleat to get the URI of an resource, so just set the name of the#// resource as a system id#src#.#setSystemId#(#resourceToURI#(#resource#)#)#;#return#src#;#}##String#resourceToURI#(#Resource#resource#)#{#FileProvider#fp#=#(#FileProvider#)#resource#.#as#(#FileProvider#.#class#)#;#if#(#fp#!=#null#)#{#return#FILE_UTILS#.#toURI#(#fp#.#getFile#(#)#.#getAbsolutePath#(#)#)#;#}#URLProvider#up#=#(#URLProvider#)#resource#.#as#(#URLProvider#.#class#)#;#if#(#up#!=#null#)#{#URL#u#=#up#.#getURL#(#)#;#return#String#.#valueOf#(#u#)#;#}#else#{#return#resource#.#getName#(#)#;#}#}##void#readTemplates#(#)#throws#IOException#,#TransformerConfigurationException#,#ParserConfigurationException#,#SAXException#{#// Use a stream so that you can close it yourself quickly#// and avoid keeping the handle until the object is garbaged.#// (always keep control), otherwise you won't be able to delete#// the file quickly on windows.#InputStream#xslStream#=#null#;#try#{#xslStream#=#new#BufferedInputStream#(#stylesheet#.#getInputStream#(#)#)#;#templatesModTime#=#stylesheet#.#getLastModified#(#)#;#Source#src#=#getSource#(#xslStream#,#stylesheet#)#;#templates#=#getFactory#(#)#.#newTemplates#(#src#)#;#}#finally#{#if#(#xslStream#!=#null#)#{#xslStream#.#close#(#)#;#}#}#}##void#createTransformer#(#)#throws#Exception#{#if#(#templates#==#null#)#{#readTemplates#(#)#;#}#transformer#=#templates#.#newTransformer#(#)#;#// configure the transformer...#transformer#.#setErrorListener#(#this#)#;#if#(#uriResolver#!=#null#)#{#transformer#.#setURIResolver#(#uriResolver#)#;#}#for#(#int#i#=#0#;#i#<#outputProperties#.#size#(#)#;#i#++#)#{#final#String#[#]#pair#=#(#String#[#]#)#outputProperties#.#elementAt#(#i#)#;#transformer#.#setOutputProperty#(#pair#[#0#]#,#pair#[#1#]#)#;#}#if#(#traceConfiguration#!=#null#)#{#if#(#"org.apache.xalan.transformer.TransformerImpl"#.#equals#(#transformer#.#getClass#(#)#.#getName#(#)#)#)#{#try#{#Class#traceSupport#=#Class#.#forName#(#"org.apache.tools.ant.taskdefs.optional."#+#"Xalan2TraceSupport"#,#true#,#Thread#.#currentThread#(#)#.#getContextClassLoader#(#)#)#;#XSLTTraceSupport#ts#=#(#XSLTTraceSupport#)#traceSupport#.#newInstance#(#)#;#ts#.#configureTrace#(#transformer#,#traceConfiguration#)#;#}#catch#(#Exception#e#)#{#String#msg#=#"Failed to enable tracing because of "#+#e#;#if#(#project#!=#null#)#{#project#.#log#(#msg#,#Project#.#MSG_WARN#)#;#}#else#{#System#.#err#.#println#(#msg#)#;#}#}#}#else#{#String#msg#=#"Not enabling trace support for transformer"#+#" implementation"#+#transformer#.#getClass#(#)#.#getName#(#)#;#if#(#project#!=#null#)#{#project#.#log#(#msg#,#Project#.#MSG_WARN#)#;#}#else#{#System#.#err#.#println#(#msg#)#;#}#}#}#}##void#setTransformationParameters#(#)#{#for#(#final#Enumeration#enumeration#=#params#.#keys#(#)#;#enumeration#.#hasMoreElements#(#)#;#)#{#final#String#name#=#(#String#)#enumeration#.#nextElement#(#)#;#final#String#value#=#(#String#)#params#.#get#(#name#)#;#transformer#.#setParameter#(#name#,#value#)#;#}#}##TransformerFactory#getFactory#(#)#throws#BuildException#{#if#(#tfactory#!=#null#)#{#return#tfactory#;#}#// not initialized yet, so create the factory#if#(#factoryName#==#null#)#{#tfactory#=#TransformerFactory#.#newInstance#(#)#;#}#else#{#try#{#Class#clazz#=#null#;#try#{#clazz#=#Class#.#forName#(#factoryName#,#true#,#Thread#.#currentThread#(#)#.#getContextClassLoader#(#)#)#;#}#catch#(#ClassNotFoundException#cnfe#)#{#String#msg#=#"Failed to load "#+#factoryName#+#" via the configured classpath, will try"#+#" Ant's classpath instead."#;#if#(#logger#!=#null#)#{#logger#.#log#(#msg#)#;#}#else#if#(#project#!=#null#)#{#project#.#log#(#msg#,#Project#.#MSG_WARN#)#;#}#else#{#System#.#err#.#println#(#msg#)#;#}#}#if#(#clazz#==#null#)#{#clazz#=#Class#.#forName#(#factoryName#)#;#}#tfactory#=#(#TransformerFactory#)#clazz#.#newInstance#(#)#;#}#catch#(#Exception#e#)#{#throw#new#BuildException#(#e#)#;#}#}#tfactory#.#setErrorListener#(#this#)#;#// specific attributes for the transformer#for#(#int#i#=#0#;#i#<#attributes#.#size#(#)#;#i#++#)#{#final#Object#[#]#pair#=#(#Object#[#]#)#attributes#.#elementAt#(#i#)#;#tfactory#.#setAttribute#(#(#String#)#pair#[#0#]#,#pair#[#1#]#)#;#}#if#(#uriResolver#!=#null#)#{#tfactory#.#setURIResolver#(#uriResolver#)#;#}#return#tfactory#;#}##void#setFactory#(#String#name#)#{#factoryName#=#name#;#}##void#setAttribute#(#String#name#,#Object#value#)#{#final#Object#[#]#pair#=#new#Object#[#]#{#name#,#value#}#;#attributes#.#addElement#(#pair#)#;#}##void#setOutputProperty#(#String#name#,#String#value#)#{#final#String#[#]#pair#=#new#String#[#]#{#name#,#value#}#;#outputProperties#.#addElement#(#pair#)#;#}##void#setEntityResolver#(#EntityResolver#aResolver#)#{#entityResolver#=#aResolver#;#}##void#setURIResolver#(#URIResolver#aResolver#)#{#uriResolver#=#aResolver#;#}##void#addParam#(#String#name#,#String#value#)#{#params#.#put#(#name#,#value#)#;#}##void#setLogger#(#XSLTLogger#l#)#{#logger#=#l#;#}##void#error#(#TransformerException#e#)#{#logError#(#e#,#"Error"#)#;#}##void#fatalError#(#TransformerException#e#)#{#logError#(#e#,#"Fatal Error"#)#;#throw#new#BuildException#(#"Fatal error during transformation"#,#e#)#;#}##void#warning#(#TransformerException#e#)#{#if#(#!#suppressWarnings#)#{#logError#(#e#,#"Warning"#)#;#}#}##void#logError#(#TransformerException#e#,#String#type#)#{#if#(#logger#==#null#)#{#return#;#}#StringBuffer#msg#=#new#StringBuffer#(#)#;#SourceLocator#locator#=#e#.#getLocator#(#)#;#if#(#locator#!=#null#)#{#String#systemid#=#locator#.#getSystemId#(#)#;#if#(#systemid#!=#null#)#{#String#url#=#systemid#;#if#(#url#.#startsWith#(#"file:"#)#)#{#url#=#FileUtils#.#getFileUtils#(#)#.#fromURI#(#url#)#;#}#msg#.#append#(#url#)#;#}#else#{#msg#.#append#(#"Unknown file"#)#;#}#int#line#=#locator#.#getLineNumber#(#)#;#if#(#line#!=#-#1#)#{#msg#.#append#(#":"#)#;#msg#.#append#(#line#)#;#int#column#=#locator#.#getColumnNumber#(#)#;#if#(#column#!=#-#1#)#{#msg#.#append#(#":"#)#;#msg#.#append#(#column#)#;#}#}#}#msg#.#append#(#": "#)#;#msg#.#append#(#type#)#;#msg#.#append#(#"! "#)#;#msg#.#append#(#e#.#getMessage#(#)#)#;#if#(#e#.#getCause#(#)#!=#null#)#{#msg#.#append#(#" Cause: "#)#;#msg#.#append#(#e#.#getCause#(#)#)#;#}#logger#.#log#(#msg#.#toString#(#)#)#;#}##String#getSystemId#(#File#file#)#{#return#JAXPUtils#.#getSystemId#(#file#)#;#}##void#configure#(#XSLTProcess#xsltTask#)#{#project#=#xsltTask#.#getProject#(#)#;#XSLTProcess#.#Factory#factory#=#xsltTask#.#getFactory#(#)#;#if#(#factory#!=#null#)#{#setFactory#(#factory#.#getName#(#)#)#;#// configure factory attributes#for#(#Enumeration#attrs#=#factory#.#getAttributes#(#)#;#attrs#.#hasMoreElements#(#)#;#)#{#XSLTProcess#.#Factory#.#Attribute#attr#=#(#XSLTProcess#.#Factory#.#Attribute#)#attrs#.#nextElement#(#)#;#setAttribute#(#attr#.#getName#(#)#,#attr#.#getValue#(#)#)#;#}#}#XMLCatalog#xmlCatalog#=#xsltTask#.#getXMLCatalog#(#)#;#// use XMLCatalog as the entity resolver and URI resolver#if#(#xmlCatalog#!=#null#)#{#setEntityResolver#(#xmlCatalog#)#;#setURIResolver#(#xmlCatalog#)#;#}#// configure output properties#for#(#Enumeration#props#=#xsltTask#.#getOutputProperties#(#)#;#props#.#hasMoreElements#(#)#;#)#{#XSLTProcess#.#OutputProperty#prop#=#(#XSLTProcess#.#OutputProperty#)#props#.#nextElement#(#)#;#setOutputProperty#(#prop#.#getName#(#)#,#prop#.#getValue#(#)#)#;#}#suppressWarnings#=#xsltTask#.#getSuppressWarnings#(#)#;#traceConfiguration#=#xsltTask#.#getTraceConfiguration#(#)#;#}##