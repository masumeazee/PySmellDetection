void#addSysproperty#(#Environment#.#Variable#sysp#)#{#sysprops#.#add#(#sysp#)#;#}##Path#createWLClasspath#(#)#{#if#(#wlClasspath#==#null#)#{#wlClasspath#=#new#Path#(#getTask#(#)#.#getProject#(#)#)#;#}#return#wlClasspath#.#createPath#(#)#;#}##void#setOutputDir#(#File#outputDir#)#{#this#.#outputDir#=#outputDir#;#}##void#setWLClasspath#(#Path#wlClasspath#)#{#this#.#wlClasspath#=#wlClasspath#;#}##void#setCompiler#(#String#compiler#)#{#this#.#compiler#=#compiler#;#}##void#setRebuild#(#boolean#rebuild#)#{#this#.#alwaysRebuild#=#rebuild#;#}##void#setJvmDebugLevel#(#Integer#jvmDebugLevel#)#{#this#.#jvmDebugLevel#=#jvmDebugLevel#;#}##Integer#getJvmDebugLevel#(#)#{#return#jvmDebugLevel#;#}##void#setSuffix#(#String#inString#)#{#this#.#jarSuffix#=#inString#;#}##void#setKeepgeneric#(#boolean#inValue#)#{#this#.#keepGeneric#=#inValue#;#}##void#setKeepgenerated#(#String#inValue#)#{#this#.#keepgenerated#=#Boolean#.#valueOf#(#inValue#)#.#booleanValue#(#)#;#}##void#setArgs#(#String#args#)#{#this#.#additionalArgs#=#args#;#}##void#setJvmargs#(#String#args#)#{#this#.#additionalJvmArgs#=#args#;#}##void#setEjbcClass#(#String#ejbcClass#)#{#this#.#ejbcClass#=#ejbcClass#;#}##String#getEjbcClass#(#)#{#return#ejbcClass#;#}##void#setWeblogicdtd#(#String#inString#)#{#setEJBdtd#(#inString#)#;#}##void#setWLdtd#(#String#inString#)#{#this#.#weblogicDTD#=#inString#;#}##void#setEJBdtd#(#String#inString#)#{#this#.#ejb11DTD#=#inString#;#}##void#setOldCMP#(#boolean#oldCMP#)#{#this#.#newCMP#=#!#oldCMP#;#}##void#setNewCMP#(#boolean#newCMP#)#{#this#.#newCMP#=#newCMP#;#}##void#setNoEJBC#(#boolean#noEJBC#)#{#this#.#noEJBC#=#noEJBC#;#}##void#registerKnownDTDs#(#DescriptorHandler#handler#)#{#// register all the known DTDs#handler#.#registerDTD#(#PUBLICID_EJB11#,#DEFAULT_WL51_EJB11_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_EJB11#,#DEFAULT_WL60_EJB11_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_EJB11#,#ejb11DTD#)#;#handler#.#registerDTD#(#PUBLICID_EJB20#,#DEFAULT_WL60_EJB20_DTD_LOCATION#)#;#}##DescriptorHandler#getWeblogicDescriptorHandler#(#final#File#srcDir#)#{#DescriptorHandler#handler#=#new#DescriptorHandler#(#getTask#(#)#,#srcDir#)#{#protected#void#processElement#(#)#{#if#(#currentElement#.#equals#(#"type-storage"#)#)#{#// Get the filename of vendor specific descriptor#String#fileNameWithMETA#=#currentText#;#//trim the META_INF\ off of the file name#String#fileName#=#fileNameWithMETA#.#substring#(#META_DIR#.#length#(#)#,#fileNameWithMETA#.#length#(#)#)#;#File#descriptorFile#=#new#File#(#srcDir#,#fileName#)#;#ejbFiles#.#put#(#fileNameWithMETA#,#descriptorFile#)#;#}#}#}#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB510#,#DEFAULT_WL51_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB510#,#DEFAULT_WL60_51_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB600#,#DEFAULT_WL60_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB700#,#DEFAULT_WL70_DTD_LOCATION#)#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB510#,#weblogicDTD#)#;#handler#.#registerDTD#(#PUBLICID_WEBLOGIC_EJB600#,#weblogicDTD#)#;#for#(#Iterator#i#=#getConfig#(#)#.#dtdLocations#.#iterator#(#)#;#i#.#hasNext#(#)#;#)#{#EjbJar#.#DTDLocation#dtdLocation#=#(#EjbJar#.#DTDLocation#)#i#.#next#(#)#;#handler#.#registerDTD#(#dtdLocation#.#getPublicId#(#)#,#dtdLocation#.#getLocation#(#)#)#;#}#return#handler#;#}##void#processElement#(#)#{#if#(#currentElement#.#equals#(#"type-storage"#)#)#{#// Get the filename of vendor specific descriptor#String#fileNameWithMETA#=#currentText#;#//trim the META_INF\ off of the file name#String#fileName#=#fileNameWithMETA#.#substring#(#META_DIR#.#length#(#)#,#fileNameWithMETA#.#length#(#)#)#;#File#descriptorFile#=#new#File#(#srcDir#,#fileName#)#;#ejbFiles#.#put#(#fileNameWithMETA#,#descriptorFile#)#;#}#}##void#addVendorFiles#(#Hashtable#ejbFiles#,#String#ddPrefix#)#{#File#weblogicDD#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#WL_DD#)#;#if#(#weblogicDD#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#WL_DD#,#weblogicDD#)#;#}#else#{#log#(#"Unable to locate weblogic deployment descriptor. "#+#"It was expected to be in "#+#weblogicDD#.#getPath#(#)#,#Project#.#MSG_WARN#)#;#return#;#}#if#(#!#newCMP#)#{#log#(#"The old method for locating CMP files has been DEPRECATED."#,#Project#.#MSG_VERBOSE#)#;#log#(#"Please adjust your weblogic descriptor and set "#+#"newCMP=\"true\" to use the new CMP descriptor "#+#"inclusion mechanism. "#,#Project#.#MSG_VERBOSE#)#;#// The the weblogic cmp deployment descriptor#File#weblogicCMPDD#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#WL_CMP_DD#)#;#if#(#weblogicCMPDD#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#WL_CMP_DD#,#weblogicCMPDD#)#;#}#}#else#{#// now that we have the weblogic descriptor, we parse the file#// to find other descriptors needed to deploy the bean.#// this could be the weblogic-cmp-rdbms.xml or any other O/R#// mapping tool descriptors.#try#{#File#ejbDescriptor#=#(#File#)#ejbFiles#.#get#(#META_DIR#+#EJB_DD#)#;#SAXParserFactory#saxParserFactory#=#SAXParserFactory#.#newInstance#(#)#;#saxParserFactory#.#setValidating#(#true#)#;#SAXParser#saxParser#=#saxParserFactory#.#newSAXParser#(#)#;#DescriptorHandler#handler#=#getWeblogicDescriptorHandler#(#ejbDescriptor#.#getParentFile#(#)#)#;#saxParser#.#parse#(#new#InputSource#(#new#FileInputStream#(#weblogicDD#)#)#,#handler#)#;#Hashtable#ht#=#handler#.#getFiles#(#)#;#Enumeration#e#=#ht#.#keys#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#String#key#=#(#String#)#e#.#nextElement#(#)#;#ejbFiles#.#put#(#key#,#ht#.#get#(#key#)#)#;#}#}#catch#(#Exception#e#)#{#String#msg#=#"Exception while adding Vendor specific files: "#+#e#.#toString#(#)#;#throw#new#BuildException#(#msg#,#e#)#;#}#}#}##File#getVendorOutputJarFile#(#String#baseName#)#{#return#new#File#(#getDestDir#(#)#,#baseName#+#jarSuffix#)#;#}##void#buildWeblogicJar#(#File#sourceJar#,#File#destJar#,#String#publicId#)#{#Java#javaTask#=#null#;#if#(#noEJBC#)#{#try#{#FILE_UTILS#.#copyFile#(#sourceJar#,#destJar#)#;#if#(#!#keepgenerated#)#{#sourceJar#.#delete#(#)#;#}#return#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"Unable to write EJB jar"#,#e#)#;#}#}#String#ejbcClassName#=#ejbcClass#;#try#{#javaTask#=#new#Java#(#getTask#(#)#)#;#javaTask#.#setTaskName#(#"ejbc"#)#;#javaTask#.#createJvmarg#(#)#.#setLine#(#additionalJvmArgs#)#;#if#(#!#(#sysprops#.#isEmpty#(#)#)#)#{#for#(#Enumeration#en#=#sysprops#.#elements#(#)#;#en#.#hasMoreElements#(#)#;#)#{#Environment#.#Variable#entry#=#(#Environment#.#Variable#)#en#.#nextElement#(#)#;#javaTask#.#addSysproperty#(#entry#)#;#}#}#if#(#getJvmDebugLevel#(#)#!=#null#)#{#javaTask#.#createJvmarg#(#)#.#setLine#(#" -Dweblogic.StdoutSeverityLevel="#+#jvmDebugLevel#)#;#}#if#(#ejbcClassName#==#null#)#{#// try to determine it from publicId#if#(#PUBLICID_EJB11#.#equals#(#publicId#)#)#{#ejbcClassName#=#COMPILER_EJB11#;#}#else#if#(#PUBLICID_EJB20#.#equals#(#publicId#)#)#{#ejbcClassName#=#COMPILER_EJB20#;#}#else#{#log#(#"Unrecognized publicId "#+#publicId#+#" - using EJB 1.1 compiler"#,#Project#.#MSG_WARN#)#;#ejbcClassName#=#COMPILER_EJB11#;#}#}#javaTask#.#setClassname#(#ejbcClassName#)#;#javaTask#.#createArg#(#)#.#setLine#(#additionalArgs#)#;#if#(#keepgenerated#)#{#javaTask#.#createArg#(#)#.#setValue#(#"-keepgenerated"#)#;#}#if#(#compiler#==#null#)#{#// try to use the compiler specified by build.compiler.#// Right now we are just going to allow Jikes#String#buildCompiler#=#getTask#(#)#.#getProject#(#)#.#getProperty#(#"build.compiler"#)#;#if#(#buildCompiler#!=#null#&&#buildCompiler#.#equals#(#"jikes"#)#)#{#javaTask#.#createArg#(#)#.#setValue#(#"-compiler"#)#;#javaTask#.#createArg#(#)#.#setValue#(#"jikes"#)#;#}#}#else#{#if#(#!#compiler#.#equals#(#DEFAULT_COMPILER#)#)#{#javaTask#.#createArg#(#)#.#setValue#(#"-compiler"#)#;#javaTask#.#createArg#(#)#.#setLine#(#compiler#)#;#}#}#Path#combinedClasspath#=#getCombinedClasspath#(#)#;#if#(#wlClasspath#!=#null#&&#combinedClasspath#!=#null#&&#combinedClasspath#.#toString#(#)#.#trim#(#)#.#length#(#)#>#0#)#{#javaTask#.#createArg#(#)#.#setValue#(#"-classpath"#)#;#javaTask#.#createArg#(#)#.#setPath#(#combinedClasspath#)#;#}#javaTask#.#createArg#(#)#.#setValue#(#sourceJar#.#getPath#(#)#)#;#if#(#outputDir#==#null#)#{#javaTask#.#createArg#(#)#.#setValue#(#destJar#.#getPath#(#)#)#;#}#else#{#javaTask#.#createArg#(#)#.#setValue#(#outputDir#.#getPath#(#)#)#;#}#Path#classpath#=#wlClasspath#;#if#(#classpath#==#null#)#{#classpath#=#getCombinedClasspath#(#)#;#}#javaTask#.#setFork#(#true#)#;#if#(#classpath#!=#null#)#{#javaTask#.#setClasspath#(#classpath#)#;#}#log#(#"Calling "#+#ejbcClassName#+#" for "#+#sourceJar#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#if#(#javaTask#.#executeJava#(#)#!=#0#)#{#throw#new#BuildException#(#"Ejbc reported an error"#)#;#}#}#catch#(#Exception#e#)#{#// Have to catch this because of the semantics of calling main()#String#msg#=#"Exception while calling "#+#ejbcClassName#+#". Details: "#+#e#.#toString#(#)#;#throw#new#BuildException#(#msg#,#e#)#;#}#}##void#writeJar#(#String#baseName#,#File#jarFile#,#Hashtable#files#,#String#publicId#)#throws#BuildException#{#// need to create a generic jar first.#File#genericJarFile#=#super#.#getVendorOutputJarFile#(#baseName#)#;#super#.#writeJar#(#baseName#,#genericJarFile#,#files#,#publicId#)#;#if#(#alwaysRebuild#||#isRebuildRequired#(#genericJarFile#,#jarFile#)#)#{#buildWeblogicJar#(#genericJarFile#,#jarFile#,#publicId#)#;#}#if#(#!#keepGeneric#)#{#log#(#"deleting generic jar "#+#genericJarFile#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#genericJarFile#.#delete#(#)#;#}#}##void#validateConfigured#(#)#throws#BuildException#{#super#.#validateConfigured#(#)#;#}##boolean#isRebuildRequired#(#File#genericJarFile#,#File#weblogicJarFile#)#{#boolean#rebuild#=#false#;#JarFile#genericJar#=#null#;#JarFile#wlJar#=#null#;#File#newWLJarFile#=#null#;#JarOutputStream#newJarStream#=#null#;#ClassLoader#genericLoader#=#null#;#try#{#log#(#"Checking if weblogic Jar needs to be rebuilt for jar "#+#weblogicJarFile#.#getName#(#)#,#Project#.#MSG_VERBOSE#)#;#// Only go forward if the generic and the weblogic file both exist#if#(#genericJarFile#.#exists#(#)#&&#genericJarFile#.#isFile#(#)#&&#weblogicJarFile#.#exists#(#)#&&#weblogicJarFile#.#isFile#(#)#)#{#//open jar files#genericJar#=#new#JarFile#(#genericJarFile#)#;#wlJar#=#new#JarFile#(#weblogicJarFile#)#;#Hashtable#genericEntries#=#new#Hashtable#(#)#;#Hashtable#wlEntries#=#new#Hashtable#(#)#;#Hashtable#replaceEntries#=#new#Hashtable#(#)#;#//get the list of generic jar entries#for#(#Enumeration#e#=#genericJar#.#entries#(#)#;#e#.#hasMoreElements#(#)#;#)#{#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#genericEntries#.#put#(#je#.#getName#(#)#.#replace#(#'\\'#,#'/'#)#,#je#)#;#}#//get the list of weblogic jar entries#for#(#Enumeration#e#=#wlJar#.#entries#(#)#;#e#.#hasMoreElements#(#)#;#)#{#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#wlEntries#.#put#(#je#.#getName#(#)#,#je#)#;#}#//Cycle Through generic and make sure its in weblogic#genericLoader#=#getClassLoaderFromJar#(#genericJarFile#)#;#for#(#Enumeration#e#=#genericEntries#.#keys#(#)#;#e#.#hasMoreElements#(#)#;#)#{#String#filepath#=#(#String#)#e#.#nextElement#(#)#;#if#(#wlEntries#.#containsKey#(#filepath#)#)#{#// File name/path match#// Check files see if same#JarEntry#genericEntry#=#(#JarEntry#)#genericEntries#.#get#(#filepath#)#;#JarEntry#wlEntry#=#(#JarEntry#)#wlEntries#.#get#(#filepath#)#;#if#(#(#genericEntry#.#getCrc#(#)#!=#wlEntry#.#getCrc#(#)#)#||#(#genericEntry#.#getSize#(#)#!=#wlEntry#.#getSize#(#)#)#)#{#if#(#genericEntry#.#getName#(#)#.#endsWith#(#".class"#)#)#{#//File are different see if its an object or an interface#String#classname#=#genericEntry#.#getName#(#)#.#replace#(#File#.#separatorChar#,#'.'#)#.#replace#(#'/'#,#'.'#)#;#classname#=#classname#.#substring#(#0#,#classname#.#lastIndexOf#(#".class"#)#)#;#Class#genclass#=#genericLoader#.#loadClass#(#classname#)#;#if#(#genclass#.#isInterface#(#)#)#{#//Interface changed   rebuild jar.#log#(#"Interface "#+#genclass#.#getName#(#)#+#" has changed"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#break#;#}#else#{#//Object class Changed   update it.#replaceEntries#.#put#(#filepath#,#genericEntry#)#;#}#}#else#{#// is it the manifest. If so ignore it#if#(#!#genericEntry#.#getName#(#)#.#equals#(#"META-INF/MANIFEST.MF"#)#)#{#//File other then class changed   rebuild#log#(#"Non class file "#+#genericEntry#.#getName#(#)#+#" has changed"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#break#;#}#}#}#}#else#{#// a file doesnt exist rebuild#log#(#"File "#+#filepath#+#" not present in weblogic jar"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#break#;#}#}#if#(#!#rebuild#)#{#log#(#"No rebuild needed - updating jar"#,#Project#.#MSG_VERBOSE#)#;#newWLJarFile#=#new#File#(#weblogicJarFile#.#getAbsolutePath#(#)#+#".temp"#)#;#if#(#newWLJarFile#.#exists#(#)#)#{#newWLJarFile#.#delete#(#)#;#}#newJarStream#=#new#JarOutputStream#(#new#FileOutputStream#(#newWLJarFile#)#)#;#newJarStream#.#setLevel#(#0#)#;#//Copy files from old weblogic jar#for#(#Enumeration#e#=#wlEntries#.#elements#(#)#;#e#.#hasMoreElements#(#)#;#)#{#byte#[#]#buffer#=#new#byte#[#DEFAULT_BUFFER_SIZE#]#;#int#bytesRead#;#InputStream#is#;#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#if#(#je#.#getCompressedSize#(#)#==#-#1#||#je#.#getCompressedSize#(#)#==#je#.#getSize#(#)#)#{#newJarStream#.#setLevel#(#0#)#;#}#else#{#newJarStream#.#setLevel#(#JAR_COMPRESS_LEVEL#)#;#}#// Update with changed Bean class#if#(#replaceEntries#.#containsKey#(#je#.#getName#(#)#)#)#{#log#(#"Updating Bean class from generic Jar "#+#je#.#getName#(#)#,#Project#.#MSG_VERBOSE#)#;#// Use the entry from the generic jar#je#=#(#JarEntry#)#replaceEntries#.#get#(#je#.#getName#(#)#)#;#is#=#genericJar#.#getInputStream#(#je#)#;#}#else#{#//use fle from original weblogic jar#is#=#wlJar#.#getInputStream#(#je#)#;#}#newJarStream#.#putNextEntry#(#new#JarEntry#(#je#.#getName#(#)#)#)#;#while#(#(#bytesRead#=#is#.#read#(#buffer#)#)#!=#-#1#)#{#newJarStream#.#write#(#buffer#,#0#,#bytesRead#)#;#}#is#.#close#(#)#;#}#}#else#{#log#(#"Weblogic Jar rebuild needed due to changed "#+#"interface or XML"#,#Project#.#MSG_VERBOSE#)#;#}#}#else#{#rebuild#=#true#;#}#}#catch#(#ClassNotFoundException#cnfe#)#{#String#cnfmsg#=#"ClassNotFoundException while processing ejb-jar file"#+#". Details: "#+#cnfe#.#getMessage#(#)#;#throw#new#BuildException#(#cnfmsg#,#cnfe#)#;#}#catch#(#IOException#ioe#)#{#String#msg#=#"IOException while processing ejb-jar file "#+#". Details: "#+#ioe#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#ioe#)#;#}#finally#{#// need to close files and perhaps rename output#if#(#genericJar#!=#null#)#{#try#{#genericJar#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// empty#}#}#if#(#wlJar#!=#null#)#{#try#{#wlJar#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// empty#}#}#if#(#newJarStream#!=#null#)#{#try#{#newJarStream#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// empty#}#try#{#FILE_UTILS#.#rename#(#newWLJarFile#,#weblogicJarFile#)#;#}#catch#(#IOException#renameException#)#{#log#(#renameException#.#getMessage#(#)#,#Project#.#MSG_WARN#)#;#rebuild#=#true#;#}#}#if#(#genericLoader#!=#null#&&#genericLoader#instanceof#AntClassLoader#)#{#AntClassLoader#loader#=#(#AntClassLoader#)#genericLoader#;#loader#.#cleanup#(#)#;#}#}#return#rebuild#;#}##ClassLoader#getClassLoaderFromJar#(#File#classjar#)#throws#IOException#{#Path#lookupPath#=#new#Path#(#getTask#(#)#.#getProject#(#)#)#;#lookupPath#.#setLocation#(#classjar#)#;#Path#classpath#=#getCombinedClasspath#(#)#;#if#(#classpath#!=#null#)#{#lookupPath#.#append#(#classpath#)#;#}#return#getTask#(#)#.#getProject#(#)#.#createClassLoader#(#lookupPath#)#;#}##