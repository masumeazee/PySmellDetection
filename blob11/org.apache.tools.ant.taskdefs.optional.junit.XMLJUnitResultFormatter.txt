DocumentBuilder#getDocumentBuilder#(#)#{#try#{#return#DocumentBuilderFactory#.#newInstance#(#)#.#newDocumentBuilder#(#)#;#}#catch#(#Exception#exc#)#{#throw#new#ExceptionInInitializerError#(#exc#)#;#}#}##void#setOutput#(#OutputStream#out#)#{#this#.#out#=#out#;#}##void#setSystemOutput#(#String#out#)#{#formatOutput#(#SYSTEM_OUT#,#out#)#;#}##void#setSystemError#(#String#out#)#{#formatOutput#(#SYSTEM_ERR#,#out#)#;#}##void#startTestSuite#(#JUnitTest#suite#)#{#doc#=#getDocumentBuilder#(#)#.#newDocument#(#)#;#rootElement#=#doc#.#createElement#(#TESTSUITE#)#;#String#n#=#suite#.#getName#(#)#;#rootElement#.#setAttribute#(#ATTR_NAME#,#n#==#null#?#UNKNOWN#:#n#)#;#//add the timestamp#final#String#timestamp#=#DateUtils#.#format#(#new#Date#(#)#,#DateUtils#.#ISO8601_DATETIME_PATTERN#)#;#rootElement#.#setAttribute#(#TIMESTAMP#,#timestamp#)#;#//and the hostname.#rootElement#.#setAttribute#(#HOSTNAME#,#getHostname#(#)#)#;#// Output properties#Element#propsElement#=#doc#.#createElement#(#PROPERTIES#)#;#rootElement#.#appendChild#(#propsElement#)#;#Properties#props#=#suite#.#getProperties#(#)#;#if#(#props#!=#null#)#{#Enumeration#e#=#props#.#propertyNames#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#String#name#=#(#String#)#e#.#nextElement#(#)#;#Element#propElement#=#doc#.#createElement#(#PROPERTY#)#;#propElement#.#setAttribute#(#ATTR_NAME#,#name#)#;#propElement#.#setAttribute#(#ATTR_VALUE#,#props#.#getProperty#(#name#)#)#;#propsElement#.#appendChild#(#propElement#)#;#}#}#}##String#getHostname#(#)#{#try#{#return#InetAddress#.#getLocalHost#(#)#.#getHostName#(#)#;#}#catch#(#UnknownHostException#e#)#{#return#"localhost"#;#}#}##void#endTestSuite#(#JUnitTest#suite#)#throws#BuildException#{#rootElement#.#setAttribute#(#ATTR_TESTS#,#""#+#suite#.#runCount#(#)#)#;#rootElement#.#setAttribute#(#ATTR_FAILURES#,#""#+#suite#.#failureCount#(#)#)#;#rootElement#.#setAttribute#(#ATTR_ERRORS#,#""#+#suite#.#errorCount#(#)#)#;#rootElement#.#setAttribute#(#ATTR_TIME#,#""#+#(#suite#.#getRunTime#(#)#/#ONE_SECOND#)#)#;#if#(#out#!=#null#)#{#Writer#wri#=#null#;#try#{#wri#=#new#BufferedWriter#(#new#OutputStreamWriter#(#out#,#"UTF8"#)#)#;#wri#.#write#(#"<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n"#)#;#(#new#DOMElementWriter#(#)#)#.#write#(#rootElement#,#wri#,#0#,#"  "#)#;#}#catch#(#IOException#exc#)#{#throw#new#BuildException#(#"Unable to write log file"#,#exc#)#;#}#finally#{#if#(#wri#!=#null#)#{#try#{#wri#.#flush#(#)#;#}#catch#(#IOException#ex#)#{#// ignore#}#}#if#(#out#!=#System#.#out#&&#out#!=#System#.#err#)#{#FileUtils#.#close#(#wri#)#;#}#}#}#}##void#startTest#(#Test#t#)#{#testStarts#.#put#(#t#,#new#Long#(#System#.#currentTimeMillis#(#)#)#)#;#}##void#endTest#(#Test#test#)#{#// Fix for bug #5637 - if a junit.extensions.TestSetup is#// used and throws an exception during setUp then startTest#// would never have been called#if#(#!#testStarts#.#containsKey#(#test#)#)#{#startTest#(#test#)#;#}#Element#currentTest#=#null#;#if#(#!#failedTests#.#containsKey#(#test#)#)#{#currentTest#=#doc#.#createElement#(#TESTCASE#)#;#String#n#=#JUnitVersionHelper#.#getTestCaseName#(#test#)#;#currentTest#.#setAttribute#(#ATTR_NAME#,#n#==#null#?#UNKNOWN#:#n#)#;#// a TestSuite can contain Tests from multiple classes,#// even tests with the same name - disambiguate them.#currentTest#.#setAttribute#(#ATTR_CLASSNAME#,#JUnitVersionHelper#.#getTestCaseClassName#(#test#)#)#;#rootElement#.#appendChild#(#currentTest#)#;#testElements#.#put#(#test#,#currentTest#)#;#}#else#{#currentTest#=#(#Element#)#testElements#.#get#(#test#)#;#}#Long#l#=#(#Long#)#testStarts#.#get#(#test#)#;#currentTest#.#setAttribute#(#ATTR_TIME#,#""#+#(#(#System#.#currentTimeMillis#(#)#-#l#.#longValue#(#)#)#/#ONE_SECOND#)#)#;#}##void#addFailure#(#Test#test#,#Throwable#t#)#{#formatError#(#FAILURE#,#test#,#t#)#;#}##void#addFailure#(#Test#test#,#AssertionFailedError#t#)#{#addFailure#(#test#,#(#Throwable#)#t#)#;#}##void#addError#(#Test#test#,#Throwable#t#)#{#formatError#(#ERROR#,#test#,#t#)#;#}##void#formatError#(#String#type#,#Test#test#,#Throwable#t#)#{#if#(#test#!=#null#)#{#endTest#(#test#)#;#failedTests#.#put#(#test#,#test#)#;#}#Element#nested#=#doc#.#createElement#(#type#)#;#Element#currentTest#=#null#;#if#(#test#!=#null#)#{#currentTest#=#(#Element#)#testElements#.#get#(#test#)#;#}#else#{#currentTest#=#rootElement#;#}#currentTest#.#appendChild#(#nested#)#;#String#message#=#t#.#getMessage#(#)#;#if#(#message#!=#null#&&#message#.#length#(#)#>#0#)#{#nested#.#setAttribute#(#ATTR_MESSAGE#,#t#.#getMessage#(#)#)#;#}#nested#.#setAttribute#(#ATTR_TYPE#,#t#.#getClass#(#)#.#getName#(#)#)#;#String#strace#=#JUnitTestRunner#.#getFilteredTrace#(#t#)#;#Text#trace#=#doc#.#createTextNode#(#strace#)#;#nested#.#appendChild#(#trace#)#;#}##void#formatOutput#(#String#type#,#String#output#)#{#Element#nested#=#doc#.#createElement#(#type#)#;#rootElement#.#appendChild#(#nested#)#;#nested#.#appendChild#(#doc#.#createCDATASection#(#output#)#)#;#}##