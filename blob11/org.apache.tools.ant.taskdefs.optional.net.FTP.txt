boolean#exists#(#)#{#return#true#;#}##String#getAbsolutePath#(#)#{#return#name#;#}##String#getName#(#)#{#return#parts#.#length#>#0#?#parts#[#parts#.#length#-#1#]#:#name#;#}##String#getParent#(#)#{#String#result#=#""#;#for#(#int#i#=#0#;#i#<#parts#.#length#-#1#;#i#++#)#{#result#+=#File#.#separatorChar#+#parts#[#i#]#;#}#return#result#;#}##String#getPath#(#)#{#return#name#;#}##boolean#isAbsolute#(#)#{#return#true#;#}##boolean#isDirectory#(#)#{#return#file#==#null#;#}##boolean#isFile#(#)#{#return#file#!=#null#;#}##boolean#isHidden#(#)#{#return#false#;#}##long#lastModified#(#)#{#if#(#file#!=#null#)#{#return#file#.#getTimestamp#(#)#.#getTimeInMillis#(#)#;#}#return#0#;#}##long#length#(#)#{#if#(#file#!=#null#)#{#return#file#.#getSize#(#)#;#}#return#0#;#}##void#scan#(#)#{#if#(#includes#==#null#)#{#// No includes supplied, so set it to 'matches all'#includes#=#new#String#[#1#]#;#includes#[#0#]#=#"**"#;#}#if#(#excludes#==#null#)#{#excludes#=#new#String#[#0#]#;#}#filesIncluded#=#new#Vector#(#)#;#filesNotIncluded#=#new#Vector#(#)#;#filesExcluded#=#new#Vector#(#)#;#dirsIncluded#=#new#Vector#(#)#;#dirsNotIncluded#=#new#Vector#(#)#;#dirsExcluded#=#new#Vector#(#)#;#try#{#String#cwd#=#ftp#.#printWorkingDirectory#(#)#;#// always start from the current ftp working dir#forceRemoteSensitivityCheck#(#)#;#checkIncludePatterns#(#)#;#clearCaches#(#)#;#ftp#.#changeWorkingDirectory#(#cwd#)#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"Unable to scan FTP server: "#,#e#)#;#}#}##void#checkIncludePatterns#(#)#{#Hashtable#newroots#=#new#Hashtable#(#)#;#// put in the newroots vector the include patterns without#// wildcard tokens#for#(#int#icounter#=#0#;#icounter#<#includes#.#length#;#icounter#++#)#{#String#newpattern#=#SelectorUtils#.#rtrimWildcardTokens#(#includes#[#icounter#]#)#;#newroots#.#put#(#newpattern#,#includes#[#icounter#]#)#;#}#if#(#remotedir#==#null#)#{#try#{#remotedir#=#ftp#.#printWorkingDirectory#(#)#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"could not read current ftp directory"#,#getLocation#(#)#)#;#}#}#AntFTPFile#baseFTPFile#=#new#AntFTPRootFile#(#ftp#,#remotedir#)#;#rootPath#=#baseFTPFile#.#getAbsolutePath#(#)#;#// construct it#if#(#newroots#.#containsKey#(#""#)#)#{#// we are going to scan everything anyway#scandir#(#rootPath#,#""#,#true#)#;#}#else#{#// only scan directories that can include matched files or#// directories#Enumeration#enum2#=#newroots#.#keys#(#)#;#while#(#enum2#.#hasMoreElements#(#)#)#{#String#currentelement#=#(#String#)#enum2#.#nextElement#(#)#;#String#originalpattern#=#(#String#)#newroots#.#get#(#currentelement#)#;#AntFTPFile#myfile#=#new#AntFTPFile#(#baseFTPFile#,#currentelement#)#;#boolean#isOK#=#true#;#boolean#traversesSymlinks#=#false#;#String#path#=#null#;#if#(#myfile#.#exists#(#)#)#{#forceRemoteSensitivityCheck#(#)#;#if#(#remoteSensitivityChecked#&&#remoteSystemCaseSensitive#&&#isFollowSymlinks#(#)#)#{#// cool case,#//we do not need to scan all the subdirs in the relative path#path#=#myfile#.#getFastRelativePath#(#)#;#}#else#{#// may be on a case insensitive file system.  We want#// the results to show what's really on the disk, so#// we need to double check.#try#{#path#=#myfile#.#getRelativePath#(#)#;#traversesSymlinks#=#myfile#.#isTraverseSymlinks#(#)#;#}#catch#(#IOException#be#)#{#throw#new#BuildException#(#be#,#getLocation#(#)#)#;#}#catch#(#BuildException#be#)#{#isOK#=#false#;#}#}#}#else#{#isOK#=#false#;#}#if#(#isOK#)#{#currentelement#=#path#.#replace#(#remoteFileSep#.#charAt#(#0#)#,#File#.#separatorChar#)#;#if#(#!#isFollowSymlinks#(#)#&&#traversesSymlinks#)#{#continue#;#}#if#(#myfile#.#isDirectory#(#)#)#{#if#(#isIncluded#(#currentelement#)#&&#currentelement#.#length#(#)#>#0#)#{#accountForIncludedDir#(#currentelement#,#myfile#,#true#)#;#}#else#{#if#(#currentelement#.#length#(#)#>#0#)#{#if#(#currentelement#.#charAt#(#currentelement#.#length#(#)#-#1#)#!=#File#.#separatorChar#)#{#currentelement#=#currentelement#+#File#.#separatorChar#;#}#}#scandir#(#myfile#.#getAbsolutePath#(#)#,#currentelement#,#true#)#;#}#}#else#{#if#(#isCaseSensitive#&&#originalpattern#.#equals#(#currentelement#)#)#{#accountForIncludedFile#(#currentelement#)#;#}#else#if#(#!#isCaseSensitive#&&#originalpattern#.#equalsIgnoreCase#(#currentelement#)#)#{#accountForIncludedFile#(#currentelement#)#;#}#}#}#}#}#}##void#scandir#(#String#dir#,#String#vpath#,#boolean#fast#)#{#// avoid double scanning of directories, can only happen in fast mode#if#(#fast#&&#hasBeenScanned#(#vpath#)#)#{#return#;#}#try#{#if#(#!#ftp#.#changeWorkingDirectory#(#dir#)#)#{#return#;#}#String#completePath#=#null#;#if#(#!#vpath#.#equals#(#""#)#)#{#completePath#=#rootPath#+#remoteFileSep#+#vpath#.#replace#(#File#.#separatorChar#,#remoteFileSep#.#charAt#(#0#)#)#;#}#else#{#completePath#=#rootPath#;#}#FTPFile#[#]#newfiles#=#listFiles#(#completePath#,#false#)#;#if#(#newfiles#==#null#)#{#ftp#.#changeToParentDirectory#(#)#;#return#;#}#for#(#int#i#=#0#;#i#<#newfiles#.#length#;#i#++#)#{#FTPFile#file#=#newfiles#[#i#]#;#if#(#file#!=#null#&&#!#file#.#getName#(#)#.#equals#(#"."#)#&&#!#file#.#getName#(#)#.#equals#(#".."#)#)#{#String#name#=#vpath#+#file#.#getName#(#)#;#scannedDirs#.#put#(#name#,#new#FTPFileProxy#(#file#)#)#;#if#(#isFunctioningAsDirectory#(#ftp#,#dir#,#file#)#)#{#boolean#slowScanAllowed#=#true#;#if#(#!#isFollowSymlinks#(#)#&&#file#.#isSymbolicLink#(#)#)#{#dirsExcluded#.#addElement#(#name#)#;#slowScanAllowed#=#false#;#}#else#if#(#isIncluded#(#name#)#)#{#accountForIncludedDir#(#name#,#new#AntFTPFile#(#ftp#,#file#,#completePath#)#,#fast#)#;#}#else#{#dirsNotIncluded#.#addElement#(#name#)#;#if#(#fast#&&#couldHoldIncluded#(#name#)#)#{#scandir#(#file#.#getName#(#)#,#name#+#File#.#separator#,#fast#)#;#}#}#if#(#!#fast#&&#slowScanAllowed#)#{#scandir#(#file#.#getName#(#)#,#name#+#File#.#separator#,#fast#)#;#}#}#else#{#if#(#!#isFollowSymlinks#(#)#&&#file#.#isSymbolicLink#(#)#)#{#filesExcluded#.#addElement#(#name#)#;#}#else#if#(#isFunctioningAsFile#(#ftp#,#dir#,#file#)#)#{#accountForIncludedFile#(#name#)#;#}#}#}#}#ftp#.#changeToParentDirectory#(#)#;#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"Error while communicating with FTP "#+#"server: "#,#e#)#;#}#}##void#accountForIncludedFile#(#String#name#)#{#if#(#!#filesIncluded#.#contains#(#name#)#&&#!#filesExcluded#.#contains#(#name#)#)#{#if#(#isIncluded#(#name#)#)#{#if#(#!#isExcluded#(#name#)#&&#isSelected#(#name#,#(#File#)#scannedDirs#.#get#(#name#)#)#)#{#filesIncluded#.#addElement#(#name#)#;#}#else#{#filesExcluded#.#addElement#(#name#)#;#}#}#else#{#filesNotIncluded#.#addElement#(#name#)#;#}#}#}##void#accountForIncludedDir#(#String#name#,#AntFTPFile#file#,#boolean#fast#)#{#if#(#!#dirsIncluded#.#contains#(#name#)#&&#!#dirsExcluded#.#contains#(#name#)#)#{#if#(#!#isExcluded#(#name#)#)#{#if#(#fast#)#{#if#(#file#.#isSymbolicLink#(#)#)#{#try#{#file#.#getClient#(#)#.#changeWorkingDirectory#(#file#.#curpwd#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#"could not change directory to curpwd"#)#;#}#scandir#(#file#.#getLink#(#)#,#name#+#File#.#separator#,#fast#)#;#}#else#{#try#{#file#.#getClient#(#)#.#changeWorkingDirectory#(#file#.#curpwd#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#"could not change directory to curpwd"#)#;#}#scandir#(#file#.#getName#(#)#,#name#+#File#.#separator#,#fast#)#;#}#}#dirsIncluded#.#addElement#(#name#)#;#}#else#{#dirsExcluded#.#addElement#(#name#)#;#if#(#fast#&&#couldHoldIncluded#(#name#)#)#{#try#{#file#.#getClient#(#)#.#changeWorkingDirectory#(#file#.#curpwd#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#"could not change directory to curpwd"#)#;#}#scandir#(#file#.#getName#(#)#,#name#+#File#.#separator#,#fast#)#;#}#}#}#}##boolean#hasBeenScanned#(#String#vpath#)#{#return#scannedDirs#.#containsKey#(#vpath#)#;#}##void#clearCaches#(#)#{#fileListMap#.#clear#(#)#;#scannedDirs#.#clear#(#)#;#}##FTPFile#[#]#listFiles#(#String#directory#,#boolean#changedir#)#{#//getProject().log("listing files in directory " + directory, Project.MSG_DEBUG);#String#currentPath#=#directory#;#if#(#changedir#)#{#try#{#boolean#result#=#ftp#.#changeWorkingDirectory#(#directory#)#;#if#(#!#result#)#{#return#null#;#}#currentPath#=#ftp#.#printWorkingDirectory#(#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#,#getLocation#(#)#)#;#}#}#if#(#fileListMap#.#containsKey#(#currentPath#)#)#{#getProject#(#)#.#log#(#"filelist map used in listing files"#,#Project#.#MSG_DEBUG#)#;#return#(#(#FTPFile#[#]#)#fileListMap#.#get#(#currentPath#)#)#;#}#FTPFile#[#]#result#=#null#;#try#{#result#=#ftp#.#listFiles#(#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#,#getLocation#(#)#)#;#}#fileListMap#.#put#(#currentPath#,#result#)#;#if#(#!#remoteSensitivityChecked#)#{#checkRemoteSensitivity#(#result#,#directory#)#;#}#return#result#;#}##void#forceRemoteSensitivityCheck#(#)#{#if#(#!#remoteSensitivityChecked#)#{#try#{#checkRemoteSensitivity#(#ftp#.#listFiles#(#)#,#ftp#.#printWorkingDirectory#(#)#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#,#getLocation#(#)#)#;#}#}#}##FTPFile#[#]#listFiles#(#String#directory#)#{#return#listFiles#(#directory#,#true#)#;#}##void#checkRemoteSensitivity#(#FTPFile#[#]#array#,#String#directory#)#{#if#(#array#==#null#)#{#return#;#}#boolean#candidateFound#=#false#;#String#target#=#null#;#for#(#int#icounter#=#0#;#icounter#<#array#.#length#;#icounter#++#)#{#if#(#array#[#icounter#]#!=#null#&&#array#[#icounter#]#.#isDirectory#(#)#)#{#if#(#!#array#[#icounter#]#.#getName#(#)#.#equals#(#"."#)#&&#!#array#[#icounter#]#.#getName#(#)#.#equals#(#".."#)#)#{#candidateFound#=#true#;#target#=#fiddleName#(#array#[#icounter#]#.#getName#(#)#)#;#getProject#(#)#.#log#(#"will try to cd to "#+#target#+#" where a directory called "#+#array#[#icounter#]#.#getName#(#)#+#" exists"#,#Project#.#MSG_DEBUG#)#;#for#(#int#pcounter#=#0#;#pcounter#<#array#.#length#;#pcounter#++#)#{#if#(#array#[#pcounter#]#!=#null#&&#pcounter#!=#icounter#&&#target#.#equals#(#array#[#pcounter#]#.#getName#(#)#)#)#{#candidateFound#=#false#;#}#}#if#(#candidateFound#)#{#break#;#}#}#}#}#if#(#candidateFound#)#{#try#{#getProject#(#)#.#log#(#"testing case sensitivity, attempting to cd to "#+#target#,#Project#.#MSG_DEBUG#)#;#remoteSystemCaseSensitive#=#!#ftp#.#changeWorkingDirectory#(#target#)#;#}#catch#(#IOException#ioe#)#{#remoteSystemCaseSensitive#=#true#;#}#finally#{#try#{#ftp#.#changeWorkingDirectory#(#directory#)#;#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#,#getLocation#(#)#)#;#}#}#getProject#(#)#.#log#(#"remote system is case sensitive : "#+#remoteSystemCaseSensitive#,#Project#.#MSG_VERBOSE#)#;#remoteSensitivityChecked#=#true#;#}#}##String#fiddleName#(#String#origin#)#{#StringBuffer#result#=#new#StringBuffer#(#)#;#for#(#int#icounter#=#0#;#icounter#<#origin#.#length#(#)#;#icounter#++#)#{#if#(#Character#.#isLowerCase#(#origin#.#charAt#(#icounter#)#)#)#{#result#.#append#(#Character#.#toUpperCase#(#origin#.#charAt#(#icounter#)#)#)#;#}#else#if#(#Character#.#isUpperCase#(#origin#.#charAt#(#icounter#)#)#)#{#result#.#append#(#Character#.#toLowerCase#(#origin#.#charAt#(#icounter#)#)#)#;#}#else#{#result#.#append#(#origin#.#charAt#(#icounter#)#)#;#}#}#return#result#.#toString#(#)#;#}##String#findPathElementCaseUnsensitive#(#String#parentPath#,#String#soughtPathElement#)#{#// we are already in the right path, so the second parameter#// is false#FTPFile#[#]#theFiles#=#listFiles#(#parentPath#,#false#)#;#if#(#theFiles#==#null#)#{#return#null#;#}#for#(#int#icounter#=#0#;#icounter#<#theFiles#.#length#;#icounter#++#)#{#if#(#theFiles#[#icounter#]#!=#null#&&#theFiles#[#icounter#]#.#getName#(#)#.#equalsIgnoreCase#(#soughtPathElement#)#)#{#return#theFiles#[#icounter#]#.#getName#(#)#;#}#}#return#null#;#}##boolean#exists#(#)#{#return#(#ftpFile#!=#null#)#;#}##String#getLink#(#)#{#return#ftpFile#.#getLink#(#)#;#}##String#getName#(#)#{#return#ftpFile#.#getName#(#)#;#}##String#getAbsolutePath#(#)#{#return#curpwd#+#remoteFileSep#+#ftpFile#.#getName#(#)#;#}##String#getFastRelativePath#(#)#{#String#absPath#=#getAbsolutePath#(#)#;#if#(#absPath#.#indexOf#(#rootPath#+#remoteFileSep#)#==#0#)#{#return#absPath#.#substring#(#rootPath#.#length#(#)#+#remoteFileSep#.#length#(#)#)#;#}#return#null#;#}##String#getRelativePath#(#)#throws#IOException#,#BuildException#{#if#(#!#relativePathCalculated#)#{#if#(#parent#!=#null#)#{#traversesSymlinks#=#parent#.#isTraverseSymlinks#(#)#;#relativePath#=#getRelativePath#(#parent#.#getAbsolutePath#(#)#,#parent#.#getRelativePath#(#)#)#;#}#else#{#relativePath#=#getRelativePath#(#rootPath#,#""#)#;#relativePathCalculated#=#true#;#}#}#return#relativePath#;#}##String#getRelativePath#(#String#currentPath#,#String#currentRelativePath#)#{#Vector#pathElements#=#SelectorUtils#.#tokenizePath#(#getAbsolutePath#(#)#,#remoteFileSep#)#;#Vector#pathElements2#=#SelectorUtils#.#tokenizePath#(#currentPath#,#remoteFileSep#)#;#String#relPath#=#currentRelativePath#;#for#(#int#pcount#=#pathElements2#.#size#(#)#;#pcount#<#pathElements#.#size#(#)#;#pcount#++#)#{#String#currentElement#=#(#String#)#pathElements#.#elementAt#(#pcount#)#;#FTPFile#[#]#theFiles#=#listFiles#(#currentPath#)#;#FTPFile#theFile#=#null#;#if#(#theFiles#!=#null#)#{#theFile#=#getFile#(#theFiles#,#currentElement#)#;#}#if#(#!#relPath#.#equals#(#""#)#)#{#relPath#=#relPath#+#remoteFileSep#;#}#if#(#theFile#==#null#)#{#// hit a hidden file assume not a symlink#relPath#=#relPath#+#currentElement#;#currentPath#=#currentPath#+#remoteFileSep#+#currentElement#;#log#(#"Hidden file "#+#relPath#+#" assumed to not be a symlink."#,#Project#.#MSG_VERBOSE#)#;#}#else#{#traversesSymlinks#=#traversesSymlinks#||#theFile#.#isSymbolicLink#(#)#;#relPath#=#relPath#+#theFile#.#getName#(#)#;#currentPath#=#currentPath#+#remoteFileSep#+#theFile#.#getName#(#)#;#}#}#return#relPath#;#}##FTPFile#getFile#(#FTPFile#[#]#theFiles#,#String#lastpathelement#)#{#if#(#theFiles#==#null#)#{#return#null#;#}#for#(#int#fcount#=#0#;#fcount#<#theFiles#.#length#;#fcount#++#)#{#if#(#theFiles#[#fcount#]#!=#null#)#{#if#(#theFiles#[#fcount#]#.#getName#(#)#.#equals#(#lastpathelement#)#)#{#return#theFiles#[#fcount#]#;#}#else#if#(#!#isCaseSensitive#(#)#&&#theFiles#[#fcount#]#.#getName#(#)#.#equalsIgnoreCase#(#lastpathelement#)#)#{#return#theFiles#[#fcount#]#;#}#}#}#return#null#;#}##boolean#isDirectory#(#)#{#return#ftpFile#.#isDirectory#(#)#;#}##boolean#isSymbolicLink#(#)#{#return#ftpFile#.#isSymbolicLink#(#)#;#}##FTPClient#getClient#(#)#{#return#client#;#}##void#setCurpwd#(#String#curpwd#)#{#this#.#curpwd#=#curpwd#;#}##String#getCurpwd#(#)#{#return#curpwd#;#}##boolean#isTraverseSymlinks#(#)#throws#IOException#,#BuildException#{#if#(#!#relativePathCalculated#)#{#// getRelativePath also finds about symlinks#getRelativePath#(#)#;#}#return#traversesSymlinks#;#}##String#toString#(#)#{#return#"AntFtpFile: "#+#curpwd#+#"%"#+#ftpFile#;#}##String#getAbsolutePath#(#)#{#return#this#.#getCurpwd#(#)#;#}##String#getRelativePath#(#)#throws#BuildException#,#IOException#{#return#""#;#}##boolean#isFunctioningAsDirectory#(#FTPClient#ftp#,#String#dir#,#FTPFile#file#)#{#boolean#result#=#false#;#String#currentWorkingDir#=#null#;#if#(#file#.#isDirectory#(#)#)#{#return#true#;#}#else#if#(#file#.#isFile#(#)#)#{#return#false#;#}#try#{#currentWorkingDir#=#ftp#.#printWorkingDirectory#(#)#;#}#catch#(#IOException#ioe#)#{#getProject#(#)#.#log#(#"could not find current working directory "#+#dir#+#" while checking a symlink"#,#Project#.#MSG_DEBUG#)#;#}#if#(#currentWorkingDir#!=#null#)#{#try#{#result#=#ftp#.#changeWorkingDirectory#(#file#.#getLink#(#)#)#;#}#catch#(#IOException#ioe#)#{#getProject#(#)#.#log#(#"could not cd to "#+#file#.#getLink#(#)#+#" while checking a symlink"#,#Project#.#MSG_DEBUG#)#;#}#if#(#result#)#{#boolean#comeback#=#false#;#try#{#comeback#=#ftp#.#changeWorkingDirectory#(#currentWorkingDir#)#;#}#catch#(#IOException#ioe#)#{#getProject#(#)#.#log#(#"could not cd back to "#+#dir#+#" while checking a symlink"#,#Project#.#MSG_ERR#)#;#}#finally#{#if#(#!#comeback#)#{#throw#new#BuildException#(#"could not cd back to "#+#dir#+#" while checking a symlink"#)#;#}#}#}#}#return#result#;#}##boolean#isFunctioningAsFile#(#FTPClient#ftp#,#String#dir#,#FTPFile#file#)#{#if#(#file#.#isDirectory#(#)#)#{#return#false#;#}#else#if#(#file#.#isFile#(#)#)#{#return#true#;#}#return#!#isFunctioningAsDirectory#(#ftp#,#dir#,#file#)#;#}##void#setRemotedir#(#String#dir#)#{#this#.#remotedir#=#dir#;#}##void#setServer#(#String#server#)#{#this#.#server#=#server#;#}##void#setPort#(#int#port#)#{#this#.#port#=#port#;#}##void#setUserid#(#String#userid#)#{#this#.#userid#=#userid#;#}##void#setPassword#(#String#password#)#{#this#.#password#=#password#;#}##void#setAccount#(#String#pAccount#)#{#this#.#account#=#pAccount#;#}##void#setBinary#(#boolean#binary#)#{#this#.#binary#=#binary#;#}##void#setPassive#(#boolean#passive#)#{#this#.#passive#=#passive#;#}##void#setVerbose#(#boolean#verbose#)#{#this#.#verbose#=#verbose#;#}##void#setNewer#(#boolean#newer#)#{#this#.#newerOnly#=#newer#;#}##void#setTimeDiffMillis#(#long#timeDiffMillis#)#{#this#.#timeDiffMillis#=#timeDiffMillis#;#}##void#setTimeDiffAuto#(#boolean#timeDiffAuto#)#{#this#.#timeDiffAuto#=#timeDiffAuto#;#}##void#setPreserveLastModified#(#boolean#preserveLastModified#)#{#this#.#preserveLastModified#=#preserveLastModified#;#}##void#setDepends#(#boolean#depends#)#{#this#.#newerOnly#=#depends#;#}##void#setSeparator#(#String#separator#)#{#remoteFileSep#=#separator#;#}##void#setChmod#(#String#theMode#)#{#this#.#chmod#=#theMode#;#}##void#setUmask#(#String#theUmask#)#{#this#.#umask#=#theUmask#;#}##void#addFileset#(#FileSet#set#)#{#filesets#.#addElement#(#set#)#;#}##void#setAction#(#String#action#)#throws#BuildException#{#log#(#"DEPRECATED - The setAction(String) method has been deprecated."#+#" Use setAction(FTP.Action) instead."#)#;#Action#a#=#new#Action#(#)#;#a#.#setValue#(#action#)#;#this#.#action#=#a#.#getAction#(#)#;#}##void#setAction#(#Action#action#)#throws#BuildException#{#this#.#action#=#action#.#getAction#(#)#;#}##void#setListing#(#File#listing#)#{#this#.#listing#=#listing#;#}##void#setSkipFailedTransfers#(#boolean#skipFailedTransfers#)#{#this#.#skipFailedTransfers#=#skipFailedTransfers#;#}##void#setIgnoreNoncriticalErrors#(#boolean#ignoreNoncriticalErrors#)#{#this#.#ignoreNoncriticalErrors#=#ignoreNoncriticalErrors#;#}##void#configurationHasBeenSet#(#)#{#this#.#isConfigurationSet#=#true#;#}##void#setSystemTypeKey#(#FTPSystemType#systemKey#)#{#if#(#systemKey#!=#null#&&#!#systemKey#.#getValue#(#)#.#equals#(#""#)#)#{#this#.#systemTypeKey#=#systemKey#;#configurationHasBeenSet#(#)#;#}#}##void#setDefaultDateFormatConfig#(#String#defaultDateFormat#)#{#if#(#defaultDateFormat#!=#null#&&#!#defaultDateFormat#.#equals#(#""#)#)#{#this#.#defaultDateFormatConfig#=#defaultDateFormat#;#configurationHasBeenSet#(#)#;#}#}##void#setRecentDateFormatConfig#(#String#recentDateFormat#)#{#if#(#recentDateFormat#!=#null#&&#!#recentDateFormat#.#equals#(#""#)#)#{#this#.#recentDateFormatConfig#=#recentDateFormat#;#configurationHasBeenSet#(#)#;#}#}##void#setServerLanguageCodeConfig#(#LanguageCode#serverLanguageCode#)#{#if#(#serverLanguageCode#!=#null#&&#!#""#.#equals#(#serverLanguageCode#.#getValue#(#)#)#)#{#this#.#serverLanguageCodeConfig#=#serverLanguageCode#;#configurationHasBeenSet#(#)#;#}#}##void#setServerTimeZoneConfig#(#String#serverTimeZoneId#)#{#if#(#serverTimeZoneId#!=#null#&&#!#serverTimeZoneId#.#equals#(#""#)#)#{#this#.#serverTimeZoneConfig#=#serverTimeZoneId#;#configurationHasBeenSet#(#)#;#}#}##void#setShortMonthNamesConfig#(#String#shortMonthNames#)#{#if#(#shortMonthNames#!=#null#&&#!#shortMonthNames#.#equals#(#""#)#)#{#this#.#shortMonthNamesConfig#=#shortMonthNames#;#configurationHasBeenSet#(#)#;#}#}##void#setRetriesAllowed#(#String#retriesAllowed#)#{#if#(#"FOREVER"#.#equalsIgnoreCase#(#retriesAllowed#)#)#{#this#.#retriesAllowed#=#Retryable#.#RETRY_FOREVER#;#}#else#{#try#{#int#retries#=#Integer#.#parseInt#(#retriesAllowed#)#;#if#(#retries#<#Retryable#.#RETRY_FOREVER#)#{#throw#new#BuildException#(#"Invalid value for retriesAllowed attribute: "#+#retriesAllowed#)#;#}#this#.#retriesAllowed#=#retries#;#}#catch#(#NumberFormatException#px#)#{#throw#new#BuildException#(#"Invalid value for retriesAllowed attribute: "#+#retriesAllowed#)#;#}#}#}##String#getSystemTypeKey#(#)#{#return#systemTypeKey#.#getValue#(#)#;#}##String#getDefaultDateFormatConfig#(#)#{#return#defaultDateFormatConfig#;#}##String#getRecentDateFormatConfig#(#)#{#return#recentDateFormatConfig#;#}##String#getServerLanguageCodeConfig#(#)#{#return#serverLanguageCodeConfig#.#getValue#(#)#;#}##String#getServerTimeZoneConfig#(#)#{#return#serverTimeZoneConfig#;#}##String#getShortMonthNamesConfig#(#)#{#return#shortMonthNamesConfig#;#}##Granularity#getTimestampGranularity#(#)#{#return#timestampGranularity#;#}##void#setTimestampGranularity#(#Granularity#timestampGranularity#)#{#if#(#null#==#timestampGranularity#||#""#.#equals#(#timestampGranularity#.#getValue#(#)#)#)#{#return#;#}#this#.#timestampGranularity#=#timestampGranularity#;#}##void#setSiteCommand#(#String#siteCommand#)#{#this#.#siteCommand#=#siteCommand#;#}##void#setInitialSiteCommand#(#String#initialCommand#)#{#this#.#initialSiteCommand#=#initialCommand#;#}##void#setEnableRemoteVerification#(#boolean#b#)#{#enableRemoteVerification#=#b#;#}##void#checkAttributes#(#)#throws#BuildException#{#if#(#server#==#null#)#{#throw#new#BuildException#(#"server attribute must be set!"#)#;#}#if#(#userid#==#null#)#{#throw#new#BuildException#(#"userid attribute must be set!"#)#;#}#if#(#password#==#null#)#{#throw#new#BuildException#(#"password attribute must be set!"#)#;#}#if#(#(#action#==#LIST_FILES#)#&&#(#listing#==#null#)#)#{#throw#new#BuildException#(#"listing attribute must be set for list "#+#"action!"#)#;#}#if#(#action#==#MK_DIR#&&#remotedir#==#null#)#{#throw#new#BuildException#(#"remotedir attribute must be set for "#+#"mkdir action!"#)#;#}#if#(#action#==#CHMOD#&&#chmod#==#null#)#{#throw#new#BuildException#(#"chmod attribute must be set for chmod "#+#"action!"#)#;#}#if#(#action#==#SITE_CMD#&&#siteCommand#==#null#)#{#throw#new#BuildException#(#"sitecommand attribute must be set for site "#+#"action!"#)#;#}#if#(#this#.#isConfigurationSet#)#{#try#{#Class#.#forName#(#"org.apache.commons.net.ftp.FTPClientConfig"#)#;#}#catch#(#ClassNotFoundException#e#)#{#throw#new#BuildException#(#"commons-net.jar >= 1.4.0 is required for at least one"#+#" of the attributes specified."#)#;#}#}#}##void#executeRetryable#(#RetryHandler#h#,#Retryable#r#,#String#descr#)#throws#IOException#{#h#.#execute#(#r#,#descr#)#;#}##int#transferFiles#(#final#FTPClient#ftp#,#FileSet#fs#)#throws#IOException#,#BuildException#{#DirectoryScanner#ds#;#if#(#action#==#SEND_FILES#)#{#ds#=#fs#.#getDirectoryScanner#(#getProject#(#)#)#;#}#else#{#ds#=#new#FTPDirectoryScanner#(#ftp#)#;#fs#.#setupDirectoryScanner#(#ds#,#getProject#(#)#)#;#ds#.#setFollowSymlinks#(#fs#.#isFollowSymlinks#(#)#)#;#ds#.#scan#(#)#;#}#String#[#]#dsfiles#=#null#;#if#(#action#==#RM_DIR#)#{#dsfiles#=#ds#.#getIncludedDirectories#(#)#;#}#else#{#dsfiles#=#ds#.#getIncludedFiles#(#)#;#}#String#dir#=#null#;#if#(#(#ds#.#getBasedir#(#)#==#null#)#&&#(#(#action#==#SEND_FILES#)#||#(#action#==#GET_FILES#)#)#)#{#throw#new#BuildException#(#"the dir attribute must be set for send "#+#"and get actions"#)#;#}#else#{#if#(#(#action#==#SEND_FILES#)#||#(#action#==#GET_FILES#)#)#{#dir#=#ds#.#getBasedir#(#)#.#getAbsolutePath#(#)#;#}#}#// If we are doing a listing, we need the output stream created now.#BufferedWriter#bw#=#null#;#try#{#if#(#action#==#LIST_FILES#)#{#File#pd#=#listing#.#getParentFile#(#)#;#if#(#!#pd#.#exists#(#)#)#{#pd#.#mkdirs#(#)#;#}#bw#=#new#BufferedWriter#(#new#FileWriter#(#listing#)#)#;#}#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#if#(#action#==#RM_DIR#)#{#// to remove directories, start by the end of the list#// the trunk does not let itself be removed before the leaves#for#(#int#i#=#dsfiles#.#length#-#1#;#i#>=#0#;#i#--#)#{#final#String#dsfile#=#dsfiles#[#i#]#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#rmDir#(#ftp#,#dsfile#)#;#}#}#,#dsfile#)#;#}#}#else#{#final#BufferedWriter#fbw#=#bw#;#final#String#fdir#=#dir#;#if#(#this#.#newerOnly#)#{#this#.#granularityMillis#=#this#.#timestampGranularity#.#getMilliseconds#(#action#)#;#}#for#(#int#i#=#0#;#i#<#dsfiles#.#length#;#i#++#)#{#final#String#dsfile#=#dsfiles#[#i#]#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#switch#(#action#)#{#case#SEND_FILES#:#sendFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#GET_FILES#:#getFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#DEL_FILES#:#delFile#(#ftp#,#dsfile#)#;#break#;#case#LIST_FILES#:#listFile#(#ftp#,#fbw#,#dsfile#)#;#break#;#case#CHMOD#:#doSiteCommand#(#ftp#,#"chmod "#+#chmod#+#" "#+#resolveFile#(#dsfile#)#)#;#transferred#++#;#break#;#default#:#throw#new#BuildException#(#"unknown ftp action "#+#action#)#;#}#}#}#,#dsfile#)#;#}#}#}#finally#{#FileUtils#.#close#(#bw#)#;#}#return#dsfiles#.#length#;#}##void#execute#(#)#throws#IOException#{#rmDir#(#ftp#,#dsfile#)#;#}##void#execute#(#)#throws#IOException#{#switch#(#action#)#{#case#SEND_FILES#:#sendFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#GET_FILES#:#getFile#(#ftp#,#fdir#,#dsfile#)#;#break#;#case#DEL_FILES#:#delFile#(#ftp#,#dsfile#)#;#break#;#case#LIST_FILES#:#listFile#(#ftp#,#fbw#,#dsfile#)#;#break#;#case#CHMOD#:#doSiteCommand#(#ftp#,#"chmod "#+#chmod#+#" "#+#resolveFile#(#dsfile#)#)#;#transferred#++#;#break#;#default#:#throw#new#BuildException#(#"unknown ftp action "#+#action#)#;#}#}##void#transferFiles#(#FTPClient#ftp#)#throws#IOException#,#BuildException#{#transferred#=#0#;#skipped#=#0#;#if#(#filesets#.#size#(#)#==#0#)#{#throw#new#BuildException#(#"at least one fileset must be specified."#)#;#}#else#{#// get files from filesets#for#(#int#i#=#0#;#i#<#filesets#.#size#(#)#;#i#++#)#{#FileSet#fs#=#(#FileSet#)#filesets#.#elementAt#(#i#)#;#if#(#fs#!=#null#)#{#transferFiles#(#ftp#,#fs#)#;#}#}#}#log#(#transferred#+#" "#+#ACTION_TARGET_STRS#[#action#]#+#" "#+#COMPLETED_ACTION_STRS#[#action#]#)#;#if#(#skipped#!=#0#)#{#log#(#skipped#+#" "#+#ACTION_TARGET_STRS#[#action#]#+#" were not successfully "#+#COMPLETED_ACTION_STRS#[#action#]#)#;#}#}##String#resolveFile#(#String#file#)#{#return#file#.#replace#(#System#.#getProperty#(#"file.separator"#)#.#charAt#(#0#)#,#remoteFileSep#.#charAt#(#0#)#)#;#}##void#createParents#(#FTPClient#ftp#,#String#filename#)#throws#IOException#,#BuildException#{#File#dir#=#new#File#(#filename#)#;#if#(#dirCache#.#contains#(#dir#)#)#{#return#;#}#Vector#parents#=#new#Vector#(#)#;#String#dirname#;#while#(#(#dirname#=#dir#.#getParent#(#)#)#!=#null#)#{#File#checkDir#=#new#File#(#dirname#)#;#if#(#dirCache#.#contains#(#checkDir#)#)#{#break#;#}#dir#=#checkDir#;#parents#.#addElement#(#dir#)#;#}#// find first non cached dir#int#i#=#parents#.#size#(#)#-#1#;#if#(#i#>=#0#)#{#String#cwd#=#ftp#.#printWorkingDirectory#(#)#;#String#parent#=#dir#.#getParent#(#)#;#if#(#parent#!=#null#)#{#if#(#!#ftp#.#changeWorkingDirectory#(#resolveFile#(#parent#)#)#)#{#throw#new#BuildException#(#"could not change to "#+#"directory: "#+#ftp#.#getReplyString#(#)#)#;#}#}#while#(#i#>=#0#)#{#dir#=#(#File#)#parents#.#elementAt#(#i#--#)#;#// check if dir exists by trying to change into it.#if#(#!#ftp#.#changeWorkingDirectory#(#dir#.#getName#(#)#)#)#{#// could not change to it - try to create it#log#(#"creating remote directory "#+#resolveFile#(#dir#.#getPath#(#)#)#,#Project#.#MSG_VERBOSE#)#;#if#(#!#ftp#.#makeDirectory#(#dir#.#getName#(#)#)#)#{#handleMkDirFailure#(#ftp#)#;#}#if#(#!#ftp#.#changeWorkingDirectory#(#dir#.#getName#(#)#)#)#{#throw#new#BuildException#(#"could not change to "#+#"directory: "#+#ftp#.#getReplyString#(#)#)#;#}#}#dirCache#.#addElement#(#dir#)#;#}#ftp#.#changeWorkingDirectory#(#cwd#)#;#}#}##long#getTimeDiff#(#FTPClient#ftp#)#{#long#returnValue#=#0#;#File#tempFile#=#findFileName#(#ftp#)#;#try#{#// create a local temporary file#FILE_UTILS#.#createNewFile#(#tempFile#)#;#long#localTimeStamp#=#tempFile#.#lastModified#(#)#;#BufferedInputStream#instream#=#new#BufferedInputStream#(#new#FileInputStream#(#tempFile#)#)#;#ftp#.#storeFile#(#tempFile#.#getName#(#)#,#instream#)#;#instream#.#close#(#)#;#boolean#success#=#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#;#if#(#success#)#{#FTPFile#[#]#ftpFiles#=#ftp#.#listFiles#(#tempFile#.#getName#(#)#)#;#if#(#ftpFiles#.#length#==#1#)#{#long#remoteTimeStamp#=#ftpFiles#[#0#]#.#getTimestamp#(#)#.#getTime#(#)#.#getTime#(#)#;#returnValue#=#localTimeStamp#-#remoteTimeStamp#;#}#ftp#.#deleteFile#(#ftpFiles#[#0#]#.#getName#(#)#)#;#}#// delegate the deletion of the local temp file to the delete task#// because of race conditions occuring on Windows#Delete#mydelete#=#new#Delete#(#)#;#mydelete#.#bindToOwner#(#this#)#;#mydelete#.#setFile#(#tempFile#.#getCanonicalFile#(#)#)#;#mydelete#.#execute#(#)#;#}#catch#(#Exception#e#)#{#throw#new#BuildException#(#e#,#getLocation#(#)#)#;#}#return#returnValue#;#}##File#findFileName#(#FTPClient#ftp#)#{#FTPFile#[#]#theFiles#=#null#;#final#int#maxIterations#=#1000#;#for#(#int#counter#=#1#;#counter#<#maxIterations#;#counter#++#)#{#File#localFile#=#FILE_UTILS#.#createTempFile#(#"ant"#+#Integer#.#toString#(#counter#)#,#".tmp"#,#null#,#false#,#false#)#;#String#fileName#=#localFile#.#getName#(#)#;#boolean#found#=#false#;#try#{#if#(#theFiles#==#null#)#{#theFiles#=#ftp#.#listFiles#(#)#;#}#for#(#int#counter2#=#0#;#counter2#<#theFiles#.#length#;#counter2#++#)#{#if#(#theFiles#[#counter2#]#!=#null#&&#theFiles#[#counter2#]#.#getName#(#)#.#equals#(#fileName#)#)#{#found#=#true#;#break#;#}#}#}#catch#(#IOException#ioe#)#{#throw#new#BuildException#(#ioe#,#getLocation#(#)#)#;#}#if#(#!#found#)#{#localFile#.#deleteOnExit#(#)#;#return#localFile#;#}#}#return#null#;#}##boolean#isUpToDate#(#FTPClient#ftp#,#File#localFile#,#String#remoteFile#)#throws#IOException#,#BuildException#{#log#(#"checking date for "#+#remoteFile#,#Project#.#MSG_VERBOSE#)#;#FTPFile#[#]#files#=#ftp#.#listFiles#(#remoteFile#)#;#// For Microsoft's Ftp-Service an Array with length 0 is#// returned if configured to return listings in "MS-DOS"-Format#if#(#files#==#null#||#files#.#length#==#0#)#{#// If we are sending files, then assume out of date.#// If we are getting files, then throw an error#if#(#action#==#SEND_FILES#)#{#log#(#"Could not date test remote file: "#+#remoteFile#+#"assuming out of date."#,#Project#.#MSG_VERBOSE#)#;#return#false#;#}#else#{#throw#new#BuildException#(#"could not date test remote file: "#+#ftp#.#getReplyString#(#)#)#;#}#}#long#remoteTimestamp#=#files#[#0#]#.#getTimestamp#(#)#.#getTime#(#)#.#getTime#(#)#;#long#localTimestamp#=#localFile#.#lastModified#(#)#;#long#adjustedRemoteTimestamp#=#remoteTimestamp#+#this#.#timeDiffMillis#+#this#.#granularityMillis#;#StringBuffer#msg#;#synchronized#(#TIMESTAMP_LOGGING_SDF#)#{#msg#=#new#StringBuffer#(#"   ["#)#.#append#(#TIMESTAMP_LOGGING_SDF#.#format#(#new#Date#(#localTimestamp#)#)#)#.#append#(#"] local"#)#;#}#log#(#msg#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#synchronized#(#TIMESTAMP_LOGGING_SDF#)#{#msg#=#new#StringBuffer#(#"   ["#)#.#append#(#TIMESTAMP_LOGGING_SDF#.#format#(#new#Date#(#adjustedRemoteTimestamp#)#)#)#.#append#(#"] remote"#)#;#}#if#(#remoteTimestamp#!=#adjustedRemoteTimestamp#)#{#synchronized#(#TIMESTAMP_LOGGING_SDF#)#{#msg#.#append#(#" - (raw: "#)#.#append#(#TIMESTAMP_LOGGING_SDF#.#format#(#new#Date#(#remoteTimestamp#)#)#)#.#append#(#")"#)#;#}#}#log#(#msg#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#if#(#this#.#action#==#SEND_FILES#)#{#return#adjustedRemoteTimestamp#>=#localTimestamp#;#}#else#{#return#localTimestamp#>=#adjustedRemoteTimestamp#;#}#}##void#doSiteCommand#(#FTPClient#ftp#,#String#theCMD#)#throws#IOException#,#BuildException#{#boolean#rc#;#String#[#]#myReply#=#null#;#log#(#"Doing Site Command: "#+#theCMD#,#Project#.#MSG_VERBOSE#)#;#rc#=#ftp#.#sendSiteCommand#(#theCMD#)#;#if#(#!#rc#)#{#log#(#"Failed to issue Site Command: "#+#theCMD#,#Project#.#MSG_WARN#)#;#}#else#{#myReply#=#ftp#.#getReplyStrings#(#)#;#for#(#int#x#=#0#;#x#<#myReply#.#length#;#x#++#)#{#if#(#myReply#[#x#]#.#indexOf#(#"200"#)#==#-#1#)#{#log#(#myReply#[#x#]#,#Project#.#MSG_WARN#)#;#}#}#}#}##void#sendFile#(#FTPClient#ftp#,#String#dir#,#String#filename#)#throws#IOException#,#BuildException#{#InputStream#instream#=#null#;#try#{#// XXX - why not simply new File(dir, filename)?#File#file#=#getProject#(#)#.#resolveFile#(#new#File#(#dir#,#filename#)#.#getPath#(#)#)#;#if#(#newerOnly#&&#isUpToDate#(#ftp#,#file#,#resolveFile#(#filename#)#)#)#{#return#;#}#if#(#verbose#)#{#log#(#"transferring "#+#file#.#getAbsolutePath#(#)#)#;#}#instream#=#new#BufferedInputStream#(#new#FileInputStream#(#file#)#)#;#createParents#(#ftp#,#filename#)#;#ftp#.#storeFile#(#resolveFile#(#filename#)#,#instream#)#;#boolean#success#=#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#;#if#(#!#success#)#{#String#s#=#"could not put file: "#+#ftp#.#getReplyString#(#)#;#if#(#skipFailedTransfers#)#{#log#(#s#,#Project#.#MSG_WARN#)#;#skipped#++#;#}#else#{#throw#new#BuildException#(#s#)#;#}#}#else#{#// see if we should issue a chmod command#if#(#chmod#!=#null#)#{#doSiteCommand#(#ftp#,#"chmod "#+#chmod#+#" "#+#resolveFile#(#filename#)#)#;#}#log#(#"File "#+#file#.#getAbsolutePath#(#)#+#" copied to "#+#server#,#Project#.#MSG_VERBOSE#)#;#transferred#++#;#}#}#finally#{#FileUtils#.#close#(#instream#)#;#}#}##void#delFile#(#FTPClient#ftp#,#String#filename#)#throws#IOException#,#BuildException#{#if#(#verbose#)#{#log#(#"deleting "#+#filename#)#;#}#if#(#!#ftp#.#deleteFile#(#resolveFile#(#filename#)#)#)#{#String#s#=#"could not delete file: "#+#ftp#.#getReplyString#(#)#;#if#(#skipFailedTransfers#)#{#log#(#s#,#Project#.#MSG_WARN#)#;#skipped#++#;#}#else#{#throw#new#BuildException#(#s#)#;#}#}#else#{#log#(#"File "#+#filename#+#" deleted from "#+#server#,#Project#.#MSG_VERBOSE#)#;#transferred#++#;#}#}##void#rmDir#(#FTPClient#ftp#,#String#dirname#)#throws#IOException#,#BuildException#{#if#(#verbose#)#{#log#(#"removing "#+#dirname#)#;#}#if#(#!#ftp#.#removeDirectory#(#resolveFile#(#dirname#)#)#)#{#String#s#=#"could not remove directory: "#+#ftp#.#getReplyString#(#)#;#if#(#skipFailedTransfers#)#{#log#(#s#,#Project#.#MSG_WARN#)#;#skipped#++#;#}#else#{#throw#new#BuildException#(#s#)#;#}#}#else#{#log#(#"Directory "#+#dirname#+#" removed from "#+#server#,#Project#.#MSG_VERBOSE#)#;#transferred#++#;#}#}##void#getFile#(#FTPClient#ftp#,#String#dir#,#String#filename#)#throws#IOException#,#BuildException#{#OutputStream#outstream#=#null#;#try#{#File#file#=#getProject#(#)#.#resolveFile#(#new#File#(#dir#,#filename#)#.#getPath#(#)#)#;#if#(#newerOnly#&&#isUpToDate#(#ftp#,#file#,#resolveFile#(#filename#)#)#)#{#return#;#}#if#(#verbose#)#{#log#(#"transferring "#+#filename#+#" to "#+#file#.#getAbsolutePath#(#)#)#;#}#File#pdir#=#file#.#getParentFile#(#)#;#if#(#!#pdir#.#exists#(#)#)#{#pdir#.#mkdirs#(#)#;#}#outstream#=#new#BufferedOutputStream#(#new#FileOutputStream#(#file#)#)#;#ftp#.#retrieveFile#(#resolveFile#(#filename#)#,#outstream#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#String#s#=#"could not get file: "#+#ftp#.#getReplyString#(#)#;#if#(#skipFailedTransfers#)#{#log#(#s#,#Project#.#MSG_WARN#)#;#skipped#++#;#}#else#{#throw#new#BuildException#(#s#)#;#}#}#else#{#log#(#"File "#+#file#.#getAbsolutePath#(#)#+#" copied from "#+#server#,#Project#.#MSG_VERBOSE#)#;#transferred#++#;#if#(#preserveLastModified#)#{#outstream#.#close#(#)#;#outstream#=#null#;#FTPFile#[#]#remote#=#ftp#.#listFiles#(#resolveFile#(#filename#)#)#;#if#(#remote#.#length#>#0#)#{#FILE_UTILS#.#setFileLastModified#(#file#,#remote#[#0#]#.#getTimestamp#(#)#.#getTime#(#)#.#getTime#(#)#)#;#}#}#}#}#finally#{#FileUtils#.#close#(#outstream#)#;#}#}##void#listFile#(#FTPClient#ftp#,#BufferedWriter#bw#,#String#filename#)#throws#IOException#,#BuildException#{#if#(#verbose#)#{#log#(#"listing "#+#filename#)#;#}#FTPFile#[#]#ftpfiles#=#ftp#.#listFiles#(#resolveFile#(#filename#)#)#;#if#(#ftpfiles#!=#null#&&#ftpfiles#.#length#>#0#)#{#bw#.#write#(#ftpfiles#[#0#]#.#toString#(#)#)#;#bw#.#newLine#(#)#;#transferred#++#;#}#}##void#makeRemoteDir#(#FTPClient#ftp#,#String#dir#)#throws#IOException#,#BuildException#{#String#workingDirectory#=#ftp#.#printWorkingDirectory#(#)#;#if#(#verbose#)#{#if#(#dir#.#indexOf#(#"/"#)#==#0#||#workingDirectory#==#null#)#{#log#(#"Creating directory: "#+#dir#+#" in /"#)#;#}#else#{#log#(#"Creating directory: "#+#dir#+#" in "#+#workingDirectory#)#;#}#}#if#(#dir#.#indexOf#(#"/"#)#==#0#)#{#ftp#.#changeWorkingDirectory#(#"/"#)#;#}#String#subdir#=#""#;#StringTokenizer#st#=#new#StringTokenizer#(#dir#,#"/"#)#;#while#(#st#.#hasMoreTokens#(#)#)#{#subdir#=#st#.#nextToken#(#)#;#log#(#"Checking "#+#subdir#,#Project#.#MSG_DEBUG#)#;#if#(#!#ftp#.#changeWorkingDirectory#(#subdir#)#)#{#if#(#!#ftp#.#makeDirectory#(#subdir#)#)#{#// codes 521, 550 and 553 can be produced by FTP Servers#//  to indicate that an attempt to create a directory has#//  failed because the directory already exists.#int#rc#=#ftp#.#getReplyCode#(#)#;#if#(#!#(#ignoreNoncriticalErrors#&&#(#rc#==#FTPReply#.#CODE_550#||#rc#==#FTPReply#.#CODE_553#||#rc#==#CODE_521#)#)#)#{#throw#new#BuildException#(#"could not create directory: "#+#ftp#.#getReplyString#(#)#)#;#}#if#(#verbose#)#{#log#(#"Directory already exists"#)#;#}#}#else#{#if#(#verbose#)#{#log#(#"Directory created OK"#)#;#}#ftp#.#changeWorkingDirectory#(#subdir#)#;#}#}#}#if#(#workingDirectory#!=#null#)#{#ftp#.#changeWorkingDirectory#(#workingDirectory#)#;#}#}##void#handleMkDirFailure#(#FTPClient#ftp#)#throws#BuildException#{#int#rc#=#ftp#.#getReplyCode#(#)#;#if#(#!#(#ignoreNoncriticalErrors#&&#(#rc#==#FTPReply#.#CODE_550#||#rc#==#FTPReply#.#CODE_553#||#rc#==#CODE_521#)#)#)#{#throw#new#BuildException#(#"could not create directory: "#+#ftp#.#getReplyString#(#)#)#;#}#}##void#execute#(#)#throws#BuildException#{#checkAttributes#(#)#;#FTPClient#ftp#=#null#;#try#{#log#(#"Opening FTP connection to "#+#server#,#Project#.#MSG_VERBOSE#)#;#ftp#=#new#FTPClient#(#)#;#if#(#this#.#isConfigurationSet#)#{#ftp#=#FTPConfigurator#.#configure#(#ftp#,#this#)#;#}#ftp#.#setRemoteVerificationEnabled#(#enableRemoteVerification#)#;#ftp#.#connect#(#server#,#port#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"FTP connection failed: "#+#ftp#.#getReplyString#(#)#)#;#}#log#(#"connected"#,#Project#.#MSG_VERBOSE#)#;#log#(#"logging in to FTP server"#,#Project#.#MSG_VERBOSE#)#;#if#(#(#this#.#account#!=#null#&&#!#ftp#.#login#(#userid#,#password#,#account#)#)#||#(#this#.#account#==#null#&&#!#ftp#.#login#(#userid#,#password#)#)#)#{#throw#new#BuildException#(#"Could not login to FTP server"#)#;#}#log#(#"login succeeded"#,#Project#.#MSG_VERBOSE#)#;#if#(#binary#)#{#ftp#.#setFileType#(#org#.#apache#.#commons#.#net#.#ftp#.#FTP#.#BINARY_FILE_TYPE#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not set transfer type: "#+#ftp#.#getReplyString#(#)#)#;#}#}#else#{#ftp#.#setFileType#(#org#.#apache#.#commons#.#net#.#ftp#.#FTP#.#ASCII_FILE_TYPE#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not set transfer type: "#+#ftp#.#getReplyString#(#)#)#;#}#}#if#(#passive#)#{#log#(#"entering passive mode"#,#Project#.#MSG_VERBOSE#)#;#ftp#.#enterLocalPassiveMode#(#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not enter into passive "#+#"mode: "#+#ftp#.#getReplyString#(#)#)#;#}#}#// If an initial command was configured then send it.#// Some FTP servers offer different modes of operation,#// E.G. switching between a UNIX file system mode and#// a legacy file system.#if#(#this#.#initialSiteCommand#!=#null#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#initialSiteCommand#)#;#}#}#,#"initial site command: "#+#this#.#initialSiteCommand#)#;#}#// For a unix ftp server you can set the default mask for all files#// created.#if#(#umask#!=#null#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#"umask "#+#umask#)#;#}#}#,#"umask "#+#umask#)#;#}#// If the action is MK_DIR, then the specified remote#// directory is the directory to create.#if#(#action#==#MK_DIR#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#makeRemoteDir#(#lftp#,#remotedir#)#;#}#}#,#remotedir#)#;#}#else#if#(#action#==#SITE_CMD#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#siteCommand#)#;#}#}#,#"Site Command: "#+#this#.#siteCommand#)#;#}#else#{#if#(#remotedir#!=#null#)#{#log#(#"changing the remote directory to "#+#remotedir#,#Project#.#MSG_VERBOSE#)#;#ftp#.#changeWorkingDirectory#(#remotedir#)#;#if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not change remote "#+#"directory: "#+#ftp#.#getReplyString#(#)#)#;#}#}#if#(#newerOnly#&&#timeDiffAuto#)#{#// in this case we want to find how much time span there is between local#// and remote#timeDiffMillis#=#getTimeDiff#(#ftp#)#;#}#log#(#ACTION_STRS#[#action#]#+#" "#+#ACTION_TARGET_STRS#[#action#]#)#;#transferFiles#(#ftp#)#;#}#}#catch#(#IOException#ex#)#{#throw#new#BuildException#(#"error during FTP transfer: "#+#ex#,#ex#)#;#}#finally#{#if#(#ftp#!=#null#&&#ftp#.#isConnected#(#)#)#{#try#{#log#(#"disconnecting"#,#Project#.#MSG_VERBOSE#)#;#ftp#.#logout#(#)#;#ftp#.#disconnect#(#)#;#}#catch#(#IOException#ex#)#{#// ignore it#}#}#}#}##void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#initialSiteCommand#)#;#}##void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#"umask "#+#umask#)#;#}##void#execute#(#)#throws#IOException#{#makeRemoteDir#(#lftp#,#remotedir#)#;#}##void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#siteCommand#)#;#}##String#[#]#getValues#(#)#{#return#VALID_ACTIONS#;#}##int#getAction#(#)#{#String#actionL#=#getValue#(#)#.#toLowerCase#(#Locale#.#US#)#;#if#(#actionL#.#equals#(#"send"#)#||#actionL#.#equals#(#"put"#)#)#{#return#SEND_FILES#;#}#else#if#(#actionL#.#equals#(#"recv"#)#||#actionL#.#equals#(#"get"#)#)#{#return#GET_FILES#;#}#else#if#(#actionL#.#equals#(#"del"#)#||#actionL#.#equals#(#"delete"#)#)#{#return#DEL_FILES#;#}#else#if#(#actionL#.#equals#(#"list"#)#)#{#return#LIST_FILES#;#}#else#if#(#actionL#.#equals#(#"chmod"#)#)#{#return#CHMOD#;#}#else#if#(#actionL#.#equals#(#"mkdir"#)#)#{#return#MK_DIR#;#}#else#if#(#actionL#.#equals#(#"rmdir"#)#)#{#return#RM_DIR#;#}#else#if#(#actionL#.#equals#(#"site"#)#)#{#return#SITE_CMD#;#}#return#SEND_FILES#;#}##String#[#]#getValues#(#)#{#return#VALID_GRANULARITIES#;#}##long#getMilliseconds#(#int#action#)#{#String#granularityU#=#getValue#(#)#.#toUpperCase#(#Locale#.#US#)#;#if#(#""#.#equals#(#granularityU#)#)#{#if#(#action#==#SEND_FILES#)#{#return#GRANULARITY_MINUTE#;#}#}#else#if#(#"MINUTE"#.#equals#(#granularityU#)#)#{#return#GRANULARITY_MINUTE#;#}#return#0L#;#}##Granularity#getDefault#(#)#{#Granularity#g#=#new#Granularity#(#)#;#g#.#setValue#(#""#)#;#return#g#;#}##String#[#]#getValues#(#)#{#return#VALID_SYSTEM_TYPES#;#}##FTPSystemType#getDefault#(#)#{#FTPSystemType#ftpst#=#new#FTPSystemType#(#)#;#ftpst#.#setValue#(#""#)#;#return#ftpst#;#}##String#[#]#getValidLanguageCodes#(#)#{#Collection#c#=#FTPClientConfig#.#getSupportedLanguageCodes#(#)#;#String#[#]#ret#=#new#String#[#c#.#size#(#)#+#1#]#;#int#i#=#0#;#ret#[#i#++#]#=#""#;#for#(#Iterator#it#=#c#.#iterator#(#)#;#it#.#hasNext#(#)#;#i#++#)#{#ret#[#i#]#=#(#String#)#it#.#next#(#)#;#}#return#ret#;#}##String#[#]#getValues#(#)#{#return#VALID_LANGUAGE_CODES#;#}##LanguageCode#getDefault#(#)#{#LanguageCode#lc#=#new#LanguageCode#(#)#;#lc#.#setValue#(#""#)#;#return#lc#;#}##