int#runCmd#(#Commandline#cmd#,#ExecuteStreamHandler#out#)#{#try#{#Project#aProj#=#getProject#(#)#;#Execute#exe#=#new#Execute#(#out#)#;#exe#.#setAntRun#(#aProj#)#;#exe#.#setWorkingDirectory#(#aProj#.#getBaseDir#(#)#)#;#exe#.#setCommandline#(#cmd#.#getCommandline#(#)#)#;#return#exe#.#execute#(#)#;#}#catch#(#java#.#io#.#IOException#e#)#{#String#msg#=#"Failed executing: "#+#cmd#.#toString#(#)#+#". Exception: "#+#e#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#}##String#getExecutable#(#String#exe#)#{#StringBuffer#correctedExe#=#new#StringBuffer#(#)#;#if#(#getPvcsbin#(#)#!=#null#)#{#if#(#pvcsbin#.#endsWith#(#File#.#separator#)#)#{#correctedExe#.#append#(#pvcsbin#)#;#}#else#{#correctedExe#.#append#(#pvcsbin#)#.#append#(#File#.#separator#)#;#}#}#return#correctedExe#.#append#(#exe#)#.#toString#(#)#;#}##void#execute#(#)#throws#org#.#apache#.#tools#.#ant#.#BuildException#{#int#result#=#0#;#if#(#repository#==#null#||#repository#.#trim#(#)#.#equals#(#""#)#)#{#throw#new#BuildException#(#"Required argument repository not specified"#)#;#}#// Check workspace exists#// Launch PCLI listversionedfiles -z -aw#// Capture output#// build the command line from what we got the format is#Commandline#commandLine#=#new#Commandline#(#)#;#commandLine#.#setExecutable#(#getExecutable#(#PCLI_EXE#)#)#;#commandLine#.#createArgument#(#)#.#setValue#(#"lvf"#)#;#commandLine#.#createArgument#(#)#.#setValue#(#"-z"#)#;#commandLine#.#createArgument#(#)#.#setValue#(#"-aw"#)#;#if#(#getWorkspace#(#)#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-sp"#+#getWorkspace#(#)#)#;#}#commandLine#.#createArgument#(#)#.#setValue#(#"-pr"#+#getRepository#(#)#)#;#String#uid#=#getUserId#(#)#;#if#(#uid#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-id"#+#uid#)#;#}#// default pvcs project is "/"#if#(#getPvcsproject#(#)#==#null#&&#getPvcsprojects#(#)#.#isEmpty#(#)#)#{#pvcsProject#=#"/"#;#}#if#(#getPvcsproject#(#)#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#getPvcsproject#(#)#)#;#}#if#(#!#getPvcsprojects#(#)#.#isEmpty#(#)#)#{#Enumeration#e#=#getPvcsprojects#(#)#.#elements#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#String#projectName#=#(#(#PvcsProject#)#e#.#nextElement#(#)#)#.#getName#(#)#;#if#(#projectName#==#null#||#(#projectName#.#trim#(#)#)#.#equals#(#""#)#)#{#throw#new#BuildException#(#"name is a required attribute "#+#"of pvcsproject"#)#;#}#commandLine#.#createArgument#(#)#.#setValue#(#projectName#)#;#}#}#File#tmp#=#null#;#File#tmp2#=#null#;#try#{#Random#rand#=#new#Random#(#System#.#currentTimeMillis#(#)#)#;#tmp#=#new#File#(#"pvcs_ant_"#+#rand#.#nextLong#(#)#+#".log"#)#;#FileOutputStream#fos#=#new#FileOutputStream#(#tmp#)#;#tmp2#=#new#File#(#"pvcs_ant_"#+#rand#.#nextLong#(#)#+#".log"#)#;#log#(#commandLine#.#describeCommand#(#)#,#Project#.#MSG_VERBOSE#)#;#try#{#result#=#runCmd#(#commandLine#,#new#PumpStreamHandler#(#fos#,#new#LogOutputStream#(#this#,#Project#.#MSG_WARN#)#)#)#;#}#finally#{#FileUtils#.#close#(#fos#)#;#}#if#(#Execute#.#isFailure#(#result#)#&&#!#ignorerc#)#{#String#msg#=#"Failed executing: "#+#commandLine#.#toString#(#)#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#if#(#!#tmp#.#exists#(#)#)#{#throw#new#BuildException#(#"Communication between ant and pvcs "#+#"failed. No output generated from executing PVCS "#+#"commandline interface \"pcli\" and \"get\""#)#;#}#// Create folders in workspace#log#(#"Creating folders"#,#Project#.#MSG_INFO#)#;#createFolders#(#tmp#)#;#// Massage PCLI lvf output transforming '\' to '/' so get command works appropriately#massagePCLI#(#tmp#,#tmp2#)#;#// Launch get on output captured from PCLI lvf#commandLine#.#clearArgs#(#)#;#commandLine#.#setExecutable#(#getExecutable#(#GET_EXE#)#)#;#if#(#getConfig#(#)#!=#null#&&#getConfig#(#)#.#length#(#)#>#0#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-c"#+#getConfig#(#)#)#;#}#if#(#getForce#(#)#!=#null#&&#getForce#(#)#.#equals#(#"yes"#)#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-Y"#)#;#}#else#{#commandLine#.#createArgument#(#)#.#setValue#(#"-N"#)#;#}#if#(#getPromotiongroup#(#)#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-G"#+#getPromotiongroup#(#)#)#;#}#else#{#if#(#getLabel#(#)#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-v"#+#getLabel#(#)#)#;#}#else#{#if#(#getRevision#(#)#!=#null#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-r"#+#getRevision#(#)#)#;#}#}#}#if#(#updateOnly#)#{#commandLine#.#createArgument#(#)#.#setValue#(#"-U"#)#;#}#commandLine#.#createArgument#(#)#.#setValue#(#"@"#+#tmp2#.#getAbsolutePath#(#)#)#;#log#(#"Getting files"#,#Project#.#MSG_INFO#)#;#log#(#"Executing "#+#commandLine#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#result#=#runCmd#(#commandLine#,#new#LogStreamHandler#(#this#,#Project#.#MSG_INFO#,#Project#.#MSG_WARN#)#)#;#if#(#result#!=#0#&&#!#ignorerc#)#{#String#msg#=#"Failed executing: "#+#commandLine#.#toString#(#)#+#". Return code was "#+#result#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#}#catch#(#FileNotFoundException#e#)#{#String#msg#=#"Failed executing: "#+#commandLine#.#toString#(#)#+#". Exception: "#+#e#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#catch#(#IOException#e#)#{#String#msg#=#"Failed executing: "#+#commandLine#.#toString#(#)#+#". Exception: "#+#e#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#catch#(#ParseException#e#)#{#String#msg#=#"Failed executing: "#+#commandLine#.#toString#(#)#+#". Exception: "#+#e#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#getLocation#(#)#)#;#}#finally#{#if#(#tmp#!=#null#)#{#tmp#.#delete#(#)#;#}#if#(#tmp2#!=#null#)#{#tmp2#.#delete#(#)#;#}#}#}##void#createFolders#(#File#file#)#throws#IOException#,#ParseException#{#BufferedReader#in#=#null#;#try#{#in#=#new#BufferedReader#(#new#FileReader#(#file#)#)#;#MessageFormat#mf#=#new#MessageFormat#(#getFilenameFormat#(#)#)#;#String#line#=#in#.#readLine#(#)#;#while#(#line#!=#null#)#{#log#(#"Considering \""#+#line#+#"\""#,#Project#.#MSG_VERBOSE#)#;#if#(#line#.#startsWith#(#"\"\\"#)#// Checking for "\#||#line#.#startsWith#(#"\"/"#)#// or           "/#// or           "X:\...#||#(#line#.#length#(#)#>#POS_3#&&#line#.#startsWith#(#"\""#)#&&#Character#.#isLetter#(#line#.#charAt#(#POS_1#)#)#&&#String#.#valueOf#(#line#.#charAt#(#POS_2#)#)#.#equals#(#":"#)#&&#String#.#valueOf#(#line#.#charAt#(#POS_3#)#)#.#equals#(#"\\"#)#)#)#{#Object#[#]#objs#=#mf#.#parse#(#line#)#;#String#f#=#(#String#)#objs#[#1#]#;#// Extract the name of the directory from the filename#int#index#=#f#.#lastIndexOf#(#File#.#separator#)#;#if#(#index#>#-#1#)#{#File#dir#=#new#File#(#f#.#substring#(#0#,#index#)#)#;#if#(#!#dir#.#exists#(#)#)#{#log#(#"Creating "#+#dir#.#getAbsolutePath#(#)#,#Project#.#MSG_VERBOSE#)#;#if#(#dir#.#mkdirs#(#)#)#{#log#(#"Created "#+#dir#.#getAbsolutePath#(#)#,#Project#.#MSG_INFO#)#;#}#else#{#log#(#"Failed to create "#+#dir#.#getAbsolutePath#(#)#,#Project#.#MSG_INFO#)#;#}#}#else#{#log#(#dir#.#getAbsolutePath#(#)#+#" exists. Skipping"#,#Project#.#MSG_VERBOSE#)#;#}#}#else#{#log#(#"File separator problem with "#+#line#,#Project#.#MSG_WARN#)#;#}#}#else#{#log#(#"Skipped \""#+#line#+#"\""#,#Project#.#MSG_VERBOSE#)#;#}#line#=#in#.#readLine#(#)#;#}#}#finally#{#FileUtils#.#close#(#in#)#;#}#}##void#massagePCLI#(#File#in#,#File#out#)#throws#IOException#{#BufferedReader#inReader#=#null#;#BufferedWriter#outWriter#=#null#;#try#{#inReader#=#new#BufferedReader#(#new#FileReader#(#in#)#)#;#outWriter#=#new#BufferedWriter#(#new#FileWriter#(#out#)#)#;#String#s#=#null#;#while#(#(#s#=#inReader#.#readLine#(#)#)#!=#null#)#{#String#sNormal#=#s#.#replace#(#'\\'#,#'/'#)#;#outWriter#.#write#(#sNormal#)#;#outWriter#.#newLine#(#)#;#}#}#finally#{#FileUtils#.#close#(#inReader#)#;#FileUtils#.#close#(#outWriter#)#;#}#}##String#getRepository#(#)#{#return#repository#;#}##String#getFilenameFormat#(#)#{#return#filenameFormat#;#}##void#setFilenameFormat#(#String#f#)#{#filenameFormat#=#f#;#}##String#getLineStart#(#)#{#return#lineStart#;#}##void#setLineStart#(#String#l#)#{#lineStart#=#l#;#}##void#setRepository#(#String#repo#)#{#repository#=#repo#;#}##String#getPvcsproject#(#)#{#return#pvcsProject#;#}##void#setPvcsproject#(#String#prj#)#{#pvcsProject#=#prj#;#}##Vector#getPvcsprojects#(#)#{#return#pvcsProjects#;#}##String#getWorkspace#(#)#{#return#workspace#;#}##void#setWorkspace#(#String#ws#)#{#workspace#=#ws#;#}##String#getPvcsbin#(#)#{#return#pvcsbin#;#}##void#setPvcsbin#(#String#bin#)#{#pvcsbin#=#bin#;#}##String#getForce#(#)#{#return#force#;#}##void#setForce#(#String#f#)#{#if#(#f#!=#null#&&#f#.#equalsIgnoreCase#(#"yes"#)#)#{#force#=#"yes"#;#}#else#{#force#=#"no"#;#}#}##String#getPromotiongroup#(#)#{#return#promotiongroup#;#}##void#setPromotiongroup#(#String#w#)#{#promotiongroup#=#w#;#}##String#getLabel#(#)#{#return#label#;#}##void#setLabel#(#String#l#)#{#label#=#l#;#}##String#getRevision#(#)#{#return#revision#;#}##void#setRevision#(#String#r#)#{#revision#=#r#;#}##boolean#getIgnoreReturnCode#(#)#{#return#ignorerc#;#}##void#setIgnoreReturnCode#(#boolean#b#)#{#ignorerc#=#b#;#}##void#addPvcsproject#(#PvcsProject#p#)#{#pvcsProjects#.#addElement#(#p#)#;#}##boolean#getUpdateOnly#(#)#{#return#updateOnly#;#}##void#setUpdateOnly#(#boolean#l#)#{#updateOnly#=#l#;#}##String#getConfig#(#)#{#return#config#;#}##void#setConfig#(#File#f#)#{#config#=#f#.#toString#(#)#;#}##String#getUserId#(#)#{#return#userId#;#}##void#setUserId#(#String#u#)#{#userId#=#u#;#}##