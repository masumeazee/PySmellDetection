void#setPort#(#int#port#)#{#this#.#port#=#port#;#}##void#from#(#String#from#)#throws#IOException#{#sendFrom#(#from#)#;#this#.#from#=#from#;#}##void#replyto#(#String#rto#)#{#this#.#replyto#.#addElement#(#rto#)#;#}##void#to#(#String#to#)#throws#IOException#{#sendRcpt#(#to#)#;#this#.#to#.#addElement#(#to#)#;#}##void#cc#(#String#cc#)#throws#IOException#{#sendRcpt#(#cc#)#;#this#.#cc#.#addElement#(#cc#)#;#}##void#bcc#(#String#bcc#)#throws#IOException#{#sendRcpt#(#bcc#)#;#// No need to keep track of Bcc'd addresses#}##void#setSubject#(#String#subj#)#{#setHeader#(#"Subject"#,#subj#)#;#}##void#setHeader#(#String#name#,#String#value#)#{#// Blindly trust the user doesn't set any invalid headers#headersKeys#.#add#(#name#)#;#headersValues#.#add#(#value#)#;#}##PrintStream#getPrintStream#(#)#throws#IOException#{#setFromHeader#(#)#;#setReplyToHeader#(#)#;#setToHeader#(#)#;#setCcHeader#(#)#;#setHeader#(#"X-Mailer"#,#"org.apache.tools.mail.MailMessage (ant.apache.org)"#)#;#sendData#(#)#;#flushHeaders#(#)#;#return#out#;#}##void#setFromHeader#(#)#{#setHeader#(#"From"#,#from#)#;#}##void#setReplyToHeader#(#)#{#if#(#!#replyto#.#isEmpty#(#)#)#{#setHeader#(#"Reply-To"#,#vectorToList#(#replyto#)#)#;#}#}##void#setToHeader#(#)#{#if#(#!#to#.#isEmpty#(#)#)#{#setHeader#(#"To"#,#vectorToList#(#to#)#)#;#}#}##void#setCcHeader#(#)#{#if#(#!#cc#.#isEmpty#(#)#)#{#setHeader#(#"Cc"#,#vectorToList#(#cc#)#)#;#}#}##String#vectorToList#(#Vector#v#)#{#StringBuffer#buf#=#new#StringBuffer#(#)#;#Enumeration#e#=#v#.#elements#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#buf#.#append#(#e#.#nextElement#(#)#)#;#if#(#e#.#hasMoreElements#(#)#)#{#buf#.#append#(#", "#)#;#}#}#return#buf#.#toString#(#)#;#}##void#flushHeaders#(#)#throws#IOException#{#// RFC 822 s4.1:#//   "Header fields are NOT required to occur in any particular order,#//    except that the message body MUST occur AFTER the headers"#// (the same section specifies a reccommended order, which we ignore)#for#(#int#i#=#0#;#i#<#headersKeys#.#size#(#)#;#i#++#)#{#String#name#=#(#String#)#headersKeys#.#elementAt#(#i#)#;#String#value#=#(#String#)#headersValues#.#elementAt#(#i#)#;#out#.#println#(#name#+#": "#+#value#)#;#}#out#.#println#(#)#;#out#.#flush#(#)#;#}##void#sendAndClose#(#)#throws#IOException#{#try#{#sendDot#(#)#;#sendQuit#(#)#;#}#finally#{#disconnect#(#)#;#}#}##String#sanitizeAddress#(#String#s#)#{#int#paramDepth#=#0#;#int#start#=#0#;#int#end#=#0#;#int#len#=#s#.#length#(#)#;#for#(#int#i#=#0#;#i#<#len#;#i#++#)#{#char#c#=#s#.#charAt#(#i#)#;#if#(#c#==#'('#)#{#paramDepth#++#;#if#(#start#==#0#)#{#end#=#i#;#// support "address (name)"#}#}#else#if#(#c#==#')'#)#{#paramDepth#--#;#if#(#end#==#0#)#{#start#=#i#+#1#;#// support "(name) address"#}#}#else#if#(#paramDepth#==#0#&&#c#==#'<'#)#{#start#=#i#+#1#;#}#else#if#(#paramDepth#==#0#&&#c#==#'>'#)#{#end#=#i#;#}#}#if#(#end#==#0#)#{#end#=#len#;#}#return#s#.#substring#(#start#,#end#)#;#}##void#connect#(#)#throws#IOException#{#socket#=#new#Socket#(#host#,#port#)#;#out#=#new#MailPrintStream#(#new#BufferedOutputStream#(#socket#.#getOutputStream#(#)#)#)#;#in#=#new#SmtpResponseReader#(#socket#.#getInputStream#(#)#)#;#getReady#(#)#;#}##void#getReady#(#)#throws#IOException#{#String#response#=#in#.#getResponse#(#)#;#int#[#]#ok#=#{#OK_READY#}#;#if#(#!#isResponseOK#(#response#,#ok#)#)#{#throw#new#IOException#(#"Didn't get introduction from server: "#+#response#)#;#}#}##void#sendHelo#(#)#throws#IOException#{#String#local#=#InetAddress#.#getLocalHost#(#)#.#getHostName#(#)#;#int#[#]#ok#=#{#OK_HELO#}#;#send#(#"HELO "#+#local#,#ok#)#;#}##void#sendFrom#(#String#from#)#throws#IOException#{#int#[#]#ok#=#{#OK_FROM#}#;#send#(#"MAIL FROM: "#+#"<"#+#sanitizeAddress#(#from#)#+#">"#,#ok#)#;#}##void#sendRcpt#(#String#rcpt#)#throws#IOException#{#int#[#]#ok#=#{#OK_RCPT_1#,#OK_RCPT_2#}#;#send#(#"RCPT TO: "#+#"<"#+#sanitizeAddress#(#rcpt#)#+#">"#,#ok#)#;#}##void#sendData#(#)#throws#IOException#{#int#[#]#ok#=#{#OK_DATA#}#;#send#(#"DATA"#,#ok#)#;#}##void#sendDot#(#)#throws#IOException#{#int#[#]#ok#=#{#OK_DOT#}#;#send#(#"\r\n."#,#ok#)#;#// make sure dot is on new line#}##void#sendQuit#(#)#throws#IOException#{#int#[#]#ok#=#{#OK_QUIT#}#;#try#{#send#(#"QUIT"#,#ok#)#;#}#catch#(#IOException#e#)#{#throw#new#ErrorInQuitException#(#e#)#;#}#}##void#send#(#String#msg#,#int#[#]#ok#)#throws#IOException#{#out#.#rawPrint#(#msg#+#"\r\n"#)#;#// raw supports <CRLF>.<CRLF>#String#response#=#in#.#getResponse#(#)#;#if#(#!#isResponseOK#(#response#,#ok#)#)#{#throw#new#IOException#(#"Unexpected reply to command: "#+#msg#+#": "#+#response#)#;#}#}##boolean#isResponseOK#(#String#response#,#int#[#]#ok#)#{#// Check that the response is one of the valid codes#for#(#int#i#=#0#;#i#<#ok#.#length#;#i#++#)#{#if#(#response#.#startsWith#(#""#+#ok#[#i#]#)#)#{#return#true#;#}#}#return#false#;#}##void#disconnect#(#)#throws#IOException#{#if#(#out#!=#null#)#{#out#.#close#(#)#;#}#if#(#in#!=#null#)#{#try#{#in#.#close#(#)#;#}#catch#(#IOException#e#)#{#// ignore#}#}#if#(#socket#!=#null#)#{#try#{#socket#.#close#(#)#;#}#catch#(#IOException#e#)#{#// ignore#}#}#}##