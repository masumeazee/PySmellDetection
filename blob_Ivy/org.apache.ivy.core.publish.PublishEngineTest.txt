void#setUp#(#)#throws#Exception#{#System#.#setProperty#(#"ivy.cache.dir"#,#new#File#(#"build/test/publish/cache"#)#.#getAbsolutePath#(#)#)#;#FileUtil#.#forceDelete#(#new#File#(#"build/test/publish"#)#)#;#}##void#tearDown#(#)#throws#Exception#{#FileUtil#.#forceDelete#(#new#File#(#"build/test/publish"#)#)#;#}##void#testAtomicity#(#)#throws#Exception#{#IvySettings#settings#=#new#IvySettings#(#)#;#final#PublishEngine#engine#=#new#PublishEngine#(#settings#,#new#EventManager#(#)#)#;#final#int#[#]#counter#=#new#int#[#]#{#0#}#;#final#DefaultModuleDescriptor#md#=#DefaultModuleDescriptor#.#newDefaultInstance#(#ModuleRevisionId#.#parse#(#"#A;1.0"#)#)#;#final#FileSystemResolver#resolver#=#new#FileSystemResolver#(#)#{#public#void#publish#(#Artifact#artifact#,#File#src#,#boolean#overwrite#)#throws#IOException#{#super#.#publish#(#artifact#,#src#,#overwrite#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#sleepSilently#(#50#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#}#}#;#resolver#.#setName#(#"test"#)#;#resolver#.#setSettings#(#settings#)#;#String#publishRepoDir#=#new#File#(#"build/test/publish/repo"#)#.#getAbsolutePath#(#)#;#resolver#.#addIvyPattern#(#publishRepoDir#+#"/[module]/[revision]/[artifact].[ext]"#)#;#resolver#.#addArtifactPattern#(#publishRepoDir#+#"/[module]/[revision]/[artifact].[ext]"#)#;#FileUtil#.#copy#(#new#File#(#"test/repositories/1/org1/mod1.1/jars/mod1.1-1.0.jar"#)#,#new#File#(#"build/test/publish/module/A.jar"#)#,#null#)#;#XmlModuleDescriptorWriter#.#write#(#md#,#new#File#(#"build/test/publish/module/ivy.xml"#)#)#;#resolveAndAssertNotFound#(#settings#,#resolver#,#"#A;latest.integration"#,#"before publishing"#)#;#// run publish asynchronously#new#Thread#(#)#{#public#void#run#(#)#{#try#{#engine#.#publish#(#md#,#Arrays#.#asList#(#new#String#[#]#{#"build/test/publish/module/[artifact].[ext]"#}#)#,#resolver#,#new#PublishOptions#(#)#.#setSrcIvyPattern#(#"build/test/publish/module/[artifact].[ext]"#)#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#}#catch#(#IOException#e#)#{#throw#new#RuntimeException#(#e#)#;#}#}#}#.#start#(#)#;#while#(#true#)#{#sleepSilently#(#5#)#;#synchronized#(#this#)#{#if#(#counter#[#0#]#==#5#)#{#break#;#}#else#if#(#counter#[#0#]#<#4#)#{#resolveAndAssertNotFound#(#settings#,#resolver#,#"#A;latest.integration"#,#"after "#+#(#counter#[#0#]#/#2#)#+#" artifacts published"#)#;#}#}#}#resolveAndAssertFound#(#settings#,#resolver#,#"#A;1.0"#)#;#}##void#publish#(#Artifact#artifact#,#File#src#,#boolean#overwrite#)#throws#IOException#{#super#.#publish#(#artifact#,#src#,#overwrite#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#sleepSilently#(#50#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#}##void#run#(#)#{#try#{#engine#.#publish#(#md#,#Arrays#.#asList#(#new#String#[#]#{#"build/test/publish/module/[artifact].[ext]"#}#)#,#resolver#,#new#PublishOptions#(#)#.#setSrcIvyPattern#(#"build/test/publish/module/[artifact].[ext]"#)#)#;#synchronized#(#PublishEngineTest#.#this#)#{#counter#[#0#]#++#;#}#}#catch#(#IOException#e#)#{#throw#new#RuntimeException#(#e#)#;#}#}##void#resolveAndAssertNotFound#(#IvySettings#settings#,#FileSystemResolver#resolver#,#String#module#,#String#context#)#throws#ParseException#{#ResolvedModuleRevision#rmr#=#resolveModule#(#settings#,#resolver#,#module#)#;#assertNull#(#"module found "#+#context#+#". module="#+#rmr#,#rmr#)#;#}##void#resolveAndAssertFound#(#IvySettings#settings#,#FileSystemResolver#resolver#,#String#module#)#throws#ParseException#{#ResolvedModuleRevision#rmr#=#resolveModule#(#settings#,#resolver#,#module#)#;#assertNotNull#(#rmr#)#;#assertEquals#(#module#,#rmr#.#getId#(#)#.#toString#(#)#)#;#}##ResolvedModuleRevision#resolveModule#(#IvySettings#settings#,#FileSystemResolver#resolver#,#String#module#)#throws#ParseException#{#return#resolver#.#getDependency#(#new#DefaultDependencyDescriptor#(#ModuleRevisionId#.#parse#(#module#)#,#false#)#,#new#ResolveData#(#new#ResolveEngine#(#settings#,#new#EventManager#(#)#,#new#SortEngine#(#settings#)#)#,#new#ResolveOptions#(#)#)#)#;#}##void#sleepSilently#(#int#timeout#)#{#try#{#Thread#.#sleep#(#timeout#)#;#}#catch#(#InterruptedException#e#)#{#}#}##