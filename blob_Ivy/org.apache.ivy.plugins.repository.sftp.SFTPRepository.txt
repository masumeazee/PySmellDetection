void#init#(#int#op#,#String#src#,#String#dest#,#long#max#)#{#totalLength#=#max#;#fireTransferStarted#(#max#)#;#}##void#end#(#)#{#fireTransferCompleted#(#totalLength#)#;#}##boolean#count#(#long#count#)#{#fireTransferProgress#(#count#)#;#return#true#;#}##Resource#getResource#(#String#source#)#{#return#new#SFTPResource#(#this#,#source#)#;#}##Resource#resolveResource#(#String#path#)#{#try#{#ChannelSftp#c#=#getSftpChannel#(#path#)#;#Collection#r#=#c#.#ls#(#getPath#(#path#)#)#;#if#(#r#!=#null#)#{#for#(#Iterator#iter#=#r#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#Object#obj#=#iter#.#next#(#)#;#if#(#obj#instanceof#LsEntry#)#{#LsEntry#entry#=#(#LsEntry#)#obj#;#SftpATTRS#attrs#=#entry#.#getAttrs#(#)#;#return#new#BasicResource#(#path#,#true#,#attrs#.#getSize#(#)#,#attrs#.#getMTime#(#)#*#MILLIS_PER_SECOND#,#false#)#;#}#}#}#}#catch#(#Exception#e#)#{#Message#.#debug#(#"reolving resource error: "#+#e#.#getMessage#(#)#)#;#// silent fail, return unexisting resource#}#return#new#BasicResource#(#path#,#false#,#0#,#0#,#false#)#;#}##InputStream#openStream#(#SFTPResource#resource#)#throws#IOException#{#ChannelSftp#c#=#getSftpChannel#(#resource#.#getName#(#)#)#;#try#{#String#path#=#getPath#(#resource#.#getName#(#)#)#;#return#c#.#get#(#path#)#;#}#catch#(#SftpException#e#)#{#IOException#ex#=#new#IOException#(#"impossible to open stream for "#+#resource#+#" on "#+#getHost#(#)#+#(#e#.#getMessage#(#)#!=#null#?#": "#+#e#.#getMessage#(#)#:#""#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#catch#(#URISyntaxException#e#)#{#IOException#ex#=#new#IOException#(#"impossible to open stream for "#+#resource#+#" on "#+#getHost#(#)#+#(#e#.#getMessage#(#)#!=#null#?#": "#+#e#.#getMessage#(#)#:#""#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#}##void#get#(#String#source#,#File#destination#)#throws#IOException#{#fireTransferInitiated#(#getResource#(#source#)#,#TransferEvent#.#REQUEST_GET#)#;#ChannelSftp#c#=#getSftpChannel#(#source#)#;#try#{#String#path#=#getPath#(#source#)#;#c#.#get#(#path#,#destination#.#getAbsolutePath#(#)#,#new#MyProgressMonitor#(#)#)#;#}#catch#(#SftpException#e#)#{#IOException#ex#=#new#IOException#(#"impossible to get "#+#source#+#" on "#+#getHost#(#)#+#(#e#.#getMessage#(#)#!=#null#?#": "#+#e#.#getMessage#(#)#:#""#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#catch#(#URISyntaxException#e#)#{#IOException#ex#=#new#IOException#(#"impossible to get "#+#source#+#" on "#+#getHost#(#)#+#(#e#.#getMessage#(#)#!=#null#?#": "#+#e#.#getMessage#(#)#:#""#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#}##void#put#(#File#source#,#String#destination#,#boolean#overwrite#)#throws#IOException#{#fireTransferInitiated#(#getResource#(#destination#)#,#TransferEvent#.#REQUEST_PUT#)#;#ChannelSftp#c#=#getSftpChannel#(#destination#)#;#try#{#String#path#=#getPath#(#destination#)#;#if#(#!#overwrite#&&#checkExistence#(#path#,#c#)#)#{#throw#new#IOException#(#"destination file exists and overwrite == false"#)#;#}#if#(#path#.#indexOf#(#'/'#)#!=#-#1#)#{#mkdirs#(#path#.#substring#(#0#,#path#.#lastIndexOf#(#'/'#)#)#,#c#)#;#}#c#.#put#(#source#.#getAbsolutePath#(#)#,#path#,#new#MyProgressMonitor#(#)#)#;#}#catch#(#SftpException#e#)#{#IOException#ex#=#new#IOException#(#e#.#getMessage#(#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#catch#(#URISyntaxException#e#)#{#IOException#ex#=#new#IOException#(#e#.#getMessage#(#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#}##void#mkdirs#(#String#directory#,#ChannelSftp#c#)#throws#IOException#,#SftpException#{#try#{#SftpATTRS#att#=#c#.#stat#(#directory#)#;#if#(#att#!=#null#)#{#if#(#att#.#isDir#(#)#)#{#return#;#}#}#}#catch#(#SftpException#ex#)#{#if#(#directory#.#indexOf#(#'/'#)#!=#-#1#)#{#mkdirs#(#directory#.#substring#(#0#,#directory#.#lastIndexOf#(#'/'#)#)#,#c#)#;#}#c#.#mkdir#(#directory#)#;#}#}##String#getPath#(#String#sftpURI#)#throws#URISyntaxException#{#String#result#=#null#;#URI#uri#=#new#URI#(#sftpURI#)#;#result#=#uri#.#getPath#(#)#;#if#(#result#==#null#)#{#throw#new#URISyntaxException#(#sftpURI#,#"Missing path in URI."#)#;#}#return#result#;#}##List#list#(#String#parent#)#throws#IOException#{#try#{#ChannelSftp#c#=#getSftpChannel#(#parent#)#;#Collection#r#=#c#.#ls#(#parent#)#;#if#(#r#!=#null#)#{#if#(#!#parent#.#endsWith#(#"/"#)#)#{#parent#=#parent#+#"/"#;#}#List#result#=#new#ArrayList#(#)#;#for#(#Iterator#iter#=#r#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#Object#obj#=#iter#.#next#(#)#;#if#(#obj#instanceof#LsEntry#)#{#LsEntry#entry#=#(#LsEntry#)#obj#;#if#(#"."#.#equals#(#entry#.#getFilename#(#)#)#||#".."#.#equals#(#entry#.#getFilename#(#)#)#)#{#continue#;#}#result#.#add#(#parent#+#entry#.#getFilename#(#)#)#;#}#}#return#result#;#}#}#catch#(#SftpException#e#)#{#IOException#ex#=#new#IOException#(#"Failed to return a listing for '"#+#parent#+#"'"#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#return#null#;#}##boolean#checkExistence#(#String#file#,#ChannelSftp#channel#)#throws#IOException#,#SftpException#{#try#{#return#channel#.#stat#(#file#)#!=#null#;#}#catch#(#SftpException#ex#)#{#return#false#;#}#}##ChannelSftp#getSftpChannel#(#String#pathOrUri#)#throws#IOException#{#Session#session#=#getSession#(#pathOrUri#)#;#String#host#=#session#.#getHost#(#)#;#ChannelSftp#channel#=#SshCache#.#getInstance#(#)#.#getChannelSftp#(#session#)#;#if#(#channel#==#null#)#{#try#{#channel#=#(#ChannelSftp#)#session#.#openChannel#(#"sftp"#)#;#channel#.#connect#(#)#;#Message#.#verbose#(#":: SFTP :: connected to "#+#host#+#"!"#)#;#SshCache#.#getInstance#(#)#.#attachChannelSftp#(#session#,#channel#)#;#}#catch#(#JSchException#e#)#{#IOException#ex#=#new#IOException#(#e#.#getMessage#(#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#}#return#channel#;#}##String#getRepositoryScheme#(#)#{#// use the Resolver type name here?#// would be nice if it would be static, so we could use SFTPResolver.getTypeName()#return#"sftp"#;#}##