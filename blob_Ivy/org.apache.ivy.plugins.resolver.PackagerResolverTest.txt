void#setUp#(#)#throws#Exception#{#_settings#=#new#IvySettings#(#)#;#Message#.#setDefaultLogger#(#new#DefaultMessageLogger#(#99#)#)#;#_engine#=#new#ResolveEngine#(#_settings#,#new#EventManager#(#)#,#new#SortEngine#(#_settings#)#)#;#_cache#=#new#File#(#"build/cache"#)#;#_data#=#new#ResolveData#(#_engine#,#new#ResolveOptions#(#)#)#;#_cache#.#mkdirs#(#)#;#_settings#.#setDefaultCache#(#_cache#)#;#// Create work space with build and resource cache directories#_workdir#=#new#File#(#"build/test/PackagerResolverTest"#)#;#_builddir#=#new#File#(#_workdir#,#"build"#)#;#_cachedir#=#new#File#(#_workdir#,#"resources"#)#;#_websitedir#=#new#File#(#_workdir#,#"website"#)#;#cleanupTempDirs#(#)#;#if#(#!#_builddir#.#mkdirs#(#)#||#!#_cachedir#.#mkdirs#(#)#)#{#throw#new#Exception#(#"can't create directories under "#+#_workdir#)#;#}#// copy "website"#Copy#copy#=#new#Copy#(#)#;#FileSet#fileSet#=#new#FileSet#(#)#;#fileSet#.#setDir#(#new#File#(#"test/repositories/packager/website"#)#)#;#copy#.#addFileset#(#fileSet#)#;#copy#.#setTodir#(#_websitedir#)#;#copy#.#setProject#(#new#Project#(#)#)#;#copy#.#execute#(#)#;#}##void#tearDown#(#)#throws#Exception#{#FileUtil#.#forceDelete#(#_cache#)#;#cleanupTempDirs#(#)#;#}##void#cleanupTempDirs#(#)#throws#Exception#{#FileUtil#.#forceDelete#(#_workdir#)#;#}##void#testFile#(#)#throws#Exception#{#Locale#oldLocale#=#Locale#.#getDefault#(#)#;#try#{#// set the locale to UK as workaround for SUN bug 6240963#Locale#.#setDefault#(#Locale#.#UK#)#;#// Create and configure resolver#PackagerResolver#resolver#=#new#PackagerResolver#(#)#;#resolver#.#setSettings#(#_settings#)#;#File#repoRoot#=#new#File#(#"test/repositories/packager/repo"#)#;#resolver#.#addIvyPattern#(#""#+#new#File#(#repoRoot#,#"[organisation]/[module]/[revision]/ivy.xml"#)#.#getAbsoluteFile#(#)#.#toURL#(#)#.#toExternalForm#(#)#)#;#resolver#.#setPackagerPattern#(#""#+#new#File#(#repoRoot#,#"[organisation]/[module]/[revision]/packager.xml"#)#.#getAbsoluteFile#(#)#.#toURL#(#)#.#toExternalForm#(#)#)#;#resolver#.#setBuildRoot#(#_builddir#)#;#resolver#.#setResourceCache#(#_cachedir#)#;#resolver#.#setPreserveBuildDirectories#(#true#)#;#resolver#.#setVerbose#(#true#)#;#resolver#.#setProperty#(#"packager.website.url"#,#new#File#(#"test/repositories/packager/website"#)#.#getAbsoluteFile#(#)#.#toURL#(#)#.#toExternalForm#(#)#)#;#resolver#.#setName#(#"packager"#)#;#assertEquals#(#"packager"#,#resolver#.#getName#(#)#)#;#// Get module descriptor#ModuleRevisionId#mrid#=#ModuleRevisionId#.#newInstance#(#"org"#,#"mod"#,#"1.0"#)#;#ResolvedModuleRevision#rmr#=#resolver#.#getDependency#(#new#DefaultDependencyDescriptor#(#mrid#,#false#)#,#_data#)#;#assertNotNull#(#rmr#)#;#assertEquals#(#mrid#,#rmr#.#getId#(#)#)#;#Date#pubdate#=#new#GregorianCalendar#(#2004#,#10#,#1#,#11#,#0#,#0#)#.#getTime#(#)#;#assertEquals#(#pubdate#,#rmr#.#getPublicationDate#(#)#)#;#// Download artifact#Artifact#artifact#=#new#DefaultArtifact#(#mrid#,#pubdate#,#"mod"#,#"jar"#,#"jar"#)#;#DownloadReport#report#=#resolver#.#download#(#new#Artifact#[#]#{#artifact#}#,#downloadOptions#(#)#)#;#assertNotNull#(#report#)#;#assertEquals#(#1#,#report#.#getArtifactsReports#(#)#.#length#)#;#ArtifactDownloadReport#ar#=#report#.#getArtifactReport#(#artifact#)#;#System#.#out#.#println#(#"downloaddetails: "#+#ar#.#getDownloadDetails#(#)#)#;#assertNotNull#(#ar#)#;#assertEquals#(#artifact#,#ar#.#getArtifact#(#)#)#;#assertEquals#(#DownloadStatus#.#SUCCESSFUL#,#ar#.#getDownloadStatus#(#)#)#;#// Verify resource cache now contains the distribution archive#assertTrue#(#new#File#(#_cachedir#,#"mod-1.0.tar.gz"#)#.#exists#(#)#)#;#// Download again, should use Ivy cache this time#report#=#resolver#.#download#(#new#Artifact#[#]#{#artifact#}#,#downloadOptions#(#)#)#;#assertNotNull#(#report#)#;#assertEquals#(#1#,#report#.#getArtifactsReports#(#)#.#length#)#;#ar#=#report#.#getArtifactReport#(#artifact#)#;#assertNotNull#(#ar#)#;#assertEquals#(#artifact#,#ar#.#getArtifact#(#)#)#;#assertEquals#(#DownloadStatus#.#NO#,#ar#.#getDownloadStatus#(#)#)#;#// Now download the maven2 artifact#artifact#=#DefaultArtifact#.#cloneWithAnotherName#(#artifact#,#"foobar-janfu"#)#;#report#=#resolver#.#download#(#new#Artifact#[#]#{#artifact#}#,#downloadOptions#(#)#)#;#assertNotNull#(#report#)#;#assertEquals#(#1#,#report#.#getArtifactsReports#(#)#.#length#)#;#ar#=#report#.#getArtifactReport#(#artifact#)#;#assertNotNull#(#ar#)#;#assertEquals#(#artifact#,#ar#.#getArtifact#(#)#)#;#assertEquals#(#DownloadStatus#.#SUCCESSFUL#,#ar#.#getDownloadStatus#(#)#)#;#}#finally#{#Locale#.#setDefault#(#oldLocale#)#;#}#}##