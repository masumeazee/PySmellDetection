void#defineAttribute#(#String#attributeName#,#String#value#)#{#if#(#macrodef#.#getAttribute#(#attributeName#)#==#null#)#{#throw#new#IllegalArgumentException#(#"undeclared attribute "#+#attributeName#+#" on macro "#+#macrodef#.#getName#(#)#)#;#}#attValues#.#put#(#attributeName#,#value#)#;#}##MacroRecord#recordCreateChild#(#String#name#)#{#MacroRecord#macroRecord#=#new#MacroRecord#(#name#)#;#List#records#=#(#List#)#macroRecords#.#get#(#name#)#;#if#(#records#==#null#)#{#records#=#new#ArrayList#(#)#;#macroRecords#.#put#(#name#,#records#)#;#}#records#.#add#(#macroRecord#)#;#return#macroRecord#;#}##Object#play#(#Configurator#conf#)#{#return#macrodef#.#play#(#conf#,#attValues#,#macroRecords#)#;#}##String#getDefault#(#)#{#return#defaultValue#;#}##void#setDefault#(#String#default1#)#{#defaultValue#=#default1#;#}##String#getName#(#)#{#return#name#;#}##void#setName#(#String#name#)#{#this#.#name#=#name#;#}##String#getName#(#)#{#return#name#;#}##void#setName#(#String#name#)#{#this#.#name#=#name#;#}##boolean#isOptional#(#)#{#return#optional#;#}##void#setOptional#(#boolean#optional#)#{#this#.#optional#=#optional#;#}##String#getName#(#)#{#return#name#;#}##void#recordAttribute#(#String#name#,#String#value#)#{#attributes#.#put#(#name#,#value#)#;#}##MacroRecord#recordChild#(#String#name#)#{#MacroRecord#child#=#new#MacroRecord#(#name#)#;#children#.#add#(#child#)#;#return#child#;#}##MacroRecord#recordChild#(#String#name#,#Object#object#)#{#MacroRecord#child#=#recordChild#(#name#)#;#child#.#object#=#object#;#return#child#;#}##Map#getAttributes#(#)#{#return#attributes#;#}##List#getChildren#(#)#{#return#children#;#}##Object#getObject#(#)#{#return#object#;#}##Attribute#getAttribute#(#String#attributeName#)#{#return#(#Attribute#)#attributes#.#get#(#attributeName#)#;#}##Object#play#(#Configurator#conf#,#Map#attValues#,#Map#macroRecords#)#{#for#(#Iterator#iter#=#attributes#.#values#(#)#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#Attribute#att#=#(#Attribute#)#iter#.#next#(#)#;#String#val#=#(#String#)#attValues#.#get#(#att#.#getName#(#)#)#;#if#(#val#==#null#)#{#if#(#att#.#getDefault#(#)#==#null#)#{#throw#new#IllegalArgumentException#(#"attribute "#+#att#.#getName#(#)#+#" is required in "#+#getName#(#)#)#;#}#else#{#attValues#.#put#(#att#.#getName#(#)#,#att#.#getDefault#(#)#)#;#}#}#}#return#play#(#conf#,#macroRecord#,#attValues#,#macroRecords#)#;#}##Object#play#(#Configurator#conf#,#MacroRecord#macroRecord#,#Map#attValues#,#Map#childrenRecords#)#{#if#(#macroRecord#.#getObject#(#)#!=#null#)#{#// this is a recorded reference, we can add the referenced object directly#conf#.#addChild#(#macroRecord#.#getName#(#)#,#macroRecord#.#getObject#(#)#)#;#conf#.#endCreateChild#(#)#;#return#macroRecord#.#getObject#(#)#;#}#conf#.#startCreateChild#(#macroRecord#.#getName#(#)#)#;#Map#attributes#=#macroRecord#.#getAttributes#(#)#;#for#(#Iterator#iter#=#attributes#.#keySet#(#)#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#String#attName#=#(#String#)#iter#.#next#(#)#;#String#attValue#=#replaceParam#(#(#String#)#attributes#.#get#(#attName#)#,#attValues#)#;#conf#.#setAttribute#(#attName#,#attValue#)#;#}#for#(#Iterator#iter#=#macroRecord#.#getChildren#(#)#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#MacroRecord#child#=#(#MacroRecord#)#iter#.#next#(#)#;#Element#elt#=#(#Element#)#elements#.#get#(#child#.#getName#(#)#)#;#if#(#elt#!=#null#)#{#List#elements#=#(#List#)#childrenRecords#.#get#(#child#.#getName#(#)#)#;#if#(#elements#!=#null#)#{#for#(#Iterator#iterator#=#elements#.#iterator#(#)#;#iterator#.#hasNext#(#)#;#)#{#MacroRecord#element#=#(#MacroRecord#)#iterator#.#next#(#)#;#for#(#Iterator#it2#=#element#.#getChildren#(#)#.#iterator#(#)#;#it2#.#hasNext#(#)#;#)#{#MacroRecord#r#=#(#MacroRecord#)#it2#.#next#(#)#;#play#(#conf#,#r#,#attValues#,#Collections#.#EMPTY_MAP#)#;#}#}#}#else#if#(#!#elt#.#isOptional#(#)#)#{#throw#new#IllegalArgumentException#(#"non optional element is not specified: "#+#elt#.#getName#(#)#+#" in macro "#+#getName#(#)#)#;#}#continue#;#}#play#(#conf#,#child#,#attValues#,#childrenRecords#)#;#}#return#conf#.#endCreateChild#(#)#;#}##String#replaceParam#(#String#string#,#Map#attValues#)#{#return#IvyPatternHelper#.#substituteParams#(#string#,#attValues#)#;#}##String#getName#(#)#{#return#name#;#}##void#addConfiguredAttribute#(#Attribute#att#)#{#attributes#.#put#(#att#.#getName#(#)#,#att#)#;#}##void#addConfiguredElement#(#Element#elt#)#{#elements#.#put#(#elt#.#getName#(#)#,#elt#)#;#}##Macro#createMacro#(#)#{#return#new#Macro#(#this#)#;#}##void#addAttribute#(#String#attName#,#String#attDefaultValue#)#{#Attribute#att#=#new#Attribute#(#)#;#att#.#setName#(#attName#)#;#att#.#setDefault#(#attDefaultValue#)#;#addConfiguredAttribute#(#att#)#;#}##void#addElement#(#String#elementName#,#boolean#optional#)#{#Element#elt#=#new#Element#(#)#;#elt#.#setName#(#elementName#)#;#elt#.#setOptional#(#optional#)#;#addConfiguredElement#(#elt#)#;#}##MacroRecord#recordCreateChild#(#String#name#)#{#macroRecord#=#new#MacroRecord#(#name#)#;#return#macroRecord#;#}##void#addCreateMethod#(#String#name#,#Method#m#)#{#createMethods#.#put#(#name#,#m#)#;#}##void#addAddMethod#(#String#name#,#Method#m#)#{#addMethods#.#put#(#name#,#m#)#;#}##void#addAddConfiguredMethod#(#String#name#,#Method#m#)#{#addConfiguredMethods#.#put#(#name#,#m#)#;#}##void#addAddMethod#(#Method#m#)#{#typeAddMethods#.#put#(#m#.#getParameterTypes#(#)#[#0#]#,#m#)#;#}##void#addAddConfiguredMethod#(#Method#m#)#{#typeAddConfiguredMethods#.#put#(#m#.#getParameterTypes#(#)#[#0#]#,#m#)#;#}##void#addSetMethod#(#String#name#,#Method#m#)#{#Method#current#=#(#Method#)#setMethods#.#get#(#name#)#;#if#(#current#!=#null#&&#current#.#getParameterTypes#(#)#[#0#]#==#String#.#class#)#{#// setter methods with String attribute take precedence #return#;#}#setMethods#.#put#(#name#,#m#)#;#}##Object#getObject#(#)#{#return#obj#;#}##Method#getCreateMethod#(#String#name#)#{#return#(#Method#)#createMethods#.#get#(#name#)#;#}##Method#getAddMethod#(#String#name#)#{#return#(#Method#)#addMethods#.#get#(#name#)#;#}##Method#getAddConfiguredMethod#(#String#name#)#{#return#(#Method#)#addConfiguredMethods#.#get#(#name#)#;#}##Method#getAddMethod#(#Class#type#)#{#return#getTypeMatchingMethod#(#type#,#typeAddMethods#)#;#}##Method#getAddConfiguredMethod#(#Class#type#)#{#return#getTypeMatchingMethod#(#type#,#typeAddConfiguredMethods#)#;#}##Method#getTypeMatchingMethod#(#Class#type#,#Map#typeMethods#)#{#Method#m#=#(#Method#)#typeMethods#.#get#(#type#)#;#if#(#m#!=#null#)#{#return#m#;#}#for#(#Iterator#iter#=#typeMethods#.#keySet#(#)#.#iterator#(#)#;#iter#.#hasNext#(#)#;#)#{#Class#clss#=#(#Class#)#iter#.#next#(#)#;#if#(#clss#.#isAssignableFrom#(#type#)#)#{#return#(#Method#)#typeMethods#.#get#(#clss#)#;#}#}#return#null#;#}##Method#getSetMethod#(#String#name#)#{#return#(#Method#)#setMethods#.#get#(#name#)#;#}##String#getObjectName#(#)#{#return#objName#;#}##void#typeDef#(#String#name#,#String#className#)#throws#ClassNotFoundException#{#typeDef#(#name#,#Class#.#forName#(#className#)#)#;#}##void#typeDef#(#String#name#,#Class#clazz#)#{#typedefs#.#put#(#name#,#clazz#)#;#}##void#setRoot#(#Object#root#)#{#if#(#root#==#null#)#{#throw#new#NullPointerException#(#)#;#}#objectStack#.#clear#(#)#;#setCurrent#(#root#,#null#)#;#}##void#clear#(#)#{#objectStack#.#clear#(#)#;#}##void#setCurrent#(#Object#object#,#String#name#)#{#objectStack#.#push#(#new#ObjectDescriptor#(#object#,#name#)#)#;#}##Object#startCreateChild#(#String#name#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#throw#new#IllegalStateException#(#"set root before creating child"#)#;#}#ObjectDescriptor#parentOD#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#Object#parent#=#parentOD#.#getObject#(#)#;#if#(#parent#instanceof#MacroDef#)#{#if#(#!#"attribute"#.#equals#(#name#)#&&#!#"element"#.#equals#(#name#)#)#{#MacroRecord#record#=#(#(#MacroDef#)#parent#)#.#recordCreateChild#(#name#)#;#setCurrent#(#record#,#name#)#;#return#record#;#}#}#if#(#parent#instanceof#Macro#)#{#MacroRecord#record#=#(#(#Macro#)#parent#)#.#recordCreateChild#(#name#)#;#setCurrent#(#record#,#name#)#;#return#record#;#}#if#(#parent#instanceof#MacroRecord#)#{#MacroRecord#record#=#(#(#MacroRecord#)#parent#)#.#recordChild#(#name#)#;#setCurrent#(#record#,#name#)#;#return#record#;#}#Object#child#=#null#;#MacroDef#macrodef#=#(#MacroDef#)#macrodefs#.#get#(#name#)#;#if#(#macrodef#!=#null#)#{#Macro#macro#=#macrodef#.#createMacro#(#)#;#setCurrent#(#macro#,#name#)#;#return#macro#;#}#Class#childClass#=#(#Class#)#typedefs#.#get#(#name#)#;#Method#addChild#=#null#;#try#{#if#(#childClass#!=#null#)#{#return#addChild#(#parentOD#,#childClass#,#name#,#null#)#;#}#else#{#addChild#=#parentOD#.#getCreateMethod#(#name#)#;#if#(#addChild#!=#null#)#{#child#=#addChild#.#invoke#(#parent#,#new#Object#[#0#]#)#;#setCurrent#(#child#,#name#)#;#return#child#;#}#addChild#=#parentOD#.#getAddMethod#(#name#)#;#if#(#addChild#!=#null#)#{#childClass#=#addChild#.#getParameterTypes#(#)#[#0#]#;#child#=#childClass#.#newInstance#(#)#;#addChild#.#invoke#(#parent#,#new#Object#[#]#{#child#}#)#;#setCurrent#(#child#,#name#)#;#return#child#;#}#addChild#=#parentOD#.#getAddConfiguredMethod#(#name#)#;#if#(#addChild#!=#null#)#{#childClass#=#addChild#.#getParameterTypes#(#)#[#0#]#;#if#(#Map#.#class#==#childClass#)#{#child#=#new#HashMap#(#)#;#}#else#{#child#=#childClass#.#newInstance#(#)#;#}#setCurrent#(#child#,#name#)#;#return#child#;#}#}#}#catch#(#InstantiationException#ex#)#{#throw#new#IllegalArgumentException#(#"no default constructor on "#+#childClass#+#" for adding "#+#name#+#" on "#+#parent#.#getClass#(#)#)#;#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"bad method found for "#+#name#+#" on "#+#parent#.#getClass#(#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#throw#new#IllegalArgumentException#(#"no appropriate method found for adding "#+#name#+#" on "#+#parent#.#getClass#(#)#)#;#}##void#addChild#(#String#name#,#Object#child#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#throw#new#IllegalStateException#(#"set root before creating child"#)#;#}#ObjectDescriptor#parentOD#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#try#{#addChild#(#parentOD#,#child#.#getClass#(#)#,#name#,#child#)#;#}#catch#(#InstantiationException#ex#)#{#throw#new#IllegalArgumentException#(#"no default constructor on "#+#child#.#getClass#(#)#+#" for adding "#+#name#+#" on "#+#parentOD#.#getObject#(#)#.#getClass#(#)#)#;#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"bad method found for "#+#name#+#" on "#+#parentOD#.#getObject#(#)#.#getClass#(#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#}##Object#addChild#(#ObjectDescriptor#parentOD#,#Class#childClass#,#String#name#,#Object#child#)#throws#InstantiationException#,#IllegalAccessException#,#InvocationTargetException#{#Object#parent#=#parentOD#.#getObject#(#)#;#if#(#parent#instanceof#MacroRecord#)#{#MacroRecord#record#=#(#MacroRecord#)#parent#;#MacroRecord#recordChild#=#record#.#recordChild#(#name#,#child#)#;#setCurrent#(#recordChild#,#name#)#;#return#recordChild#;#}#Method#addChild#=#parentOD#.#getAddMethod#(#childClass#)#;#if#(#addChild#!=#null#)#{#if#(#child#==#null#)#{#child#=#childClass#.#newInstance#(#)#;#}#addChild#.#invoke#(#parent#,#new#Object#[#]#{#child#}#)#;#setCurrent#(#child#,#name#)#;#return#child#;#}#addChild#=#parentOD#.#getAddConfiguredMethod#(#childClass#)#;#if#(#addChild#!=#null#)#{#if#(#child#==#null#)#{#if#(#Map#.#class#==#childClass#)#{#child#=#new#HashMap#(#)#;#}#else#{#child#=#childClass#.#newInstance#(#)#;#}#}#setCurrent#(#child#,#name#)#;#return#child#;#}#throw#new#IllegalArgumentException#(#"no appropriate method found for adding "#+#name#+#" on "#+#parent#.#getClass#(#)#)#;#}##boolean#isTopLevelMacroRecord#(#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#return#false#;#}#ObjectDescriptor#od#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#return#(#od#.#getObject#(#)#instanceof#MacroDef#)#;#}##void#setAttribute#(#String#attributeName#,#String#value#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#throw#new#IllegalStateException#(#"set root before setting attribute"#)#;#}#ObjectDescriptor#od#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#if#(#od#.#getObject#(#)#instanceof#Macro#)#{#(#(#Macro#)#od#.#getObject#(#)#)#.#defineAttribute#(#attributeName#,#value#)#;#return#;#}#if#(#od#.#getObject#(#)#instanceof#MacroRecord#)#{#(#(#MacroRecord#)#od#.#getObject#(#)#)#.#recordAttribute#(#attributeName#,#value#)#;#return#;#}#Method#m#=#od#.#getSetMethod#(#attributeName#)#;#if#(#m#==#null#)#{#if#(#od#.#getObject#(#)#instanceof#Map#)#{#(#(#Map#)#od#.#getObject#(#)#)#.#put#(#attributeName#,#value#)#;#return#;#}#throw#new#IllegalArgumentException#(#"no set method found for "#+#attributeName#+#" on "#+#od#.#getObject#(#)#.#getClass#(#)#)#;#}#Object#convertedValue#=#null#;#Class#paramClass#=#m#.#getParameterTypes#(#)#[#0#]#;#try#{#if#(#paramClass#.#equals#(#String#.#class#)#)#{#convertedValue#=#value#;#}#else#if#(#paramClass#.#equals#(#Boolean#.#class#)#||#paramClass#.#equals#(#boolean#.#class#)#)#{#convertedValue#=#Boolean#.#valueOf#(#TRUE_VALUES#.#contains#(#value#)#)#;#}#else#if#(#paramClass#.#equals#(#Character#.#class#)#||#paramClass#.#equals#(#char#.#class#)#)#{#convertedValue#=#new#Character#(#value#.#length#(#)#>#0#?#value#.#charAt#(#0#)#:#' '#)#;#}#else#if#(#paramClass#.#equals#(#Short#.#class#)#||#paramClass#.#equals#(#short#.#class#)#)#{#convertedValue#=#Short#.#valueOf#(#value#)#;#}#else#if#(#paramClass#.#equals#(#Integer#.#class#)#||#paramClass#.#equals#(#int#.#class#)#)#{#convertedValue#=#Integer#.#valueOf#(#value#)#;#}#else#if#(#paramClass#.#equals#(#Long#.#class#)#||#paramClass#.#equals#(#long#.#class#)#)#{#convertedValue#=#Long#.#valueOf#(#value#)#;#}#else#if#(#paramClass#.#equals#(#Class#.#class#)#)#{#convertedValue#=#Class#.#forName#(#value#)#;#}#else#if#(#paramClass#.#equals#(#File#.#class#)#)#{#convertedValue#=#fileResolver#.#resolveFile#(#value#,#od#.#getObjectName#(#)#+#"."#+#attributeName#)#;#}#else#{#convertedValue#=#paramClass#.#getConstructor#(#new#Class#[#]#{#String#.#class#}#)#.#newInstance#(#new#Object#[#]#{#value#}#)#;#}#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"impossible to convert "#+#value#+#" to "#+#paramClass#+#" for setting "#+#attributeName#+#" on "#+#od#.#getObject#(#)#.#getClass#(#)#+#": "#+#ex#.#getMessage#(#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#try#{#m#.#invoke#(#od#.#getObject#(#)#,#new#Object#[#]#{#convertedValue#}#)#;#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"impossible to set "#+#attributeName#+#" to "#+#convertedValue#+#" on "#+#od#.#getObject#(#)#.#getClass#(#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#}##void#addText#(#String#text#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#throw#new#IllegalStateException#(#"set root before adding text"#)#;#}#ObjectDescriptor#od#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#try#{#od#.#getObject#(#)#.#getClass#(#)#.#getMethod#(#"addText"#,#new#Class#[#]#{#String#.#class#}#)#.#invoke#(#od#.#getObject#(#)#,#new#Object#[#]#{#text#}#)#;#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"impossible to add text on "#+#od#.#getObject#(#)#.#getClass#(#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#}##Object#endCreateChild#(#)#{#if#(#objectStack#.#isEmpty#(#)#)#{#throw#new#IllegalStateException#(#"set root before ending child"#)#;#}#ObjectDescriptor#od#=#(#ObjectDescriptor#)#objectStack#.#pop#(#)#;#if#(#objectStack#.#isEmpty#(#)#)#{#objectStack#.#push#(#od#)#;#// back to previous state#throw#new#IllegalStateException#(#"cannot end root"#)#;#}#if#(#od#.#getObject#(#)#instanceof#Macro#)#{#return#(#(#Macro#)#od#.#getObject#(#)#)#.#play#(#this#)#;#}#ObjectDescriptor#parentOD#=#(#ObjectDescriptor#)#objectStack#.#peek#(#)#;#String#name#=#od#.#getObjectName#(#)#;#Class#childClass#=#(#Class#)#typedefs#.#get#(#name#)#;#Method#m#=#null#;#if#(#childClass#!=#null#)#{#m#=#parentOD#.#getAddConfiguredMethod#(#childClass#)#;#}#else#{#m#=#parentOD#.#getAddConfiguredMethod#(#name#)#;#}#try#{#if#(#m#!=#null#)#{#m#.#invoke#(#parentOD#.#getObject#(#)#,#new#Object#[#]#{#od#.#getObject#(#)#}#)#;#}#return#od#.#getObject#(#)#;#}#catch#(#Exception#ex#)#{#IllegalArgumentException#iae#=#new#IllegalArgumentException#(#"impossible to add configured child for "#+#name#+#" on "#+#parentOD#.#getObject#(#)#.#getClass#(#)#+#": "#+#StringUtils#.#getErrorMessage#(#ex#)#)#;#iae#.#initCause#(#ex#)#;#throw#iae#;#}#}##Object#getCurrent#(#)#{#return#objectStack#.#isEmpty#(#)#?#null#:#(#(#ObjectDescriptor#)#objectStack#.#peek#(#)#)#.#getObject#(#)#;#}##int#getDepth#(#)#{#return#objectStack#.#size#(#)#;#}##MacroDef#startMacroDef#(#String#macroName#)#{#MacroDef#macroDef#=#new#MacroDef#(#macroName#)#;#setCurrent#(#macroDef#,#macroName#)#;#return#macroDef#;#}##void#addMacroAttribute#(#String#attName#,#String#attDefaultValue#)#{#(#(#MacroDef#)#getCurrent#(#)#)#.#addAttribute#(#attName#,#attDefaultValue#)#;#}##void#addMacroElement#(#String#elementName#,#boolean#optional#)#{#(#(#MacroDef#)#getCurrent#(#)#)#.#addElement#(#elementName#,#optional#)#;#}##void#endMacroDef#(#)#{#addConfiguredMacrodef#(#(#(#MacroDef#)#getCurrent#(#)#)#)#;#objectStack#.#pop#(#)#;#}##void#addConfiguredMacrodef#(#MacroDef#macrodef#)#{#macrodefs#.#put#(#macrodef#.#getName#(#)#,#macrodef#)#;#}##Class#getTypeDef#(#String#name#)#{#return#(#Class#)#typedefs#.#get#(#name#)#;#}##FileResolver#getFileResolver#(#)#{#return#fileResolver#;#}##void#setFileResolver#(#FileResolver#fileResolver#)#{#Checks#.#checkNotNull#(#fileResolver#,#"fileResolver"#)#;#this#.#fileResolver#=#fileResolver#;#}##