URLInfo#getURLInfo#(#URL#url#)#{#return#getURLInfo#(#url#,#0#)#;#}##URLInfo#getURLInfo#(#URL#url#,#int#timeout#)#{#URLConnection#con#=#null#;#try#{#url#=#normalizeToURL#(#url#)#;#con#=#url#.#openConnection#(#)#;#con#.#setRequestProperty#(#"User-Agent"#,#"Apache Ivy/"#+#Ivy#.#getIvyVersion#(#)#)#;#if#(#con#instanceof#HttpURLConnection#)#{#HttpURLConnection#httpCon#=#(#HttpURLConnection#)#con#;#if#(#getRequestMethod#(#)#==#URLHandler#.#REQUEST_METHOD_HEAD#)#{#httpCon#.#setRequestMethod#(#"HEAD"#)#;#}#if#(#checkStatusCode#(#url#,#httpCon#)#)#{#return#new#URLInfo#(#true#,#httpCon#.#getContentLength#(#)#,#con#.#getLastModified#(#)#)#;#}#}#else#{#int#contentLength#=#con#.#getContentLength#(#)#;#if#(#contentLength#<=#0#)#{#return#UNAVAILABLE#;#}#else#{#return#new#URLInfo#(#true#,#contentLength#,#con#.#getLastModified#(#)#)#;#}#}#}#catch#(#UnknownHostException#e#)#{#Message#.#warn#(#"Host "#+#e#.#getMessage#(#)#+#" not found. url="#+#url#)#;#Message#.#info#(#"You probably access the destination server through "#+#"a proxy server that is not well configured."#)#;#}#catch#(#IOException#e#)#{#Message#.#error#(#"Server access Error: "#+#e#.#getMessage#(#)#+#" url="#+#url#)#;#}#finally#{#disconnect#(#con#)#;#}#return#UNAVAILABLE#;#}##boolean#checkStatusCode#(#URL#url#,#HttpURLConnection#con#)#throws#IOException#{#int#status#=#con#.#getResponseCode#(#)#;#if#(#status#==#HttpStatus#.#SC_OK#)#{#return#true#;#}#Message#.#debug#(#"HTTP response status: "#+#status#+#" url="#+#url#)#;#if#(#status#==#HttpStatus#.#SC_PROXY_AUTHENTICATION_REQUIRED#)#{#Message#.#warn#(#"Your proxy requires authentication."#)#;#}#else#if#(#String#.#valueOf#(#status#)#.#startsWith#(#"4"#)#)#{#Message#.#verbose#(#"CLIENT ERROR: "#+#con#.#getResponseMessage#(#)#+#" url="#+#url#)#;#}#else#if#(#String#.#valueOf#(#status#)#.#startsWith#(#"5"#)#)#{#Message#.#error#(#"SERVER ERROR: "#+#con#.#getResponseMessage#(#)#+#" url="#+#url#)#;#}#return#false#;#}##InputStream#openStream#(#URL#url#)#throws#IOException#{#URLConnection#conn#=#null#;#InputStream#inStream#=#null#;#try#{#url#=#normalizeToURL#(#url#)#;#conn#=#url#.#openConnection#(#)#;#conn#.#setRequestProperty#(#"User-Agent"#,#"Apache Ivy/"#+#Ivy#.#getIvyVersion#(#)#)#;#if#(#conn#instanceof#HttpURLConnection#)#{#HttpURLConnection#httpCon#=#(#HttpURLConnection#)#conn#;#if#(#!#checkStatusCode#(#url#,#httpCon#)#)#{#throw#new#IOException#(#"The HTTP response code for "#+#url#+#" did not indicate a success."#+#" See log for more detail."#)#;#}#}#inStream#=#conn#.#getInputStream#(#)#;#ByteArrayOutputStream#outStream#=#new#ByteArrayOutputStream#(#)#;#byte#[#]#buffer#=#new#byte#[#BUFFER_SIZE#]#;#int#len#;#while#(#(#len#=#inStream#.#read#(#buffer#)#)#>#0#)#{#outStream#.#write#(#buffer#,#0#,#len#)#;#}#return#new#ByteArrayInputStream#(#outStream#.#toByteArray#(#)#)#;#}#finally#{#if#(#inStream#!=#null#)#{#inStream#.#close#(#)#;#}#disconnect#(#conn#)#;#}#}##void#download#(#URL#src#,#File#dest#,#CopyProgressListener#l#)#throws#IOException#{#URLConnection#srcConn#=#null#;#try#{#src#=#normalizeToURL#(#src#)#;#srcConn#=#src#.#openConnection#(#)#;#srcConn#.#setRequestProperty#(#"User-Agent"#,#"Apache Ivy/"#+#Ivy#.#getIvyVersion#(#)#)#;#if#(#srcConn#instanceof#HttpURLConnection#)#{#HttpURLConnection#httpCon#=#(#HttpURLConnection#)#srcConn#;#if#(#!#checkStatusCode#(#src#,#httpCon#)#)#{#throw#new#IOException#(#"The HTTP response code for "#+#src#+#" did not indicate a success."#+#" See log for more detail."#)#;#}#}#int#contentLength#=#srcConn#.#getContentLength#(#)#;#FileUtil#.#copy#(#srcConn#.#getInputStream#(#)#,#dest#,#l#)#;#if#(#dest#.#length#(#)#!=#contentLength#&&#contentLength#!=#-#1#)#{#dest#.#delete#(#)#;#throw#new#IOException#(#"Downloaded file size doesn't match expected Content Length for "#+#src#+#". Please retry."#)#;#}#long#lastModified#=#srcConn#.#getLastModified#(#)#;#if#(#lastModified#>#0#)#{#dest#.#setLastModified#(#lastModified#)#;#}#}#finally#{#disconnect#(#srcConn#)#;#}#}##void#upload#(#File#source#,#URL#dest#,#CopyProgressListener#l#)#throws#IOException#{#if#(#!#"http"#.#equals#(#dest#.#getProtocol#(#)#)#&&#!#"https"#.#equals#(#dest#.#getProtocol#(#)#)#)#{#throw#new#UnsupportedOperationException#(#"URL repository only support HTTP PUT at the moment"#)#;#}#HttpURLConnection#conn#=#null#;#try#{#dest#=#normalizeToURL#(#dest#)#;#conn#=#(#HttpURLConnection#)#dest#.#openConnection#(#)#;#conn#.#setDoOutput#(#true#)#;#conn#.#setRequestMethod#(#"PUT"#)#;#conn#.#setRequestProperty#(#"User-Agent"#,#"Apache Ivy/"#+#Ivy#.#getIvyVersion#(#)#)#;#conn#.#setRequestProperty#(#"Content-type"#,#"application/octet-stream"#)#;#conn#.#setRequestProperty#(#"Content-length"#,#Long#.#toString#(#source#.#length#(#)#)#)#;#conn#.#setInstanceFollowRedirects#(#true#)#;#InputStream#in#=#new#FileInputStream#(#source#)#;#try#{#OutputStream#os#=#conn#.#getOutputStream#(#)#;#FileUtil#.#copy#(#in#,#os#,#l#)#;#}#finally#{#try#{#in#.#close#(#)#;#}#catch#(#IOException#e#)#{#/* ignored */#}#}#validatePutStatusCode#(#dest#,#conn#.#getResponseCode#(#)#,#conn#.#getResponseMessage#(#)#)#;#}#finally#{#disconnect#(#conn#)#;#}#}##void#disconnect#(#URLConnection#con#)#{#if#(#con#instanceof#HttpURLConnection#)#{#(#(#HttpURLConnection#)#con#)#.#disconnect#(#)#;#}#else#if#(#con#!=#null#&&#"sun.net.www.protocol.file.FileURLConnection"#.#equals#(#con#.#getClass#(#)#.#getName#(#)#)#)#{#// ugly fix for a sun jre bug:#// http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4257700#//#// getting header info on the fileurlconnection opens the connection,#// which opens a file input stream without closing it.#try#{#con#.#getInputStream#(#)#.#close#(#)#;#}#catch#(#IOException#e#)#{#// ignored#}#}#}##