void#execute#(#)#{#Message#savedMessage#=#message#;##try#{#Mailer#mailer#=#null#;##// prepare for the auto select mechanism#boolean#autoFound#=#false#;##// try MIME format##if#(#encoding#.#equals#(#MIME#)#||#(#encoding#.#equals#(#AUTO#)#&&#!#autoFound#)#)#{#try#{##//check to make sure that activation.jar ##//and mail.jar are available - see bug 31969#Class#.#forName#(#"javax.activation.DataHandler"#)#;#Class#.#forName#(#"javax.mail.internet.MimeMessage"#)#;#mailer#=#(#Mailer#)#ClasspathUtils#.#newInstance#(#"org.apache.tools.ant.taskdefs.email.MimeMailer"#,#EmailTask#.#class#.#getClassLoader#(#)#,#Mailer#.#class#)#;#autoFound#=#true#;#log#(#"Using MIME mail"#,#Project#.#MSG_VERBOSE#)#;#}##catch#(#BuildException#e#)#{#logBuildException#(#"Failed to initialise MIME mail: "#,#e#)#;#}#}##// SMTP auth only allowed with MIME mail##if#(#!#autoFound#&&#(#(#user#!=#null#)#||#(#password#!=#null#)#)#&&#(#encoding#.#equals#(#UU#)#||#encoding#.#equals#(#PLAIN#)#)#)#{#throw#new#BuildException#(#"SMTP auth only possible with MIME mail"#)#;#}##// SSL only allowed with MIME mail##if#(#!#autoFound#&&#(#ssl#||#starttls#)#&&#(#encoding#.#equals#(#UU#)#||#encoding#.#equals#(#PLAIN#)#)#)#{#throw#new#BuildException#(#"SSL and STARTTLS only possible with"#+#" MIME mail"#)#;#}##// try UU format##if#(#encoding#.#equals#(#UU#)#||#(#encoding#.#equals#(#AUTO#)#&&#!#autoFound#)#)#{#try#{#mailer#=#(#Mailer#)#ClasspathUtils#.#newInstance#(#"org.apache.tools.ant.taskdefs.email.UUMailer"#,#EmailTask#.#class#.#getClassLoader#(#)#,#Mailer#.#class#)#;#autoFound#=#true#;#log#(#"Using UU mail"#,#Project#.#MSG_VERBOSE#)#;#}##catch#(#BuildException#e#)#{#logBuildException#(#"Failed to initialise UU mail: "#,#e#)#;#}#}##// try plain format##if#(#encoding#.#equals#(#PLAIN#)#||#(#encoding#.#equals#(#AUTO#)#&&#!#autoFound#)#)#{#mailer#=#new#PlainMailer#(#)#;#autoFound#=#true#;#log#(#"Using plain mail"#,#Project#.#MSG_VERBOSE#)#;#}##// a valid mailer must be present by now##if#(#mailer#==#null#)#{#throw#new#BuildException#(#"Failed to initialise encoding: "#+#encoding#)#;#}##// a valid message is required##if#(#message#==#null#)#{#message#=#new#Message#(#)#;#message#.#setProject#(#getProject#(#)#)#;#}##// an address to send from is required##if#(#from#==#null#||#from#.#getAddress#(#)#==#null#)#{#throw#new#BuildException#(#"A from element is required"#)#;#}##// at least one address to send to/cc/bcc is required##if#(#toList#.#isEmpty#(#)#&&#ccList#.#isEmpty#(#)#&&#bccList#.#isEmpty#(#)#)#{#throw#new#BuildException#(#"At least one of to, cc or bcc must "#+#"be supplied"#)#;#}##// set the mimetype if not done already (and required)##if#(#messageMimeType#!=#null#)#{##if#(#message#.#isMimeTypeSpecified#(#)#)#{#throw#new#BuildException#(#"The mime type can only be "#+#"specified in one location"#)#;#}##message#.#setMimeType#(#messageMimeType#)#;#}##// set the character set if not done already (and required)##if#(#charset#!=#null#)#{##if#(#message#.#getCharset#(#)#!=#null#)#{#throw#new#BuildException#(#"The charset can only be "#+#"specified in one location"#)#;#}##message#.#setCharset#(#charset#)#;#}##// identify which files should be attached#Vector#files#=#new#Vector#(#)#;##if#(#attachments#!=#null#)#{#Iterator#iter#=#attachments#.#iterator#(#)#;##while#(#iter#.#hasNext#(#)#)#{#Resource#r#=#(#Resource#)#iter#.#next#(#)#;#files#.#addElement#(#(#(#FileProvider#)#r#.#as#(#FileProvider#.#class#)#)#.#getFile#(#)#)#;#}#}##// let the user know what's going to happen#log#(#"Sending email: "#+#subject#,#Project#.#MSG_INFO#)#;#log#(#"From "#+#from#,#Project#.#MSG_VERBOSE#)#;#log#(#"ReplyTo "#+#replyToList#,#Project#.#MSG_VERBOSE#)#;#log#(#"To "#+#toList#,#Project#.#MSG_VERBOSE#)#;#log#(#"Cc "#+#ccList#,#Project#.#MSG_VERBOSE#)#;#log#(#"Bcc "#+#bccList#,#Project#.#MSG_VERBOSE#)#;##// pass the params to the mailer#mailer#.#setHost#(#host#)#;#mailer#.#setPort#(#port#)#;#mailer#.#setUser#(#user#)#;#mailer#.#setPassword#(#password#)#;#mailer#.#setSSL#(#ssl#)#;#mailer#.#setEnableStartTLS#(#starttls#)#;#mailer#.#setMessage#(#message#)#;#mailer#.#setFrom#(#from#)#;#mailer#.#setReplyToList#(#replyToList#)#;#mailer#.#setToList#(#toList#)#;#mailer#.#setCcList#(#ccList#)#;#mailer#.#setBccList#(#bccList#)#;#mailer#.#setFiles#(#files#)#;#mailer#.#setSubject#(#subject#)#;#mailer#.#setTask#(#this#)#;#mailer#.#setIncludeFileNames#(#includeFileNames#)#;#mailer#.#setHeaders#(#headers#)#;#mailer#.#setIgnoreInvalidRecipients#(#ignoreInvalidRecipients#)#;##// send the email#mailer#.#send#(#)#;##// let the user know what happened#int#count#=#files#.#size#(#)#;#log#(#"Sent email with "#+#count#+#" attachment"#+#(#count#==#1#?#""#:#"s"#)#,#Project#.#MSG_INFO#)#;#}##catch#(#BuildException#e#)#{#logBuildException#(#"Failed to send email: "#,#e#)#;##if#(#failOnError#)#{#throw#e#;#}#}##catch#(#Exception#e#)#{#log#(#"Failed to send email: "#+#e#.#getMessage#(#)#,#Project#.#MSG_WARN#)#;##if#(#failOnError#)#{#throw#new#BuildException#(#e#)#;#}#}##finally#{#message#=#savedMessage#;#}#}