void#execute#(#)#throws#BuildException#{#checkAttributes#(#)#;#FTPClient#ftp#=#null#;##try#{#log#(#"Opening FTP connection to "#+#server#,#Project#.#MSG_VERBOSE#)#;#ftp#=#new#FTPClient#(#)#;##if#(#this#.#isConfigurationSet#)#{#ftp#=#FTPConfigurator#.#configure#(#ftp#,#this#)#;#}##ftp#.#setRemoteVerificationEnabled#(#enableRemoteVerification#)#;#ftp#.#connect#(#server#,#port#)#;##if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"FTP connection failed: "#+#ftp#.#getReplyString#(#)#)#;#}##log#(#"connected"#,#Project#.#MSG_VERBOSE#)#;#log#(#"logging in to FTP server"#,#Project#.#MSG_VERBOSE#)#;##if#(#(#this#.#account#!=#null#&&#!#ftp#.#login#(#userid#,#password#,#account#)#)#||#(#this#.#account#==#null#&&#!#ftp#.#login#(#userid#,#password#)#)#)#{#throw#new#BuildException#(#"Could not login to FTP server"#)#;#}##log#(#"login succeeded"#,#Project#.#MSG_VERBOSE#)#;##if#(#binary#)#{#ftp#.#setFileType#(#org#.#apache#.#commons#.#net#.#ftp#.#FTP#.#BINARY_FILE_TYPE#)#;##if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not set transfer type: "#+#ftp#.#getReplyString#(#)#)#;#}#}#else#{#ftp#.#setFileType#(#org#.#apache#.#commons#.#net#.#ftp#.#FTP#.#ASCII_FILE_TYPE#)#;##if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not set transfer type: "#+#ftp#.#getReplyString#(#)#)#;#}#}##if#(#passive#)#{#log#(#"entering passive mode"#,#Project#.#MSG_VERBOSE#)#;#ftp#.#enterLocalPassiveMode#(#)#;##if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not enter into passive "#+#"mode: "#+#ftp#.#getReplyString#(#)#)#;#}#}##// If an initial command was configured then send it.##// Some FTP servers offer different modes of operation,##// E.G. switching between a UNIX file system mode and##// a legacy file system.##if#(#this#.#initialSiteCommand#!=#null#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#initialSiteCommand#)#;#}#}##,#"initial site command: "#+#this#.#initialSiteCommand#)#;#}##// For a unix ftp server you can set the default mask for all files##// created.##if#(#umask#!=#null#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#"umask "#+#umask#)#;#}#}##,#"umask "#+#umask#)#;#}##// If the action is MK_DIR, then the specified remote##// directory is the directory to create.##if#(#action#==#MK_DIR#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#makeRemoteDir#(#lftp#,#remotedir#)#;#}#}##,#remotedir#)#;#}#else##if#(#action#==#SITE_CMD#)#{#RetryHandler#h#=#new#RetryHandler#(#this#.#retriesAllowed#,#this#)#;#final#FTPClient#lftp#=#ftp#;#executeRetryable#(#h#,#new#Retryable#(#)#{#public#void#execute#(#)#throws#IOException#{#doSiteCommand#(#lftp#,#FTP#.#this#.#siteCommand#)#;#}#}##,#"Site Command: "#+#this#.#siteCommand#)#;#}#else#{##if#(#remotedir#!=#null#)#{#log#(#"changing the remote directory to "#+#remotedir#,#Project#.#MSG_VERBOSE#)#;#ftp#.#changeWorkingDirectory#(#remotedir#)#;##if#(#!#FTPReply#.#isPositiveCompletion#(#ftp#.#getReplyCode#(#)#)#)#{#throw#new#BuildException#(#"could not change remote "#+#"directory: "#+#ftp#.#getReplyString#(#)#)#;#}#}##if#(#newerOnly#&&#timeDiffAuto#)#{##// in this case we want to find how much time span there is between local##// and remote#timeDiffMillis#=#getTimeDiff#(#ftp#)#;#}##log#(#ACTION_STRS#[#action#]#+#" "#+#ACTION_TARGET_STRS#[#action#]#)#;#transferFiles#(#ftp#)#;#}#}##catch#(#IOException#ex#)#{#throw#new#BuildException#(#"error during FTP transfer: "#+#ex#,#ex#)#;#}##finally#{##if#(#ftp#!=#null#&&#ftp#.#isConnected#(#)#)#{#try#{#log#(#"disconnecting"#,#Project#.#MSG_VERBOSE#)#;#ftp#.#logout#(#)#;#ftp#.#disconnect#(#)#;#}##catch#(#IOException#ex#)#{##// ignore it#}#}#}#}