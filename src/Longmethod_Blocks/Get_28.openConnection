URLConnection#openConnection#(#URL#aSource#)#throws#IOException#{##// set up the URL connection#URLConnection#connection#=#aSource#.#openConnection#(#)#;##// modify the headers##// NB: things like user authentication could go in here too.##if#(#hasTimestamp#)#{#connection#.#setIfModifiedSince#(#timestamp#)#;#}##// prepare Java 1.1 style credentials##if#(#uname#!=#null#||#pword#!=#null#)#{#String#up#=#uname#+#":"#+#pword#;#String#encoding#;##// we do not use the sun impl for portability,##// and always use our own implementation for consistent##// testing#Base64Converter#encoder#=#new#Base64Converter#(#)#;#encoding#=#encoder#.#encode#(#up#.#getBytes#(#)#)#;#connection#.#setRequestProperty#(#"Authorization"#,#"Basic "#+#encoding#)#;#}##if#(#connection#instanceof#HttpURLConnection#)#{#(#(#HttpURLConnection#)#connection#)#.#setInstanceFollowRedirects#(#false#)#;#(#(#HttpURLConnection#)#connection#)#.#setUseCaches#(#httpUseCaches#)#;#}##// connect to the remote site (may take some time)#connection#.#connect#(#)#;##// First check on a 301 / 302 (moved) response (HTTP only)##if#(#connection#instanceof#HttpURLConnection#)#{#HttpURLConnection#httpConnection#=#(#HttpURLConnection#)#connection#;#int#responseCode#=#httpConnection#.#getResponseCode#(#)#;##if#(#responseCode#==#HttpURLConnection#.#HTTP_MOVED_PERM#||#responseCode#==#HttpURLConnection#.#HTTP_MOVED_TEMP#||#responseCode#==#HttpURLConnection#.#HTTP_SEE_OTHER#)#{#String#newLocation#=#httpConnection#.#getHeaderField#(#"Location"#)#;#String#message#=#aSource#+#(#responseCode#==#HttpURLConnection#.#HTTP_MOVED_PERM#?#" permanently"#:#""#)#+#" moved to "#+#newLocation#;#log#(#message#,#logLevel#)#;#URL#newURL#=#new#URL#(#newLocation#)#;##if#(#!#redirectionAllowed#(#aSource#,#newURL#)#)#{##return#null#;#}##return#openConnection#(#newURL#)#;#}##// next test for a 304 result (HTTP only)#long#lastModified#=#httpConnection#.#getLastModified#(#)#;##if#(#responseCode#==#HttpURLConnection#.#HTTP_NOT_MODIFIED#||#(#lastModified#!=#0#&&#hasTimestamp#&&#timestamp#>=#lastModified#)#)#{##// not modified so no file download. just return##// instead and trace out something so the user##// doesn't think that the download happened when it##// didn't#log#(#"Not modified - so not downloaded"#,#logLevel#)#;##return#null#;#}##// test for 401 result (HTTP only)##if#(#responseCode#==#HttpURLConnection#.#HTTP_UNAUTHORIZED#)#{#String#message#=#"HTTP Authorization failure"#;##if#(#ignoreErrors#)#{#log#(#message#,#logLevel#)#;##return#null#;#}#else#{#throw#new#BuildException#(#message#)#;#}#}#}##//REVISIT: at this point even non HTTP connections may##//support the if-modified-since behaviour -we just check##//the date of the content and skip the write if it is not##//newer. Some protocols (FTP) don't include dates, of##//course.##return#connection#;#}