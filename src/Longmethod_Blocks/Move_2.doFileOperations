void#doFileOperations#(#)#{##//Attempt complete directory renames, if any, first.##if#(#completeDirMap#.#size#(#)#>#0#)#{#for#(#Iterator#fromDirs#=#completeDirMap#.#keySet#(#)#.#iterator#(#)#;##fromDirs#.#hasNext#(#)#;#)#{#File#fromDir#=#(#File#)#fromDirs#.#next#(#)#;#File#toDir#=#(#File#)#completeDirMap#.#get#(#fromDir#)#;#boolean#renamed#=#false#;##try#{#log#(#"Attempting to rename dir: "#+#fromDir#+#" to "#+#toDir#,#verbosity#)#;#renamed#=#renameFile#(#fromDir#,#toDir#,#filtering#,#forceOverwrite#)#;#}##catch#(#IOException#ioe#)#{#String#msg#=#"Failed to rename dir "#+#fromDir#+#" to "#+#toDir#+#" due to "#+#ioe#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#ioe#,#getLocation#(#)#)#;#}##if#(#!#renamed#)#{#FileSet#fs#=#new#FileSet#(#)#;#fs#.#setProject#(#getProject#(#)#)#;#fs#.#setDir#(#fromDir#)#;#addFileset#(#fs#)#;#DirectoryScanner#ds#=#fs#.#getDirectoryScanner#(#getProject#(#)#)#;#String#[#]#files#=#ds#.#getIncludedFiles#(#)#;#String#[#]#dirs#=#ds#.#getIncludedDirectories#(#)#;#scan#(#fromDir#,#toDir#,#files#,#dirs#)#;#}#}#}##int#moveCount#=#fileCopyMap#.#size#(#)#;##if#(#moveCount#>#0#)#{##// files to move#log#(#"Moving "#+#moveCount#+#" file"#+#(#(#moveCount#==#1#)#?#""#:#"s"#)#+#" to "#+#destDir#.#getAbsolutePath#(#)#)#;##for#(#Iterator#fromFiles#=#fileCopyMap#.#keySet#(#)#.#iterator#(#)#;##fromFiles#.#hasNext#(#)#;#)#{#String#fromFile#=#(#String#)#fromFiles#.#next#(#)#;#File#f#=#new#File#(#fromFile#)#;#boolean#selfMove#=#false#;##if#(#f#.#exists#(#)#)#{##//Is this file still available to be moved?#String#[#]#toFiles#=#(#String#[#]#)#fileCopyMap#.#get#(#fromFile#)#;##for#(#int#i#=#0#;##i#<#toFiles#.#length#;#i#++#)#{#String#toFile#=#(#String#)#toFiles#[#i#]#;##if#(#fromFile#.#equals#(#toFile#)#)#{#log#(#"Skipping self-move of "#+#fromFile#,#verbosity#)#;#selfMove#=#true#;##// if this is the last time through the loop then##// move will not occur, but that's what we want#continue#;#}##File#d#=#new#File#(#toFile#)#;##if#(#(#i#+#1#)#==#toFiles#.#length#&&#!#selfMove#)#{##// Only try to move if this is the last mapped file##// and one of the mappings isn't to itself#moveFile#(#f#,#d#,#filtering#,#forceOverwrite#)#;#}#else#{#copyFile#(#f#,#d#,#filtering#,#forceOverwrite#)#;#}#}#}#}#}##if#(#includeEmpty#)#{#int#createCount#=#0#;##for#(#Iterator#fromDirNames#=#dirCopyMap#.#keySet#(#)#.#iterator#(#)#;##fromDirNames#.#hasNext#(#)#;#)#{#String#fromDirName#=#(#String#)#fromDirNames#.#next#(#)#;#String#[#]#toDirNames#=#(#String#[#]#)#dirCopyMap#.#get#(#fromDirName#)#;#boolean#selfMove#=#false#;##for#(#int#i#=#0#;##i#<#toDirNames#.#length#;#i#++#)#{##if#(#fromDirName#.#equals#(#toDirNames#[#i#]#)#)#{#log#(#"Skipping self-move of "#+#fromDirName#,#verbosity#)#;#selfMove#=#true#;#continue#;#}##File#d#=#new#File#(#toDirNames#[#i#]#)#;##if#(#!#d#.#exists#(#)#)#{##if#(#!#d#.#mkdirs#(#)#)#{#log#(#"Unable to create directory "#+#d#.#getAbsolutePath#(#)#,#Project#.#MSG_ERR#)#;#}#else#{#createCount#++#;#}#}#}##File#fromDir#=#new#File#(#fromDirName#)#;##if#(#!#selfMove#&&#okToDelete#(#fromDir#)#)#{#deleteDir#(#fromDir#)#;#}#}##if#(#createCount#>#0#)#{#log#(#"Moved "#+#dirCopyMap#.#size#(#)#+#" empty director"#+#(#dirCopyMap#.#size#(#)#==#1#?#"y"#:#"ies"#)#+#" to "#+#createCount#+#" empty director"#+#(#createCount#==#1#?#"y"#:#"ies"#)#+#" under "#+#destDir#.#getAbsolutePath#(#)#)#;#}#}#}