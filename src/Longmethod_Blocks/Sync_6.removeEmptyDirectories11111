int#removeEmptyDirectories#(#File#dir#,#boolean#removeIfEmpty#,#Set#preservedEmptyDirectories#)#{#int#removedCount#=#0#;##if#(#dir#.#isDirectory#(#)#)#{#File#[#]#children#=#dir#.#listFiles#(#)#;##for#(#int#i#=#0#;##i#<#children#.#length#;#++#i#)#{#File#file#=#children#[#i#]#;##// Test here again to avoid method call for non-directories!##if#(#file#.#isDirectory#(#)#)#{#removedCount#+=#removeEmptyDirectories#(#file#,#true#,#preservedEmptyDirectories#)#;#}#}##if#(#children#.#length#>#0#)#{##// This directory may have become empty...##// We need to re-query its children list!#children#=#dir#.#listFiles#(#)#;#}##if#(#children#.#length#<#1#&&#removeIfEmpty#&&#!#preservedEmptyDirectories#.#contains#(#dir#)#)#{#log#(#"Removing empty directory: "#+#dir#,#Project#.#MSG_DEBUG#)#;#dir#.#delete#(#)#;#++#removedCount#;#}#}##return#removedCount#;#}