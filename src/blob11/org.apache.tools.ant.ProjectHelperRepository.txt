ProjectHelperRepository#getInstance#(#)#{#return#instance#;#}##void#collectProjectHelpers#(#)#{#// First, try the system property#ProjectHelper#projectHelper#=#getProjectHelperBySystemProperty#(#)#;#registerProjectHelper#(#projectHelper#)#;#// A JDK1.3 'service' ( like in JAXP ). That will plug a helper#// automatically if in CLASSPATH, with the right META-INF/services.#try#{#ClassLoader#classLoader#=#LoaderUtils#.#getContextClassLoader#(#)#;#if#(#classLoader#!=#null#)#{#Enumeration#resources#=#classLoader#.#getResources#(#ProjectHelper#.#SERVICE_ID#)#;#while#(#resources#.#hasMoreElements#(#)#)#{#URL#resource#=#(#URL#)#resources#.#nextElement#(#)#;#projectHelper#=#getProjectHelperByService#(#resource#.#openStream#(#)#)#;#registerProjectHelper#(#projectHelper#)#;#}#}#InputStream#systemResource#=#ClassLoader#.#getSystemResourceAsStream#(#ProjectHelper#.#SERVICE_ID#)#;#if#(#systemResource#!=#null#)#{#projectHelper#=#getProjectHelperByService#(#systemResource#)#;#registerProjectHelper#(#projectHelper#)#;#}#}#catch#(#Exception#e#)#{#System#.#err#.#println#(#"Unable to load ProjectHelper from service "#+#ProjectHelper#.#SERVICE_ID#+#" ("#+#e#.#getClass#(#)#.#getName#(#)#+#": "#+#e#.#getMessage#(#)#+#")"#)#;#if#(#DEBUG#)#{#e#.#printStackTrace#(#System#.#err#)#;#}#}#// last but not least, ant default project helper#projectHelper#=#new#ProjectHelper2#(#)#;#registerProjectHelper#(#projectHelper#)#;#}##void#registerProjectHelper#(#ProjectHelper#projectHelper#)#{#if#(#projectHelper#==#null#)#{#return#;#}#if#(#DEBUG#)#{#System#.#out#.#println#(#"ProjectHelper "#+#projectHelper#.#getClass#(#)#.#getName#(#)#+#" registered."#)#;#}#try#{#helpers#.#add#(#projectHelper#.#getClass#(#)#.#getConstructor#(#NO_CLASS#)#)#;#}#catch#(#NoSuchMethodException#nse#)#{#// impossible to get here#throw#new#BuildException#(#"Couldn't find no-arg constructor in "#+#projectHelper#.#getClass#(#)#.#getName#(#)#)#;#}#}##ProjectHelper#getProjectHelperBySystemProperty#(#)#{#String#helperClass#=#System#.#getProperty#(#ProjectHelper#.#HELPER_PROPERTY#)#;#try#{#if#(#helperClass#!=#null#)#{#return#newHelper#(#helperClass#)#;#}#}#catch#(#SecurityException#e#)#{#System#.#err#.#println#(#"Unable to load ProjectHelper class \""#+#helperClass#+#" specified in system property "#+#ProjectHelper#.#HELPER_PROPERTY#+#" ("#+#e#.#getMessage#(#)#+#")"#)#;#if#(#DEBUG#)#{#e#.#printStackTrace#(#System#.#err#)#;#}#}#return#null#;#}##ProjectHelper#getProjectHelperByService#(#InputStream#is#)#{#try#{#// This code is needed by EBCDIC and other strange systems.#// It's a fix for bugs reported in xerces#InputStreamReader#isr#;#try#{#isr#=#new#InputStreamReader#(#is#,#"UTF-8"#)#;#}#catch#(#java#.#io#.#UnsupportedEncodingException#e#)#{#isr#=#new#InputStreamReader#(#is#)#;#}#BufferedReader#rd#=#new#BufferedReader#(#isr#)#;#String#helperClassName#=#rd#.#readLine#(#)#;#rd#.#close#(#)#;#if#(#helperClassName#!=#null#&&#!#""#.#equals#(#helperClassName#)#)#{#return#newHelper#(#helperClassName#)#;#}#}#catch#(#Exception#e#)#{#System#.#out#.#println#(#"Unable to load ProjectHelper from service "#+#ProjectHelper#.#SERVICE_ID#+#" ("#+#e#.#getMessage#(#)#+#")"#)#;#if#(#DEBUG#)#{#e#.#printStackTrace#(#System#.#err#)#;#}#}#return#null#;#}##ProjectHelper#newHelper#(#String#helperClass#)#throws#BuildException#{#ClassLoader#classLoader#=#LoaderUtils#.#getContextClassLoader#(#)#;#try#{#Class#clazz#=#null#;#if#(#classLoader#!=#null#)#{#try#{#clazz#=#classLoader#.#loadClass#(#helperClass#)#;#}#catch#(#ClassNotFoundException#ex#)#{#// try next method#}#}#if#(#clazz#==#null#)#{#clazz#=#Class#.#forName#(#helperClass#)#;#}#return#(#(#ProjectHelper#)#clazz#.#newInstance#(#)#)#;#}#catch#(#Exception#e#)#{#throw#new#BuildException#(#e#)#;#}#}##ProjectHelper#getProjectHelperForBuildFile#(#Resource#buildFile#)#throws#BuildException#{#Iterator#it#=#getHelpers#(#)#;#while#(#it#.#hasNext#(#)#)#{#ProjectHelper#helper#=#(#ProjectHelper#)#it#.#next#(#)#;#if#(#helper#.#canParseBuildFile#(#buildFile#)#)#{#if#(#DEBUG#)#{#System#.#out#.#println#(#"ProjectHelper "#+#helper#.#getClass#(#)#.#getName#(#)#+#" selected for the build file "#+#buildFile#)#;#}#return#helper#;#}#}#throw#new#RuntimeException#(#"BUG: at least the ProjectHelper2 should "#+#"have supported the file "#+#buildFile#)#;#}##ProjectHelper#getProjectHelperForAntlib#(#Resource#antlib#)#throws#BuildException#{#Iterator#it#=#getHelpers#(#)#;#while#(#it#.#hasNext#(#)#)#{#ProjectHelper#helper#=#(#ProjectHelper#)#it#.#next#(#)#;#if#(#helper#.#canParseAntlibDescriptor#(#antlib#)#)#{#if#(#DEBUG#)#{#System#.#out#.#println#(#"ProjectHelper "#+#helper#.#getClass#(#)#.#getName#(#)#+#" selected for the antlib "#+#antlib#)#;#}#return#helper#;#}#}#throw#new#RuntimeException#(#"BUG: at least the ProjectHelper2 should "#+#"have supported the file "#+#antlib#)#;#}##Iterator#getHelpers#(#)#{#return#new#ConstructingIterator#(#helpers#.#iterator#(#)#)#;#}##boolean#hasNext#(#)#{#return#nested#.#hasNext#(#)#;#}##Object#next#(#)#{#Constructor#c#=#(#Constructor#)#nested#.#next#(#)#;#try#{#return#c#.#newInstance#(#NO_OBJECT#)#;#}#catch#(#Exception#e#)#{#throw#new#BuildException#(#"Failed to invoke no-arg constructor"#+#" on "#+#c#.#getName#(#)#)#;#}#}##void#remove#(#)#{#throw#new#UnsupportedOperationException#(#"remove is not supported"#)#;#}##