void#setSpawn#(#boolean#spawn#)#{#this#.#spawn#=#spawn#;#}##void#setTimeout#(#Long#value#)#{#timeout#=#value#;#incompatibleWithSpawn#=#true#;#}##void#setTimeout#(#Integer#value#)#{#setTimeout#(#(#Long#)#(#(#value#==#null#)#?#null#:#new#Long#(#value#.#intValue#(#)#)#)#)#;#}##void#setExecutable#(#String#value#)#{#this#.#executable#=#value#;#cmdl#.#setExecutable#(#value#)#;#}##void#setDir#(#File#d#)#{#this#.#dir#=#d#;#}##void#setOs#(#String#os#)#{#this#.#os#=#os#;#}##String#getOs#(#)#{#return#os#;#}##void#setCommand#(#Commandline#cmdl#)#{#log#(#"The command attribute is deprecated.\n"#+#"Please use the executable attribute and nested arg elements."#,#Project#.#MSG_WARN#)#;#this#.#cmdl#=#cmdl#;#}##void#setOutput#(#File#out#)#{#this#.#output#=#out#;#incompatibleWithSpawn#=#true#;#}##void#setInput#(#File#input#)#{#if#(#inputString#!=#null#)#{#throw#new#BuildException#(#"The \"input\" and \"inputstring\" "#+#"attributes cannot both be specified"#)#;#}#this#.#input#=#input#;#incompatibleWithSpawn#=#true#;#}##void#setInputString#(#String#inputString#)#{#if#(#input#!=#null#)#{#throw#new#BuildException#(#"The \"input\" and \"inputstring\" "#+#"attributes cannot both be specified"#)#;#}#this#.#inputString#=#inputString#;#incompatibleWithSpawn#=#true#;#}##void#setLogError#(#boolean#logError#)#{#redirector#.#setLogError#(#logError#)#;#incompatibleWithSpawn#|=#logError#;#}##void#setError#(#File#error#)#{#this#.#error#=#error#;#incompatibleWithSpawn#=#true#;#}##void#setOutputproperty#(#String#outputProp#)#{#redirector#.#setOutputProperty#(#outputProp#)#;#incompatibleWithSpawn#=#true#;#}##void#setErrorProperty#(#String#errorProperty#)#{#redirector#.#setErrorProperty#(#errorProperty#)#;#incompatibleWithSpawn#=#true#;#}##void#setFailonerror#(#boolean#fail#)#{#failOnError#=#fail#;#incompatibleWithSpawn#|=#fail#;#}##void#setNewenvironment#(#boolean#newenv#)#{#newEnvironment#=#newenv#;#}##void#setResolveExecutable#(#boolean#resolveExecutable#)#{#this#.#resolveExecutable#=#resolveExecutable#;#}##void#setSearchPath#(#boolean#searchPath#)#{#this#.#searchPath#=#searchPath#;#}##boolean#getResolveExecutable#(#)#{#return#resolveExecutable#;#}##void#addEnv#(#Environment#.#Variable#var#)#{#env#.#addVariable#(#var#)#;#}##Commandline#.#Argument#createArg#(#)#{#return#cmdl#.#createArgument#(#)#;#}##void#setResultProperty#(#String#resultProperty#)#{#this#.#resultProperty#=#resultProperty#;#incompatibleWithSpawn#=#true#;#}##void#maybeSetResultPropertyValue#(#int#result#)#{#if#(#resultProperty#!=#null#)#{#String#res#=#Integer#.#toString#(#result#)#;#getProject#(#)#.#setNewProperty#(#resultProperty#,#res#)#;#}#}##void#setFailIfExecutionFails#(#boolean#flag#)#{#failIfExecFails#=#flag#;#incompatibleWithSpawn#=#true#;#}##void#setAppend#(#boolean#append#)#{#redirector#.#setAppend#(#append#)#;#incompatibleWithSpawn#=#true#;#}##void#addConfiguredRedirector#(#RedirectorElement#redirectorElement#)#{#if#(#this#.#redirectorElement#!=#null#)#{#throw#new#BuildException#(#"cannot have > 1 nested <redirector>s"#)#;#}#this#.#redirectorElement#=#redirectorElement#;#incompatibleWithSpawn#=#true#;#}##void#setOsFamily#(#String#osFamily#)#{#this#.#osFamily#=#osFamily#.#toLowerCase#(#Locale#.#US#)#;#}##String#getOsFamily#(#)#{#return#osFamily#;#}##String#resolveExecutable#(#String#exec#,#boolean#mustSearchPath#)#{#if#(#!#resolveExecutable#)#{#return#exec#;#}#// try to find the executable#File#executableFile#=#getProject#(#)#.#resolveFile#(#exec#)#;#if#(#executableFile#.#exists#(#)#)#{#return#executableFile#.#getAbsolutePath#(#)#;#}#// now try to resolve against the dir if given#if#(#dir#!=#null#)#{#executableFile#=#FILE_UTILS#.#resolveFile#(#dir#,#exec#)#;#if#(#executableFile#.#exists#(#)#)#{#return#executableFile#.#getAbsolutePath#(#)#;#}#}#// couldn't find it - must be on path#if#(#mustSearchPath#)#{#Path#p#=#null#;#String#[#]#environment#=#env#.#getVariables#(#)#;#if#(#environment#!=#null#)#{#for#(#int#i#=#0#;#i#<#environment#.#length#;#i#++#)#{#if#(#isPath#(#environment#[#i#]#)#)#{#p#=#new#Path#(#getProject#(#)#,#getPath#(#environment#[#i#]#)#)#;#break#;#}#}#}#if#(#p#==#null#)#{#Vector#envVars#=#Execute#.#getProcEnvironment#(#)#;#Enumeration#e#=#envVars#.#elements#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#String#line#=#(#String#)#e#.#nextElement#(#)#;#if#(#isPath#(#line#)#)#{#p#=#new#Path#(#getProject#(#)#,#getPath#(#line#)#)#;#break#;#}#}#}#if#(#p#!=#null#)#{#String#[#]#dirs#=#p#.#list#(#)#;#for#(#int#i#=#0#;#i#<#dirs#.#length#;#i#++#)#{#executableFile#=#FILE_UTILS#.#resolveFile#(#new#File#(#dirs#[#i#]#)#,#exec#)#;#if#(#executableFile#.#exists#(#)#)#{#return#executableFile#.#getAbsolutePath#(#)#;#}#}#}#}#// mustSearchPath is false, or no PATH or not found - keep our#// fingers crossed.#return#exec#;#}##void#execute#(#)#throws#BuildException#{#// Quick fail if this is not a valid OS for the command#if#(#!#isValidOs#(#)#)#{#return#;#}#File#savedDir#=#dir#;#// possibly altered in prepareExec#cmdl#.#setExecutable#(#resolveExecutable#(#executable#,#searchPath#)#)#;#checkConfiguration#(#)#;#try#{#runExec#(#prepareExec#(#)#)#;#}#finally#{#dir#=#savedDir#;#}#}##void#checkConfiguration#(#)#throws#BuildException#{#if#(#cmdl#.#getExecutable#(#)#==#null#)#{#throw#new#BuildException#(#"no executable specified"#,#getLocation#(#)#)#;#}#if#(#dir#!=#null#&&#!#dir#.#exists#(#)#)#{#throw#new#BuildException#(#"The directory "#+#dir#+#" does not exist"#)#;#}#if#(#dir#!=#null#&&#!#dir#.#isDirectory#(#)#)#{#throw#new#BuildException#(#dir#+#" is not a directory"#)#;#}#if#(#spawn#&&#incompatibleWithSpawn#)#{#getProject#(#)#.#log#(#"spawn does not allow attributes related to input, "#+#"output, error, result"#,#Project#.#MSG_ERR#)#;#getProject#(#)#.#log#(#"spawn also does not allow timeout"#,#Project#.#MSG_ERR#)#;#getProject#(#)#.#log#(#"finally, spawn is not compatible "#+#"with a nested I/O <redirector>"#,#Project#.#MSG_ERR#)#;#throw#new#BuildException#(#"You have used an attribute "#+#"or nested element which is not compatible with spawn"#)#;#}#setupRedirector#(#)#;#}##void#setupRedirector#(#)#{#redirector#.#setInput#(#input#)#;#redirector#.#setInputString#(#inputString#)#;#redirector#.#setOutput#(#output#)#;#redirector#.#setError#(#error#)#;#}##boolean#isValidOs#(#)#{#//hand osfamily off to Os class, if set#if#(#osFamily#!=#null#&&#!#Os#.#isFamily#(#osFamily#)#)#{#return#false#;#}#//the Exec OS check is different from Os.isOs(), which#//probes for a specific OS. Instead it searches the os field#//for the current os.name#String#myos#=#System#.#getProperty#(#"os.name"#)#;#log#(#"Current OS is "#+#myos#,#Project#.#MSG_VERBOSE#)#;#if#(#(#os#!=#null#)#&&#(#os#.#indexOf#(#myos#)#<#0#)#)#{#// this command will be executed only on the specified OS#log#(#"This OS, "#+#myos#+#" was not found in the specified list of valid OSes: "#+#os#,#Project#.#MSG_VERBOSE#)#;#return#false#;#}#return#true#;#}##void#setVMLauncher#(#boolean#vmLauncher#)#{#this#.#vmLauncher#=#vmLauncher#;#}##Execute#prepareExec#(#)#throws#BuildException#{#// default directory to the project's base directory#if#(#dir#==#null#)#{#dir#=#getProject#(#)#.#getBaseDir#(#)#;#}#if#(#redirectorElement#!=#null#)#{#redirectorElement#.#configure#(#redirector#)#;#}#Execute#exe#=#new#Execute#(#createHandler#(#)#,#createWatchdog#(#)#)#;#exe#.#setAntRun#(#getProject#(#)#)#;#exe#.#setWorkingDirectory#(#dir#)#;#exe#.#setVMLauncher#(#vmLauncher#)#;#String#[#]#environment#=#env#.#getVariables#(#)#;#if#(#environment#!=#null#)#{#for#(#int#i#=#0#;#i#<#environment#.#length#;#i#++#)#{#log#(#"Setting environment variable: "#+#environment#[#i#]#,#Project#.#MSG_VERBOSE#)#;#}#}#exe#.#setNewenvironment#(#newEnvironment#)#;#exe#.#setEnvironment#(#environment#)#;#return#exe#;#}##void#runExecute#(#Execute#exe#)#throws#IOException#{#int#returnCode#=#-#1#;#// assume the worst#if#(#!#spawn#)#{#returnCode#=#exe#.#execute#(#)#;#//test for and handle a forced process death#if#(#exe#.#killedProcess#(#)#)#{#String#msg#=#"Timeout: killed the sub-process"#;#if#(#failOnError#)#{#throw#new#BuildException#(#msg#)#;#}#else#{#log#(#msg#,#Project#.#MSG_WARN#)#;#}#}#maybeSetResultPropertyValue#(#returnCode#)#;#redirector#.#complete#(#)#;#if#(#Execute#.#isFailure#(#returnCode#)#)#{#if#(#failOnError#)#{#throw#new#BuildException#(#getTaskType#(#)#+#" returned: "#+#returnCode#,#getLocation#(#)#)#;#}#else#{#log#(#"Result: "#+#returnCode#,#Project#.#MSG_ERR#)#;#}#}#}#else#{#exe#.#spawn#(#)#;#}#}##void#runExec#(#Execute#exe#)#throws#BuildException#{#// show the command#log#(#cmdl#.#describeCommand#(#)#,#Project#.#MSG_VERBOSE#)#;#exe#.#setCommandline#(#cmdl#.#getCommandline#(#)#)#;#try#{#runExecute#(#exe#)#;#}#catch#(#IOException#e#)#{#if#(#failIfExecFails#)#{#throw#new#BuildException#(#"Execute failed: "#+#e#.#toString#(#)#,#e#,#getLocation#(#)#)#;#}#else#{#log#(#"Execute failed: "#+#e#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}#}#finally#{#// close the output file if required#logFlush#(#)#;#}#}##ExecuteStreamHandler#createHandler#(#)#throws#BuildException#{#return#redirector#.#createHandler#(#)#;#}##ExecuteWatchdog#createWatchdog#(#)#throws#BuildException#{#return#(#timeout#==#null#)#?#null#:#new#ExecuteWatchdog#(#timeout#.#longValue#(#)#)#;#}##void#logFlush#(#)#{#}##boolean#isPath#(#String#line#)#{#return#line#.#startsWith#(#"PATH="#)#||#line#.#startsWith#(#"Path="#)#;#}##String#getPath#(#String#line#)#{#return#line#.#substring#(#"PATH="#.#length#(#)#)#;#}##