void#setUp#(#)#{#configureProject#(#BUILD_FILE#)#;#}##void#tearDown#(#)#{#if#(#logFile#!=#null#&&#logFile#.#exists#(#)#)#{#getProject#(#)#.#setProperty#(#"logFile"#,#logFile#.#getAbsolutePath#(#)#)#;#}#executeTarget#(#"cleanup"#)#;#}##void#testNoRedirect#(#)#{#executeTarget#(#"no-redirect"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected log content"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out"#+#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err"#,#getLog#(#)#)#;#}##void#testRedirect1#(#)#throws#IOException#{#executeTarget#(#"redirect1"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#+#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirect.out"#)#)#;#}##void#testRedirect2#(#)#throws#IOException#{#executeTarget#(#"redirect2"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#,#getFileString#(#"redirect.out"#)#)#;#assertEquals#(#"unexpected error output"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#,#getFileString#(#"redirect.err"#)#)#;#}##void#testRedirect3#(#)#throws#IOException#{#executeTarget#(#"redirect3"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected log content"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err"#,#getLog#(#)#)#;#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirect.out"#)#)#;#assertPropertyEquals#(#"redirect.out"#,#expectedOut#.#trim#(#)#)#;#}##void#testRedirect4#(#)#throws#IOException#{#executeTarget#(#"redirect4"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#;#String#expectedErr#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirect.out"#)#)#;#assertPropertyEquals#(#"redirect.out"#,#expectedOut#.#trim#(#)#)#;#assertEquals#(#"unexpected error output"#,#expectedErr#,#getFileString#(#"redirect.err"#)#)#;#assertPropertyEquals#(#"redirect.err"#,#expectedErr#.#trim#(#)#)#;#}##void#testRedirect5#(#)#throws#IOException#{#testRedirect5or6#(#"redirect5"#)#;#}##void#testRedirect6#(#)#throws#IOException#{#testRedirect5or6#(#"redirect6"#)#;#}##void#testRedirect5or6#(#String#target#)#throws#IOException#{#executeTarget#(#target#)#;#if#(#getProject#(#)#.#getProperty#(#"wc.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#"3"#,#getFileString#(#"redirect.out"#)#.#trim#(#)#)#;#assertEquals#(#"property redirect.out"#,#"3"#,#getProject#(#)#.#getProperty#(#"redirect.out"#)#.#trim#(#)#)#;#assertNull#(#"unexpected error output"#,#getFileString#(#"redirect.err"#)#)#;#assertPropertyEquals#(#"redirect.err"#,#""#)#;#}##void#testRedirect7#(#)#throws#IOException#{#executeTarget#(#"redirect7"#)#;#if#(#getProject#(#)#.#getProperty#(#"wc.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#"3"#,#getFileString#(#"redirect.out"#)#.#trim#(#)#)#;#assertEquals#(#"property redirect.out"#,#"3"#,#getProject#(#)#.#getProperty#(#"redirect.out"#)#.#trim#(#)#)#;#assertNull#(#"unexpected error output"#,#getFileString#(#"redirect.err"#)#)#;#}##void#testRedirector1#(#)#{#executeTarget#(#"init"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#expectBuildException#(#"redirector1"#,#"cannot have > 1 nested <redirector>s"#)#;#}##void#testRedirector2#(#)#throws#IOException#{#executeTarget#(#"redirector2"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#+#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#,#getFileString#(#"redirector.out"#)#)#;#}##void#testRedirector3#(#)#throws#IOException#{#executeTarget#(#"redirector3"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#,#getFileString#(#"redirector.out"#)#)#;#assertEquals#(#"unexpected error output"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#,#getFileString#(#"redirector.err"#)#)#;#}##void#testRedirector4#(#)#throws#IOException#{#executeTarget#(#"redirector4"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#;#assertEquals#(#"unexpected log content"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err"#,#getLog#(#)#)#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirector.out"#)#)#;#assertPropertyEquals#(#"redirector.out"#,#expectedOut#.#trim#(#)#)#;#}##void#testRedirector5#(#)#throws#IOException#{#testRedirector5or6#(#"redirector5"#)#;#}##void#testRedirector6#(#)#throws#IOException#{#testRedirector5or6#(#"redirector6"#)#;#}##void#testRedirector5or6#(#String#target#)#throws#IOException#{#executeTarget#(#target#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#;#String#expectedErr#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err\n"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirector.out"#)#)#;#assertPropertyEquals#(#"redirector.out"#,#expectedOut#.#trim#(#)#)#;#assertEquals#(#"unexpected error output"#,#expectedErr#,#getFileString#(#"redirector.err"#)#)#;#assertPropertyEquals#(#"redirector.err"#,#expectedErr#.#trim#(#)#)#;#}##void#testRedirector7#(#)#throws#IOException#{#executeTarget#(#"redirector7"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out\n"#;#String#expectedErr#=#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" ERROR!!!\n"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirector.out"#)#)#;#assertPropertyEquals#(#"redirector.out"#,#expectedOut#.#trim#(#)#)#;#assertEquals#(#"unexpected error output"#,#expectedErr#,#getFileString#(#"redirector.err"#)#)#;#assertPropertyEquals#(#"redirector.err"#,#expectedErr#.#trim#(#)#)#;#}##void#testRedirector8#(#)#throws#IOException#{#executeTarget#(#"redirector8"#)#;#if#(#getProject#(#)#.#getProperty#(#"wc.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected output"#,#"3"#,#getFileString#(#"redirector.out"#)#.#trim#(#)#)#;#assertEquals#(#"property redirector.out"#,#"3"#,#getProject#(#)#.#getProperty#(#"redirector.out"#)#.#trim#(#)#)#;#assertNull#(#"unexpected error output"#,#getFileString#(#"redirector.err"#)#)#;#assertPropertyEquals#(#"redirector.err"#,#""#)#;#}##void#testRedirector9#(#)#throws#IOException#{#testRedirector9Thru12#(#"redirector9"#)#;#}##void#testRedirector10#(#)#throws#IOException#{#testRedirector9Thru12#(#"redirector10"#)#;#}##void#testRedirector11#(#)#throws#IOException#{#testRedirector9Thru12#(#"redirector11"#)#;#}##void#testRedirector12#(#)#throws#IOException#{#testRedirector9Thru12#(#"redirector12"#)#;#}##void#testRedirector9Thru12#(#String#target#)#throws#IOException#{#executeTarget#(#target#)#;#if#(#getProject#(#)#.#getProperty#(#"cat.can.run"#)#==#null#)#{#return#;#}#String#expectedOut#=#"blah after blah"#;#assertEquals#(#"unexpected output"#,#expectedOut#,#getFileString#(#"redirector.out"#)#.#trim#(#)#)#;#assertPropertyEquals#(#"redirector.out"#,#expectedOut#.#trim#(#)#)#;#assertNull#(#"unexpected error output"#,#getFileString#(#"redirector.err"#)#)#;#assertPropertyEquals#(#"redirector.err"#,#""#)#;#}##void#testRedirector13#(#)#{#executeTarget#(#"redirector13"#)#;#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#String#antfile#=#getProject#(#)#.#getProperty#(#"ant.file"#)#;#try#{#//no point in setting a message#assertEquals#(#antfile#+#" OUTPUT???"#+#antfile#+#" ERROR!!!"#,#getLog#(#)#)#;#}#catch#(#ComparisonFailure#cf#)#{#assertEquals#(#"unexpected log content"#,#antfile#+#" ERROR!!!"#+#antfile#+#" OUTPUT???"#,#getLog#(#)#)#;#}#}##void#testRedirector14#(#)#{#executeTarget#(#"redirector14"#)#;#if#(#getProject#(#)#.#getProperty#(#"cat.can.run"#)#==#null#)#{#return#;#}#assertEquals#(#"unexpected log output"#,#"blah after blah"#,#getLog#(#)#)#;#}##void#testRedirector15#(#)#throws#IOException#{#executeTarget#(#"redirector15"#)#;#if#(#getProject#(#)#.#getProperty#(#"cat.can.run"#)#==#null#)#{#return#;#}#assertTrue#(#"error with transcoding"#,#FILE_UTILS#.#contentEquals#(#getProject#(#)#.#resolveFile#(#"expected/utf-8"#)#,#getProject#(#)#.#resolveFile#(#"redirector.out"#)#)#)#;#}##void#testRedirector16#(#)#{#executeTarget#(#"redirector16"#)#;#}##void#testRedirector17#(#)#{#executeTarget#(#"redirector17"#)#;#}##void#testRedirector18#(#)#{#if#(#getProject#(#)#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#expectLog#(#"redirector18"#,#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" out"#+#getProject#(#)#.#getProperty#(#"ant.file"#)#+#" err"#)#;#}##void#testspawn#(#)#{#project#.#executeTarget#(#"init"#)#;#if#(#project#.#getProperty#(#"test.can.run"#)#==#null#)#{#return#;#}#myBuild#=#new#MonitoredBuild#(#new#File#(#System#.#getProperty#(#"root"#)#,#BUILD_FILE#)#,#"spawn"#)#;#logFile#=#FILE_UTILS#.#createTempFile#(#"spawn"#,#"log"#,#project#.#getBaseDir#(#)#,#false#,#false#)#;#// this is guaranteed by FileUtils#createTempFile#assertTrue#(#"log file not existing"#,#!#logFile#.#exists#(#)#)#;#// make the spawned process run 4 seconds#myBuild#.#setTimeToWait#(#TIME_TO_WAIT#)#;#myBuild#.#setLogFile#(#logFile#.#getAbsolutePath#(#)#)#;#myBuild#.#addBuildListener#(#new#MonitoredBuildListener#(#)#)#;#myBuild#.#start#(#)#;#GregorianCalendar#startwait#=#new#GregorianCalendar#(#)#;#// this loop runs parallel to the build#while#(#!#buildFinished#)#{#try#{#Thread#.#sleep#(#10#)#;#}#catch#(#InterruptedException#e#)#{#System#.#out#.#println#(#"my sleep was interrupted"#)#;#}#GregorianCalendar#now#=#new#GregorianCalendar#(#)#;#// security#if#(#now#.#getTime#(#)#.#getTime#(#)#-#startwait#.#getTime#(#)#.#getTime#(#)#>#MAX_BUILD_TIME#)#{#System#.#out#.#println#(#"aborting wait, too long "#+#(#now#.#getTime#(#)#.#getTime#(#)#-#startwait#.#getTime#(#)#.#getTime#(#)#)#+#"milliseconds"#)#;#break#;#}#}#// now wait until the spawned process is finished#try#{#Thread#.#sleep#(#(#TIME_TO_WAIT#)#*#1000#+#SECURITY_MARGIN#)#;#}#catch#(#InterruptedException#e#)#{#System#.#out#.#println#(#"my sleep was interrupted"#)#;#}#// time of the build in milli seconds#long#elapsed#=#myBuild#.#getTimeElapsed#(#)#;#assertTrue#(#"we waited more than the process lasted"#,#TIME_TO_WAIT#*#1000#+#SECURITY_MARGIN#>#elapsed#)#;#logFile#=#new#File#(#logFile#.#getAbsolutePath#(#)#)#;#assertTrue#(#"log file found after spawn"#,#logFile#.#exists#(#)#)#;#}##void#testExecUnknownOS#(#)#{#executeTarget#(#"testExecUnknownOS"#)#;#}##void#testExecOSFamily#(#)#{#executeTarget#(#"testExecOSFamily"#)#;#}##void#testExecInconsistentSettings#(#)#{#executeTarget#(#"testExecInconsistentSettings"#)#;#}##void#setLogFile#(#String#logFile#)#{#this#.#logFile#=#logFile#;#project#.#setProperty#(#"logFile"#,#logFile#)#;#}##void#setTimeToWait#(#int#timeToWait#)#{#this#.#timeToWait#=#timeToWait#;#project#.#setProperty#(#"timeToWait"#,#Long#.#toString#(#timeToWait#)#)#;#}##void#addBuildListener#(#BuildListener#bl#)#{#project#.#addBuildListener#(#bl#)#;#}##long#getTimeElapsed#(#)#{#return#timeFinished#.#getTime#(#)#.#getTime#(#)#-#timeStarted#.#getTime#(#)#.#getTime#(#)#;#}##void#start#(#)#{#worker#=#new#Thread#(#this#,#myBuildFile#.#toString#(#)#+#"/"#+#target#)#;#worker#.#start#(#)#;#}##void#run#(#)#{#startProject#(#)#;#}##void#startProject#(#)#{#timeStarted#=#new#GregorianCalendar#(#)#;#project#.#executeTarget#(#target#)#;#timeFinished#=#new#GregorianCalendar#(#)#;#}##void#buildStarted#(#BuildEvent#event#)#{#}##void#buildFinished#(#BuildEvent#event#)#{#}##void#targetStarted#(#BuildEvent#event#)#{#}##void#targetFinished#(#BuildEvent#event#)#{#if#(#event#.#getTarget#(#)#.#getName#(#)#.#equals#(#"spawn"#)#)#{#buildFinished#=#true#;#}#}##void#taskStarted#(#BuildEvent#event#)#{#}##void#taskFinished#(#BuildEvent#event#)#{#}##void#messageLogged#(#BuildEvent#event#)#{#}##String#getFileString#(#String#filename#)#throws#IOException#{#String#result#=#null#;#FileReader#reader#=#null#;#try#{#reader#=#new#FileReader#(#getProject#(#)#.#resolveFile#(#filename#)#)#;#result#=#FileUtils#.#readFully#(#reader#)#;#}#catch#(#IOException#eyeOhEx#)#{#}#finally#{#FileUtils#.#close#(#reader#)#;#}#return#result#;#}##