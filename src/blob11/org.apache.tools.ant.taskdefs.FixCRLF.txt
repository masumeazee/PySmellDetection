Reader#chain#(#final#Reader#rdr#)#{#return#filter#.#chain#(#rdr#)#;#}##void#setSrcdir#(#File#srcDir#)#{#this#.#srcDir#=#srcDir#;#}##void#setDestdir#(#File#destDir#)#{#this#.#destDir#=#destDir#;#}##void#setJavafiles#(#boolean#javafiles#)#{#filter#.#setJavafiles#(#javafiles#)#;#}##void#setFile#(#File#file#)#{#this#.#file#=#file#;#}##void#setEol#(#CrLf#attr#)#{#filter#.#setEol#(#FixCrLfFilter#.#CrLf#.#newInstance#(#attr#.#getValue#(#)#)#)#;#}##void#setCr#(#AddAsisRemove#attr#)#{#log#(#"DEPRECATED: The cr attribute has been deprecated,"#,#Project#.#MSG_WARN#)#;#log#(#"Please use the eol attribute instead"#,#Project#.#MSG_WARN#)#;#String#option#=#attr#.#getValue#(#)#;#CrLf#c#=#new#CrLf#(#)#;#if#(#option#.#equals#(#"remove"#)#)#{#c#.#setValue#(#"lf"#)#;#}#else#if#(#option#.#equals#(#"asis"#)#)#{#c#.#setValue#(#"asis"#)#;#}#else#{#// must be "add"#c#.#setValue#(#"crlf"#)#;#}#setEol#(#c#)#;#}##void#setTab#(#AddAsisRemove#attr#)#{#filter#.#setTab#(#FixCrLfFilter#.#AddAsisRemove#.#newInstance#(#attr#.#getValue#(#)#)#)#;#}##void#setTablength#(#int#tlength#)#throws#BuildException#{#try#{#filter#.#setTablength#(#tlength#)#;#}#catch#(#IOException#e#)#{#// filter.setTablength throws IOException that would better be#// a BuildException#throw#new#BuildException#(#e#.#getMessage#(#)#,#e#)#;#}#}##void#setEof#(#AddAsisRemove#attr#)#{#filter#.#setEof#(#FixCrLfFilter#.#AddAsisRemove#.#newInstance#(#attr#.#getValue#(#)#)#)#;#}##void#setEncoding#(#String#encoding#)#{#this#.#encoding#=#encoding#;#}##void#setOutputEncoding#(#String#outputEncoding#)#{#this#.#outputEncoding#=#outputEncoding#;#}##void#setFixlast#(#boolean#fixlast#)#{#filter#.#setFixlast#(#fixlast#)#;#}##void#setPreserveLastModified#(#boolean#preserve#)#{#preserveLastModified#=#preserve#;#}##void#execute#(#)#throws#BuildException#{#// first off, make sure that we've got a srcdir and destdir#validate#(#)#;#// log options used#String#enc#=#encoding#==#null#?#"default"#:#encoding#;#log#(#"options:"#+#" eol="#+#filter#.#getEol#(#)#.#getValue#(#)#+#" tab="#+#filter#.#getTab#(#)#.#getValue#(#)#+#" eof="#+#filter#.#getEof#(#)#.#getValue#(#)#+#" tablength="#+#filter#.#getTablength#(#)#+#" encoding="#+#enc#+#" outputencoding="#+#(#outputEncoding#==#null#?#enc#:#outputEncoding#)#,#Project#.#MSG_VERBOSE#)#;#DirectoryScanner#ds#=#super#.#getDirectoryScanner#(#srcDir#)#;#String#[#]#files#=#ds#.#getIncludedFiles#(#)#;#for#(#int#i#=#0#;#i#<#files#.#length#;#i#++#)#{#processFile#(#files#[#i#]#)#;#}#}##void#validate#(#)#throws#BuildException#{#if#(#file#!=#null#)#{#if#(#srcDir#!=#null#)#{#throw#new#BuildException#(#ERROR_FILE_AND_SRCDIR#)#;#}#//patch file into the fileset#fileset#.#setFile#(#file#)#;#//set our parent dir#srcDir#=#file#.#getParentFile#(#)#;#}#if#(#srcDir#==#null#)#{#throw#new#BuildException#(#FIXCRLF_ERROR#+#"srcdir attribute must be set!"#)#;#}#if#(#!#srcDir#.#exists#(#)#)#{#throw#new#BuildException#(#FIXCRLF_ERROR#+#"srcdir does not exist: '"#+#srcDir#+#"'"#)#;#}#if#(#!#srcDir#.#isDirectory#(#)#)#{#throw#new#BuildException#(#FIXCRLF_ERROR#+#"srcdir is not a directory: '"#+#srcDir#+#"'"#)#;#}#if#(#destDir#!=#null#)#{#if#(#!#destDir#.#exists#(#)#)#{#throw#new#BuildException#(#FIXCRLF_ERROR#+#"destdir does not exist: '"#+#destDir#+#"'"#)#;#}#if#(#!#destDir#.#isDirectory#(#)#)#{#throw#new#BuildException#(#FIXCRLF_ERROR#+#"destdir is not a directory: '"#+#destDir#+#"'"#)#;#}#}#}##void#processFile#(#String#file#)#throws#BuildException#{#File#srcFile#=#new#File#(#srcDir#,#file#)#;#long#lastModified#=#srcFile#.#lastModified#(#)#;#File#destD#=#destDir#==#null#?#srcDir#:#destDir#;#if#(#fcv#==#null#)#{#FilterChain#fc#=#new#FilterChain#(#)#;#fc#.#add#(#filter#)#;#fcv#=#new#Vector#(#1#)#;#fcv#.#add#(#fc#)#;#}#File#tmpFile#=#FILE_UTILS#.#createTempFile#(#"fixcrlf"#,#""#,#null#,#true#,#false#)#;#try#{#FILE_UTILS#.#copyFile#(#srcFile#,#tmpFile#,#null#,#fcv#,#false#,#false#,#encoding#,#outputEncoding#==#null#?#encoding#:#outputEncoding#,#getProject#(#)#)#;#File#destFile#=#new#File#(#destD#,#file#)#;#boolean#destIsWrong#=#true#;#if#(#destFile#.#exists#(#)#)#{#// Compare the destination with the temp file#log#(#"destFile "#+#destFile#+#" exists"#,#Project#.#MSG_DEBUG#)#;#destIsWrong#=#!#FILE_UTILS#.#contentEquals#(#destFile#,#tmpFile#)#;#log#(#destFile#+#(#destIsWrong#?#" is being written"#:#" is not written, as the contents are identical"#)#,#Project#.#MSG_DEBUG#)#;#}#if#(#destIsWrong#)#{#FILE_UTILS#.#rename#(#tmpFile#,#destFile#)#;#if#(#preserveLastModified#)#{#log#(#"preserved lastModified for "#+#destFile#,#Project#.#MSG_DEBUG#)#;#FILE_UTILS#.#setFileLastModified#(#destFile#,#lastModified#)#;#}#}#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#"error running fixcrlf on file "#+#srcFile#,#e#)#;#}#finally#{#if#(#tmpFile#!=#null#&&#tmpFile#.#exists#(#)#)#{#FILE_UTILS#.#tryHardToDelete#(#tmpFile#)#;#}#}#}##void#nextLine#(#)#throws#BuildException#{#int#ch#=#-#1#;#int#eolcount#=#0#;#eolStr#=#new#StringBuffer#(#)#;#line#=#new#StringBuffer#(#)#;#try#{#ch#=#reader#.#read#(#)#;#while#(#ch#!=#-#1#&&#ch#!=#'\r'#&&#ch#!=#'\n'#)#{#line#.#append#(#(#char#)#ch#)#;#ch#=#reader#.#read#(#)#;#}#if#(#ch#==#-#1#&&#line#.#length#(#)#==#0#)#{#// Eof has been reached#reachedEof#=#true#;#return#;#}#switch#(#(#char#)#ch#)#{#case#'\r'#:#// Check for \r, \r\n and \r\r\n#// Regard \r\r not followed by \n as two lines#++#eolcount#;#eolStr#.#append#(#'\r'#)#;#reader#.#mark#(#2#)#;#ch#=#reader#.#read#(#)#;#switch#(#ch#)#{#case#'\r'#:#ch#=#reader#.#read#(#)#;#if#(#(#char#)#(#ch#)#==#'\n'#)#{#eolcount#+=#2#;#eolStr#.#append#(#"\r\n"#)#;#}#else#{#reader#.#reset#(#)#;#}#break#;#case#'\n'#:#++#eolcount#;#eolStr#.#append#(#'\n'#)#;#break#;#case#-#1#:#// don't reposition when we've reached the end#// of the stream#break#;#default#:#reader#.#reset#(#)#;#break#;#}#// end of switch ((char)(ch = reader.read()))#break#;#case#'\n'#:#++#eolcount#;#eolStr#.#append#(#'\n'#)#;#break#;#default#:#// Fall tru#}#// end of switch ((char) ch)#// if at eolcount == 0 and trailing characters of string#// are CTRL-Zs, set eofStr#if#(#eolcount#==#0#)#{#int#i#=#line#.#length#(#)#;#while#(#--#i#>=#0#&&#line#.#charAt#(#i#)#==#CTRLZ#)#{#// keep searching for the first ^Z#}#if#(#i#<#line#.#length#(#)#-#1#)#{#// Trailing characters are ^Zs#// Construct new line and eofStr#eofStr#.#append#(#line#.#toString#(#)#.#substring#(#i#+#1#)#)#;#if#(#i#<#0#)#{#line#.#setLength#(#0#)#;#reachedEof#=#true#;#}#else#{#line#.#setLength#(#i#+#1#)#;#}#}#}#// end of if (eolcount == 0)#}#catch#(#IOException#e#)#{#throw#new#BuildException#(#srcFile#+#": "#+#e#.#getMessage#(#)#,#e#,#getLocation#(#)#)#;#}#}##String#getEofStr#(#)#{#return#eofStr#.#substring#(#0#)#;#}##int#getState#(#)#{#return#state#;#}##void#setState#(#int#state#)#{#this#.#state#=#state#;#}##boolean#hasMoreElements#(#)#{#return#!#reachedEof#;#}##Object#nextElement#(#)#throws#NoSuchElementException#{#if#(#!#hasMoreElements#(#)#)#{#throw#new#NoSuchElementException#(#"OneLiner"#)#;#}#BufferLine#tmpLine#=#new#BufferLine#(#line#.#toString#(#)#,#eolStr#.#substring#(#0#)#)#;#nextLine#(#)#;#return#tmpLine#;#}##void#close#(#)#throws#IOException#{#if#(#reader#!=#null#)#{#reader#.#close#(#)#;#}#}##int#getNext#(#)#{#return#next#;#}##void#setNext#(#int#next#)#{#this#.#next#=#next#;#}##int#getLookahead#(#)#{#return#lookahead#;#}##void#setLookahead#(#int#lookahead#)#{#this#.#lookahead#=#lookahead#;#}##char#getChar#(#int#i#)#{#return#line#.#charAt#(#i#)#;#}##char#getNextChar#(#)#{#return#getChar#(#next#)#;#}##char#getNextCharInc#(#)#{#return#getChar#(#next#++#)#;#}##int#getColumn#(#)#{#return#column#;#}##void#setColumn#(#int#col#)#{#column#=#col#;#}##int#incColumn#(#)#{#return#column#++#;#}##int#length#(#)#{#return#line#.#length#(#)#;#}##int#getEolLength#(#)#{#return#eolStr#.#length#(#)#;#}##String#getLineString#(#)#{#return#line#;#}##String#getEol#(#)#{#return#eolStr#;#}##String#substring#(#int#begin#)#{#return#line#.#substring#(#begin#)#;#}##String#substring#(#int#begin#,#int#end#)#{#return#line#.#substring#(#begin#,#end#)#;#}##void#setState#(#int#state#)#{#OneLiner#.#this#.#setState#(#state#)#;#}##int#getState#(#)#{#return#OneLiner#.#this#.#getState#(#)#;#}##String#[#]#getValues#(#)#{#return#new#String#[#]#{#"add"#,#"asis"#,#"remove"#}#;#}##String#[#]#getValues#(#)#{#return#new#String#[#]#{#"asis"#,#"cr"#,#"lf"#,#"crlf"#,#"mac"#,#"unix"#,#"dos"#}#;#}##