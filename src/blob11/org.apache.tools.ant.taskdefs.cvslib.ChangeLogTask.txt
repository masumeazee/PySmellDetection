void#setDir#(#final#File#inputDir#)#{#this#.#inputDir#=#inputDir#;#}##void#setDestfile#(#final#File#destFile#)#{#this#.#destFile#=#destFile#;#}##void#setUsersfile#(#final#File#usersFile#)#{#this#.#usersFile#=#usersFile#;#}##void#addUser#(#final#CvsUser#user#)#{#cvsUsers#.#addElement#(#user#)#;#}##void#setStart#(#final#Date#start#)#{#this#.#startDate#=#start#;#}##void#setEnd#(#final#Date#endDate#)#{#this#.#endDate#=#endDate#;#}##void#setDaysinpast#(#final#int#days#)#{#// CheckStyle:MagicNumber OFF#final#long#time#=#System#.#currentTimeMillis#(#)#-#(#long#)#days#*#24#*#60#*#60#*#1000#;#// CheckStyle:MagicNumber ON#setStart#(#new#Date#(#time#)#)#;#}##void#setRemote#(#final#boolean#remote#)#{#this#.#remote#=#remote#;#}##void#setStartTag#(#final#String#start#)#{#this#.#startTag#=#start#;#}##void#setEndTag#(#final#String#end#)#{#this#.#endTag#=#end#;#}##void#addFileset#(#final#FileSet#fileSet#)#{#filesets#.#addElement#(#fileSet#)#;#}##void#execute#(#)#throws#BuildException#{#File#savedDir#=#inputDir#;#// may be altered in validate#try#{#validate#(#)#;#final#Properties#userList#=#new#Properties#(#)#;#loadUserlist#(#userList#)#;#for#(#int#i#=#0#,#size#=#cvsUsers#.#size#(#)#;#i#<#size#;#i#++#)#{#final#CvsUser#user#=#(#CvsUser#)#cvsUsers#.#get#(#i#)#;#user#.#validate#(#)#;#userList#.#put#(#user#.#getUserID#(#)#,#user#.#getDisplayname#(#)#)#;#}#if#(#!#remote#)#{#setCommand#(#"log"#)#;#if#(#getTag#(#)#!=#null#)#{#CvsVersion#myCvsVersion#=#new#CvsVersion#(#)#;#myCvsVersion#.#setProject#(#getProject#(#)#)#;#myCvsVersion#.#setTaskName#(#"cvsversion"#)#;#myCvsVersion#.#setCvsRoot#(#getCvsRoot#(#)#)#;#myCvsVersion#.#setCvsRsh#(#getCvsRsh#(#)#)#;#myCvsVersion#.#setPassfile#(#getPassFile#(#)#)#;#myCvsVersion#.#setDest#(#inputDir#)#;#myCvsVersion#.#execute#(#)#;#if#(#myCvsVersion#.#supportsCvsLogWithSOption#(#)#)#{#addCommandArgument#(#"-S"#)#;#}#}#}#else#{#// supply 'rlog' as argument instead of command#setCommand#(#""#)#;#addCommandArgument#(#"rlog"#)#;#// Do not print name/header if no revisions#// selected. This is quicker: less output to parse.#addCommandArgument#(#"-S"#)#;#// Do not list tags. This is quicker: less output to#// parse.#addCommandArgument#(#"-N"#)#;#}#if#(#null#!=#startTag#||#null#!=#endTag#)#{#// man, do I get spoiled by C#'s ?? operator#String#startValue#=#startTag#==#null#?#""#:#startTag#;#String#endValue#=#endTag#==#null#?#""#:#endTag#;#addCommandArgument#(#"-r"#+#startValue#+#"::"#+#endValue#)#;#}#else#if#(#null#!=#startDate#)#{#final#SimpleDateFormat#outputDate#=#new#SimpleDateFormat#(#"yyyy-MM-dd"#)#;#// We want something of the form: -d ">=YYYY-MM-dd"#final#String#dateRange#=#">="#+#outputDate#.#format#(#startDate#)#;#// Supply '-d' as a separate argument - Bug# 14397#addCommandArgument#(#"-d"#)#;#addCommandArgument#(#dateRange#)#;#}#// Check if list of files to check has been specified#if#(#!#filesets#.#isEmpty#(#)#)#{#final#Enumeration#e#=#filesets#.#elements#(#)#;#while#(#e#.#hasMoreElements#(#)#)#{#final#FileSet#fileSet#=#(#FileSet#)#e#.#nextElement#(#)#;#final#DirectoryScanner#scanner#=#fileSet#.#getDirectoryScanner#(#getProject#(#)#)#;#final#String#[#]#files#=#scanner#.#getIncludedFiles#(#)#;#for#(#int#i#=#0#;#i#<#files#.#length#;#i#++#)#{#addCommandArgument#(#files#[#i#]#)#;#}#}#}#final#ChangeLogParser#parser#=#new#ChangeLogParser#(#remote#,#getPackage#(#)#,#getModules#(#)#)#;#final#RedirectingStreamHandler#handler#=#new#RedirectingStreamHandler#(#parser#)#;#log#(#getCommand#(#)#,#Project#.#MSG_VERBOSE#)#;#setDest#(#inputDir#)#;#setExecuteStreamHandler#(#handler#)#;#try#{#super#.#execute#(#)#;#}#finally#{#final#String#errors#=#handler#.#getErrors#(#)#;#if#(#null#!=#errors#)#{#log#(#errors#,#Project#.#MSG_ERR#)#;#}#}#final#CVSEntry#[#]#entrySet#=#parser#.#getEntrySetAsArray#(#)#;#final#CVSEntry#[#]#filteredEntrySet#=#filterEntrySet#(#entrySet#)#;#replaceAuthorIdWithName#(#userList#,#filteredEntrySet#)#;#writeChangeLog#(#filteredEntrySet#)#;#}#finally#{#inputDir#=#savedDir#;#}#}##void#validate#(#)#throws#BuildException#{#if#(#null#==#inputDir#)#{#inputDir#=#getProject#(#)#.#getBaseDir#(#)#;#}#if#(#null#==#destFile#)#{#final#String#message#=#"Destfile must be set."#;#throw#new#BuildException#(#message#)#;#}#if#(#!#inputDir#.#exists#(#)#)#{#final#String#message#=#"Cannot find base dir "#+#inputDir#.#getAbsolutePath#(#)#;#throw#new#BuildException#(#message#)#;#}#if#(#null#!=#usersFile#&&#!#usersFile#.#exists#(#)#)#{#final#String#message#=#"Cannot find user lookup list "#+#usersFile#.#getAbsolutePath#(#)#;#throw#new#BuildException#(#message#)#;#}#if#(#(#null#!=#startTag#||#null#!=#endTag#)#&&#(#null#!=#startDate#||#null#!=#endDate#)#)#{#final#String#message#=#"Specify either a tag or date range,"#+#" not both"#;#throw#new#BuildException#(#message#)#;#}#}##void#loadUserlist#(#final#Properties#userList#)#throws#BuildException#{#if#(#null#!=#usersFile#)#{#try#{#userList#.#load#(#new#FileInputStream#(#usersFile#)#)#;#}#catch#(#final#IOException#ioe#)#{#throw#new#BuildException#(#ioe#.#toString#(#)#,#ioe#)#;#}#}#}##CVSEntry#[#]#filterEntrySet#(#final#CVSEntry#[#]#entrySet#)#{#final#Vector#results#=#new#Vector#(#)#;#for#(#int#i#=#0#;#i#<#entrySet#.#length#;#i#++#)#{#final#CVSEntry#cvsEntry#=#entrySet#[#i#]#;#final#Date#date#=#cvsEntry#.#getDate#(#)#;#//bug#30471#//this is caused by Date.after throwing a NullPointerException#//for some reason there's no date set in the CVSEntry#//Java 1.3.1 API#//http://java.sun.com/j2se/1.3/docs/api/java/util/Date.html#after(java.util.Date)#//doesn't throw NullPointerException#//Java 1.4.2 + 1.5 API#//http://java.sun.com/j2se/1.4.2/docs/api/java/util/Date.html#after(java.util.Date)#//according to the docs it doesn't throw, according to the bug report it does#//http://java.sun.com/j2se/1.5.0/docs/api/java/util/Date.html#after(java.util.Date)#//according to the docs it does throw#//for now skip entries which are missing a date#if#(#null#==#date#)#{#continue#;#}#if#(#null#!=#startDate#&&#startDate#.#after#(#date#)#)#{#//Skip dates that are too early#continue#;#}#if#(#null#!=#endDate#&&#endDate#.#before#(#date#)#)#{#//Skip dates that are too late#continue#;#}#results#.#addElement#(#cvsEntry#)#;#}#final#CVSEntry#[#]#resultArray#=#new#CVSEntry#[#results#.#size#(#)#]#;#results#.#copyInto#(#resultArray#)#;#return#resultArray#;#}##void#replaceAuthorIdWithName#(#final#Properties#userList#,#final#CVSEntry#[#]#entrySet#)#{#for#(#int#i#=#0#;#i#<#entrySet#.#length#;#i#++#)#{#final#CVSEntry#entry#=#entrySet#[#i#]#;#if#(#userList#.#containsKey#(#entry#.#getAuthor#(#)#)#)#{#entry#.#setAuthor#(#userList#.#getProperty#(#entry#.#getAuthor#(#)#)#)#;#}#}#}##void#writeChangeLog#(#final#CVSEntry#[#]#entrySet#)#throws#BuildException#{#FileOutputStream#output#=#null#;#try#{#output#=#new#FileOutputStream#(#destFile#)#;#final#PrintWriter#writer#=#new#PrintWriter#(#new#OutputStreamWriter#(#output#,#"UTF-8"#)#)#;#final#ChangeLogWriter#serializer#=#new#ChangeLogWriter#(#)#;#serializer#.#printChangeLog#(#writer#,#entrySet#)#;#if#(#writer#.#checkError#(#)#)#{#throw#new#IOException#(#"Encountered an error writing changelog"#)#;#}#}#catch#(#final#UnsupportedEncodingException#uee#)#{#getProject#(#)#.#log#(#uee#.#toString#(#)#,#Project#.#MSG_ERR#)#;#}#catch#(#final#IOException#ioe#)#{#throw#new#BuildException#(#ioe#.#toString#(#)#,#ioe#)#;#}#finally#{#FileUtils#.#close#(#output#)#;#}#}##