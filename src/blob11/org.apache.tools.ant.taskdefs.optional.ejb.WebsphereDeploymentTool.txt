Path#createWASClasspath#(#)#{#if#(#wasClasspath#==#null#)#{#wasClasspath#=#new#Path#(#getTask#(#)#.#getProject#(#)#)#;#}#return#wasClasspath#.#createPath#(#)#;#}##void#setWASClasspath#(#Path#wasClasspath#)#{#this#.#wasClasspath#=#wasClasspath#;#}##void#setDbvendor#(#String#dbvendor#)#{#this#.#dbVendor#=#dbvendor#;#}##void#setDbname#(#String#dbName#)#{#this#.#dbName#=#dbName#;#}##void#setDbschema#(#String#dbSchema#)#{#this#.#dbSchema#=#dbSchema#;#}##void#setCodegen#(#boolean#codegen#)#{#this#.#codegen#=#codegen#;#}##void#setQuiet#(#boolean#quiet#)#{#this#.#quiet#=#quiet#;#}##void#setNovalidate#(#boolean#novalidate#)#{#this#.#novalidate#=#novalidate#;#}##void#setNowarn#(#boolean#nowarn#)#{#this#.#nowarn#=#nowarn#;#}##void#setNoinform#(#boolean#noinform#)#{#this#.#noinform#=#noinform#;#}##void#setTrace#(#boolean#trace#)#{#this#.#trace#=#trace#;#}##void#setRmicoptions#(#String#options#)#{#this#.#rmicOptions#=#options#;#}##void#setUse35#(#boolean#attr#)#{#use35MappingRules#=#attr#;#}##void#setRebuild#(#boolean#rebuild#)#{#this#.#alwaysRebuild#=#rebuild#;#}##void#setSuffix#(#String#inString#)#{#this#.#jarSuffix#=#inString#;#}##void#setKeepgeneric#(#boolean#inValue#)#{#this#.#keepGeneric#=#inValue#;#}##void#setEjbdeploy#(#boolean#ejbdeploy#)#{#this#.#ejbdeploy#=#ejbdeploy#;#}##void#setEJBdtd#(#String#inString#)#{#this#.#ejb11DTD#=#inString#;#}##void#setOldCMP#(#boolean#oldCMP#)#{#this#.#newCMP#=#!#oldCMP#;#}##void#setNewCMP#(#boolean#newCMP#)#{#this#.#newCMP#=#newCMP#;#}##void#setTempdir#(#String#tempdir#)#{#this#.#tempdir#=#tempdir#;#}##DescriptorHandler#getDescriptorHandler#(#File#srcDir#)#{#DescriptorHandler#handler#=#new#DescriptorHandler#(#getTask#(#)#,#srcDir#)#;#// register all the DTDs, both the ones that are known and#// any supplied by the user#handler#.#registerDTD#(#PUBLICID_EJB11#,#ejb11DTD#)#;#for#(#Iterator#i#=#getConfig#(#)#.#dtdLocations#.#iterator#(#)#;#i#.#hasNext#(#)#;#)#{#EjbJar#.#DTDLocation#dtdLocation#=#(#EjbJar#.#DTDLocation#)#i#.#next#(#)#;#handler#.#registerDTD#(#dtdLocation#.#getPublicId#(#)#,#dtdLocation#.#getLocation#(#)#)#;#}#return#handler#;#}##DescriptorHandler#getWebsphereDescriptorHandler#(#final#File#srcDir#)#{#DescriptorHandler#handler#=#new#DescriptorHandler#(#getTask#(#)#,#srcDir#)#{#protected#void#processElement#(#)#{#}#}#;#for#(#Iterator#i#=#getConfig#(#)#.#dtdLocations#.#iterator#(#)#;#i#.#hasNext#(#)#;#)#{#EjbJar#.#DTDLocation#dtdLocation#=#(#EjbJar#.#DTDLocation#)#i#.#next#(#)#;#handler#.#registerDTD#(#dtdLocation#.#getPublicId#(#)#,#dtdLocation#.#getLocation#(#)#)#;#}#return#handler#;#}##void#processElement#(#)#{#}##void#addVendorFiles#(#Hashtable#ejbFiles#,#String#baseName#)#{#String#ddPrefix#=#(#usingBaseJarName#(#)#?#""#:#baseName#)#;#String#dbPrefix#=#(#dbVendor#==#null#)#?#""#:#dbVendor#+#"-"#;#// Get the Extensions document#File#websphereEXT#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#WAS_EXT#)#;#if#(#websphereEXT#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#WAS_EXT#,#websphereEXT#)#;#}#else#{#log#(#"Unable to locate websphere extensions. "#+#"It was expected to be in "#+#websphereEXT#.#getPath#(#)#,#Project#.#MSG_VERBOSE#)#;#}#File#websphereBND#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#WAS_BND#)#;#if#(#websphereBND#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#WAS_BND#,#websphereBND#)#;#}#else#{#log#(#"Unable to locate websphere bindings. "#+#"It was expected to be in "#+#websphereBND#.#getPath#(#)#,#Project#.#MSG_VERBOSE#)#;#}#if#(#!#newCMP#)#{#log#(#"The old method for locating CMP files has been DEPRECATED."#,#Project#.#MSG_VERBOSE#)#;#log#(#"Please adjust your websphere descriptor and set "#+#"newCMP=\"true\" to use the new CMP descriptor "#+#"inclusion mechanism. "#,#Project#.#MSG_VERBOSE#)#;#}#else#{#// We attempt to put in the MAP and Schema files of CMP beans#try#{#// Add the Map file#File#websphereMAP#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#dbPrefix#+#WAS_CMP_MAP#)#;#if#(#websphereMAP#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#WAS_CMP_MAP#,#websphereMAP#)#;#}#else#{#log#(#"Unable to locate the websphere Map: "#+#websphereMAP#.#getPath#(#)#,#Project#.#MSG_VERBOSE#)#;#}#File#websphereSchema#=#new#File#(#getConfig#(#)#.#descriptorDir#,#ddPrefix#+#dbPrefix#+#WAS_CMP_SCHEMA#)#;#if#(#websphereSchema#.#exists#(#)#)#{#ejbFiles#.#put#(#META_DIR#+#SCHEMA_DIR#+#WAS_CMP_SCHEMA#,#websphereSchema#)#;#}#else#{#log#(#"Unable to locate the websphere Schema: "#+#websphereSchema#.#getPath#(#)#,#Project#.#MSG_VERBOSE#)#;#}#// Theres nothing else to see here...keep moving sonny#}#catch#(#Exception#e#)#{#String#msg#=#"Exception while adding Vendor specific files: "#+#e#.#toString#(#)#;#throw#new#BuildException#(#msg#,#e#)#;#}#}#}##File#getVendorOutputJarFile#(#String#baseName#)#{#return#new#File#(#getDestDir#(#)#,#baseName#+#jarSuffix#)#;#}##String#getOptions#(#)#{#// Set the options#StringBuffer#options#=#new#StringBuffer#(#)#;#if#(#dbVendor#!=#null#)#{#options#.#append#(#" -dbvendor "#)#.#append#(#dbVendor#)#;#}#if#(#dbName#!=#null#)#{#options#.#append#(#" -dbname \""#)#.#append#(#dbName#)#.#append#(#"\""#)#;#}#if#(#dbSchema#!=#null#)#{#options#.#append#(#" -dbschema \""#)#.#append#(#dbSchema#)#.#append#(#"\""#)#;#}#if#(#codegen#)#{#options#.#append#(#" -codegen"#)#;#}#if#(#quiet#)#{#options#.#append#(#" -quiet"#)#;#}#if#(#novalidate#)#{#options#.#append#(#" -novalidate"#)#;#}#if#(#nowarn#)#{#options#.#append#(#" -nowarn"#)#;#}#if#(#noinform#)#{#options#.#append#(#" -noinform"#)#;#}#if#(#trace#)#{#options#.#append#(#" -trace"#)#;#}#if#(#use35MappingRules#)#{#options#.#append#(#" -35"#)#;#}#if#(#rmicOptions#!=#null#)#{#options#.#append#(#" -rmic \""#)#.#append#(#rmicOptions#)#.#append#(#"\""#)#;#}#return#options#.#toString#(#)#;#}##void#buildWebsphereJar#(#File#sourceJar#,#File#destJar#)#{#try#{#if#(#ejbdeploy#)#{#Java#javaTask#=#new#Java#(#getTask#(#)#)#;#// Set the JvmArgs#javaTask#.#createJvmarg#(#)#.#setValue#(#"-Xms64m"#)#;#javaTask#.#createJvmarg#(#)#.#setValue#(#"-Xmx128m"#)#;#// Set the Environment variable#Environment#.#Variable#var#=#new#Environment#.#Variable#(#)#;#var#.#setKey#(#"websphere.lib.dir"#)#;#File#libdir#=#new#File#(#websphereHome#,#"lib"#)#;#var#.#setValue#(#libdir#.#getAbsolutePath#(#)#)#;#javaTask#.#addSysproperty#(#var#)#;#// Set the working directory#javaTask#.#setDir#(#websphereHome#)#;#// Set the Java class name#javaTask#.#setTaskName#(#"ejbdeploy"#)#;#javaTask#.#setClassname#(#"com.ibm.etools.ejbdeploy.EJBDeploy"#)#;#javaTask#.#createArg#(#)#.#setValue#(#sourceJar#.#getPath#(#)#)#;#javaTask#.#createArg#(#)#.#setValue#(#tempdir#)#;#javaTask#.#createArg#(#)#.#setValue#(#destJar#.#getPath#(#)#)#;#javaTask#.#createArg#(#)#.#setLine#(#getOptions#(#)#)#;#if#(#getCombinedClasspath#(#)#!=#null#&&#getCombinedClasspath#(#)#.#toString#(#)#.#length#(#)#>#0#)#{#javaTask#.#createArg#(#)#.#setValue#(#"-cp"#)#;#javaTask#.#createArg#(#)#.#setValue#(#getCombinedClasspath#(#)#.#toString#(#)#)#;#}#Path#classpath#=#wasClasspath#;#if#(#classpath#==#null#)#{#classpath#=#getCombinedClasspath#(#)#;#}#javaTask#.#setFork#(#true#)#;#if#(#classpath#!=#null#)#{#javaTask#.#setClasspath#(#classpath#)#;#}#log#(#"Calling websphere.ejbdeploy for "#+#sourceJar#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#javaTask#.#execute#(#)#;#}#}#catch#(#Exception#e#)#{#// Have to catch this because of the semantics of calling main()#String#msg#=#"Exception while calling ejbdeploy. Details: "#+#e#.#toString#(#)#;#throw#new#BuildException#(#msg#,#e#)#;#}#}##void#writeJar#(#String#baseName#,#File#jarFile#,#Hashtable#files#,#String#publicId#)#throws#BuildException#{#if#(#ejbdeploy#)#{#// create the -generic.jar, if required#File#genericJarFile#=#super#.#getVendorOutputJarFile#(#baseName#)#;#super#.#writeJar#(#baseName#,#genericJarFile#,#files#,#publicId#)#;#// create the output .jar, if required#if#(#alwaysRebuild#||#isRebuildRequired#(#genericJarFile#,#jarFile#)#)#{#buildWebsphereJar#(#genericJarFile#,#jarFile#)#;#}#if#(#!#keepGeneric#)#{#log#(#"deleting generic jar "#+#genericJarFile#.#toString#(#)#,#Project#.#MSG_VERBOSE#)#;#genericJarFile#.#delete#(#)#;#}#}#else#{#// create the "undeployed" output .jar, if required#super#.#writeJar#(#baseName#,#jarFile#,#files#,#publicId#)#;#}#}##void#validateConfigured#(#)#throws#BuildException#{#super#.#validateConfigured#(#)#;#if#(#ejbdeploy#)#{#String#home#=#getTask#(#)#.#getProject#(#)#.#getProperty#(#"websphere.home"#)#;#if#(#home#==#null#)#{#throw#new#BuildException#(#"The 'websphere.home' property must "#+#"be set when 'ejbdeploy=true'"#)#;#}#websphereHome#=#getTask#(#)#.#getProject#(#)#.#resolveFile#(#home#)#;#}#}##boolean#isRebuildRequired#(#File#genericJarFile#,#File#websphereJarFile#)#{#boolean#rebuild#=#false#;#JarFile#genericJar#=#null#;#JarFile#wasJar#=#null#;#File#newwasJarFile#=#null#;#JarOutputStream#newJarStream#=#null#;#ClassLoader#genericLoader#=#null#;#try#{#log#(#"Checking if websphere Jar needs to be rebuilt for jar "#+#websphereJarFile#.#getName#(#)#,#Project#.#MSG_VERBOSE#)#;#// Only go forward if the generic and the websphere file both exist#if#(#genericJarFile#.#exists#(#)#&&#genericJarFile#.#isFile#(#)#&&#websphereJarFile#.#exists#(#)#&&#websphereJarFile#.#isFile#(#)#)#{#//open jar files#genericJar#=#new#JarFile#(#genericJarFile#)#;#wasJar#=#new#JarFile#(#websphereJarFile#)#;#Hashtable#genericEntries#=#new#Hashtable#(#)#;#Hashtable#wasEntries#=#new#Hashtable#(#)#;#Hashtable#replaceEntries#=#new#Hashtable#(#)#;#//get the list of generic jar entries#for#(#Enumeration#e#=#genericJar#.#entries#(#)#;#e#.#hasMoreElements#(#)#;#)#{#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#genericEntries#.#put#(#je#.#getName#(#)#.#replace#(#'\\'#,#'/'#)#,#je#)#;#}#//get the list of websphere jar entries#for#(#Enumeration#e#=#wasJar#.#entries#(#)#;#e#.#hasMoreElements#(#)#;#)#{#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#wasEntries#.#put#(#je#.#getName#(#)#,#je#)#;#}#//Cycle Through generic and make sure its in websphere#genericLoader#=#getClassLoaderFromJar#(#genericJarFile#)#;#for#(#Enumeration#e#=#genericEntries#.#keys#(#)#;#e#.#hasMoreElements#(#)#;#)#{#String#filepath#=#(#String#)#e#.#nextElement#(#)#;#if#(#wasEntries#.#containsKey#(#filepath#)#)#{#// File name/path match#// Check files see if same#JarEntry#genericEntry#=#(#JarEntry#)#genericEntries#.#get#(#filepath#)#;#JarEntry#wasEntry#=#(#JarEntry#)#wasEntries#.#get#(#filepath#)#;#if#(#(#genericEntry#.#getCrc#(#)#!=#wasEntry#.#getCrc#(#)#)#||#(#genericEntry#.#getSize#(#)#!=#wasEntry#.#getSize#(#)#)#)#{#if#(#genericEntry#.#getName#(#)#.#endsWith#(#".class"#)#)#{#//File are different see if its an object or an interface#String#classname#=#genericEntry#.#getName#(#)#.#replace#(#File#.#separatorChar#,#'.'#)#;#classname#=#classname#.#substring#(#0#,#classname#.#lastIndexOf#(#".class"#)#)#;#Class#genclass#=#genericLoader#.#loadClass#(#classname#)#;#if#(#genclass#.#isInterface#(#)#)#{#//Interface changed   rebuild jar.#log#(#"Interface "#+#genclass#.#getName#(#)#+#" has changed"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#break#;#}#else#{#//Object class Changed   update it.#replaceEntries#.#put#(#filepath#,#genericEntry#)#;#}#}#else#{#// is it the manifest. If so ignore it#if#(#!#genericEntry#.#getName#(#)#.#equals#(#"META-INF/MANIFEST.MF"#)#)#{#//File other then class changed   rebuild#log#(#"Non class file "#+#genericEntry#.#getName#(#)#+#" has changed"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#}#break#;#}#}#}#else#{#// a file doesn't exist rebuild#log#(#"File "#+#filepath#+#" not present in websphere jar"#,#Project#.#MSG_VERBOSE#)#;#rebuild#=#true#;#break#;#}#}#if#(#!#rebuild#)#{#log#(#"No rebuild needed - updating jar"#,#Project#.#MSG_VERBOSE#)#;#newwasJarFile#=#new#File#(#websphereJarFile#.#getAbsolutePath#(#)#+#".temp"#)#;#if#(#newwasJarFile#.#exists#(#)#)#{#newwasJarFile#.#delete#(#)#;#}#newJarStream#=#new#JarOutputStream#(#new#FileOutputStream#(#newwasJarFile#)#)#;#newJarStream#.#setLevel#(#0#)#;#//Copy files from old websphere jar#for#(#Enumeration#e#=#wasEntries#.#elements#(#)#;#e#.#hasMoreElements#(#)#;#)#{#byte#[#]#buffer#=#new#byte#[#DEFAULT_BUFFER_SIZE#]#;#int#bytesRead#;#InputStream#is#;#JarEntry#je#=#(#JarEntry#)#e#.#nextElement#(#)#;#if#(#je#.#getCompressedSize#(#)#==#-#1#||#je#.#getCompressedSize#(#)#==#je#.#getSize#(#)#)#{#newJarStream#.#setLevel#(#0#)#;#}#else#{#newJarStream#.#setLevel#(#JAR_COMPRESS_LEVEL#)#;#}#// Update with changed Bean class#if#(#replaceEntries#.#containsKey#(#je#.#getName#(#)#)#)#{#log#(#"Updating Bean class from generic Jar "#+#je#.#getName#(#)#,#Project#.#MSG_VERBOSE#)#;#// Use the entry from the generic jar#je#=#(#JarEntry#)#replaceEntries#.#get#(#je#.#getName#(#)#)#;#is#=#genericJar#.#getInputStream#(#je#)#;#}#else#{#//use fle from original websphere jar#is#=#wasJar#.#getInputStream#(#je#)#;#}#newJarStream#.#putNextEntry#(#new#JarEntry#(#je#.#getName#(#)#)#)#;#while#(#(#bytesRead#=#is#.#read#(#buffer#)#)#!=#-#1#)#{#newJarStream#.#write#(#buffer#,#0#,#bytesRead#)#;#}#is#.#close#(#)#;#}#}#else#{#log#(#"websphere Jar rebuild needed due to changed "#+#"interface or XML"#,#Project#.#MSG_VERBOSE#)#;#}#}#else#{#rebuild#=#true#;#}#}#catch#(#ClassNotFoundException#cnfe#)#{#String#cnfmsg#=#"ClassNotFoundException while processing ejb-jar file"#+#". Details: "#+#cnfe#.#getMessage#(#)#;#throw#new#BuildException#(#cnfmsg#,#cnfe#)#;#}#catch#(#IOException#ioe#)#{#String#msg#=#"IOException while processing ejb-jar file "#+#". Details: "#+#ioe#.#getMessage#(#)#;#throw#new#BuildException#(#msg#,#ioe#)#;#}#finally#{#// need to close files and perhaps rename output#if#(#genericJar#!=#null#)#{#try#{#genericJar#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// Ignore#}#}#if#(#wasJar#!=#null#)#{#try#{#wasJar#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// Ignore#}#}#if#(#newJarStream#!=#null#)#{#try#{#newJarStream#.#close#(#)#;#}#catch#(#IOException#closeException#)#{#// Ignore#}#try#{#FILE_UTILS#.#rename#(#newwasJarFile#,#websphereJarFile#)#;#}#catch#(#IOException#renameException#)#{#log#(#renameException#.#getMessage#(#)#,#Project#.#MSG_WARN#)#;#rebuild#=#true#;#}#}#if#(#genericLoader#!=#null#&&#genericLoader#instanceof#AntClassLoader#)#{#AntClassLoader#loader#=#(#AntClassLoader#)#genericLoader#;#loader#.#cleanup#(#)#;#}#}#return#rebuild#;#}##ClassLoader#getClassLoaderFromJar#(#File#classjar#)#throws#IOException#{#Path#lookupPath#=#new#Path#(#getTask#(#)#.#getProject#(#)#)#;#lookupPath#.#setLocation#(#classjar#)#;#Path#classpath#=#getCombinedClasspath#(#)#;#if#(#classpath#!=#null#)#{#lookupPath#.#append#(#classpath#)#;#}#return#getTask#(#)#.#getProject#(#)#.#createClassLoader#(#lookupPath#)#;#}##