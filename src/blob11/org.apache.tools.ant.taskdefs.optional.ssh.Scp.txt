void#setFile#(#String#aFromUri#)#{#setFromUri#(#aFromUri#)#;#this#.#isFromRemote#=#isRemoteUri#(#this#.#fromUri#)#;#}##void#setTodir#(#String#aToUri#)#{#setToUri#(#aToUri#)#;#this#.#isToRemote#=#isRemoteUri#(#this#.#toUri#)#;#}##void#setLocalFile#(#String#aFromUri#)#{#setFromUri#(#aFromUri#)#;#this#.#isFromRemote#=#false#;#}##void#setRemoteFile#(#String#aFromUri#)#{#validateRemoteUri#(#"remoteFile"#,#aFromUri#)#;#setFromUri#(#aFromUri#)#;#this#.#isFromRemote#=#true#;#}##void#setLocalTodir#(#String#aToUri#)#{#setToUri#(#aToUri#)#;#this#.#isToRemote#=#false#;#}##void#setPreservelastmodified#(#boolean#yesOrNo#)#{#this#.#preserveLastModified#=#yesOrNo#;#}##void#setRemoteTodir#(#String#aToUri#)#{#validateRemoteUri#(#"remoteToDir"#,#aToUri#)#;#setToUri#(#aToUri#)#;#this#.#isToRemote#=#true#;#}##void#validateRemoteUri#(#String#type#,#String#aToUri#)#{#if#(#!#isRemoteUri#(#aToUri#)#)#{#throw#new#BuildException#(#type#+#" '"#+#aToUri#+#"' is invalid. "#+#"The 'remoteToDir' attribute must "#+#"have syntax like the "#+#"following: user:password@host:/path"#+#" - the :password part is optional"#)#;#}#}##void#setLocalTofile#(#String#aToUri#)#{#setToUri#(#aToUri#)#;#this#.#isToRemote#=#false#;#}##void#setRemoteTofile#(#String#aToUri#)#{#validateRemoteUri#(#"remoteToFile"#,#aToUri#)#;#setToUri#(#aToUri#)#;#this#.#isToRemote#=#true#;#}##void#setSftp#(#boolean#yesOrNo#)#{#isSftp#=#yesOrNo#;#}##void#addFileset#(#FileSet#set#)#{#if#(#fileSets#==#null#)#{#fileSets#=#new#LinkedList#(#)#;#}#fileSets#.#add#(#set#)#;#}##void#init#(#)#throws#BuildException#{#super#.#init#(#)#;#this#.#toUri#=#null#;#this#.#fromUri#=#null#;#this#.#fileSets#=#null#;#}##void#execute#(#)#throws#BuildException#{#if#(#toUri#==#null#)#{#throw#exactlyOne#(#TO_ATTRS#)#;#}#if#(#fromUri#==#null#&&#fileSets#==#null#)#{#throw#exactlyOne#(#FROM_ATTRS#,#"one or more nested filesets"#)#;#}#try#{#if#(#isFromRemote#&&#!#isToRemote#)#{#download#(#fromUri#,#toUri#)#;#}#else#if#(#!#isFromRemote#&&#isToRemote#)#{#if#(#fileSets#!=#null#)#{#upload#(#fileSets#,#toUri#)#;#}#else#{#upload#(#fromUri#,#toUri#)#;#}#}#else#if#(#isFromRemote#&&#isToRemote#)#{#throw#new#BuildException#(#"Copying from a remote server to a remote server is not supported."#)#;#}#else#{#throw#new#BuildException#(#"'todir' and 'file' attributes "#+#"must have syntax like the following: "#+#"user:password@host:/path"#)#;#}#}#catch#(#Exception#e#)#{#if#(#getFailonerror#(#)#)#{#if#(#e#instanceof#BuildException#)#{#BuildException#be#=#(#BuildException#)#e#;#if#(#be#.#getLocation#(#)#==#null#)#{#be#.#setLocation#(#getLocation#(#)#)#;#}#throw#be#;#}#else#{#throw#new#BuildException#(#e#)#;#}#}#else#{#log#(#"Caught exception: "#+#e#.#getMessage#(#)#,#Project#.#MSG_ERR#)#;#}#}#}##void#download#(#String#fromSshUri#,#String#toPath#)#throws#JSchException#,#IOException#{#String#file#=#parseUri#(#fromSshUri#)#;#Session#session#=#null#;#try#{#session#=#openSession#(#)#;#ScpFromMessage#message#=#null#;#if#(#!#isSftp#)#{#message#=#new#ScpFromMessage#(#getVerbose#(#)#,#session#,#file#,#getProject#(#)#.#resolveFile#(#toPath#)#,#fromSshUri#.#endsWith#(#"*"#)#,#preserveLastModified#)#;#}#else#{#message#=#new#ScpFromMessageBySftp#(#getVerbose#(#)#,#session#,#file#,#getProject#(#)#.#resolveFile#(#toPath#)#,#fromSshUri#.#endsWith#(#"*"#)#,#preserveLastModified#)#;#}#log#(#"Receiving file: "#+#file#)#;#message#.#setLogListener#(#this#)#;#message#.#execute#(#)#;#}#finally#{#if#(#session#!=#null#)#{#session#.#disconnect#(#)#;#}#}#}##void#upload#(#List#fileSet#,#String#toSshUri#)#throws#IOException#,#JSchException#{#String#file#=#parseUri#(#toSshUri#)#;#Session#session#=#null#;#try#{#List#list#=#new#ArrayList#(#fileSet#.#size#(#)#)#;#for#(#Iterator#i#=#fileSet#.#iterator#(#)#;#i#.#hasNext#(#)#;#)#{#FileSet#set#=#(#FileSet#)#i#.#next#(#)#;#Directory#d#=#createDirectory#(#set#)#;#if#(#d#!=#null#)#{#list#.#add#(#d#)#;#}#}#if#(#!#list#.#isEmpty#(#)#)#{#session#=#openSession#(#)#;#ScpToMessage#message#=#null#;#if#(#!#isSftp#)#{#message#=#new#ScpToMessage#(#getVerbose#(#)#,#session#,#list#,#file#)#;#}#else#{#message#=#new#ScpToMessageBySftp#(#getVerbose#(#)#,#session#,#list#,#file#)#;#}#message#.#setLogListener#(#this#)#;#message#.#execute#(#)#;#}#}#finally#{#if#(#session#!=#null#)#{#session#.#disconnect#(#)#;#}#}#}##void#upload#(#String#fromPath#,#String#toSshUri#)#throws#IOException#,#JSchException#{#String#file#=#parseUri#(#toSshUri#)#;#Session#session#=#null#;#try#{#session#=#openSession#(#)#;#ScpToMessage#message#=#null#;#if#(#!#isSftp#)#{#message#=#new#ScpToMessage#(#getVerbose#(#)#,#session#,#getProject#(#)#.#resolveFile#(#fromPath#)#,#file#)#;#}#else#{#message#=#new#ScpToMessageBySftp#(#getVerbose#(#)#,#session#,#getProject#(#)#.#resolveFile#(#fromPath#)#,#file#)#;#}#message#.#setLogListener#(#this#)#;#message#.#execute#(#)#;#}#finally#{#if#(#session#!=#null#)#{#session#.#disconnect#(#)#;#}#}#}##String#parseUri#(#String#uri#)#{#int#indexOfAt#=#uri#.#indexOf#(#'@'#)#;#int#indexOfColon#=#uri#.#indexOf#(#':'#)#;#if#(#indexOfColon#>#-#1#&&#indexOfColon#<#indexOfAt#)#{#// user:password@host:/path notation#// everything upto the last @ before the last : is considered#// password. (so if the path contains an @ and a : it will not work)#int#indexOfCurrentAt#=#indexOfAt#;#int#indexOfLastColon#=#uri#.#lastIndexOf#(#':'#)#;#while#(#indexOfCurrentAt#>#-#1#&&#indexOfCurrentAt#<#indexOfLastColon#)#{#indexOfAt#=#indexOfCurrentAt#;#indexOfCurrentAt#=#uri#.#indexOf#(#'@'#,#indexOfCurrentAt#+#1#)#;#}#setUsername#(#uri#.#substring#(#0#,#indexOfColon#)#)#;#setPassword#(#uri#.#substring#(#indexOfColon#+#1#,#indexOfAt#)#)#;#}#else#if#(#indexOfAt#>#-#1#)#{#// no password, will require keyfile#setUsername#(#uri#.#substring#(#0#,#indexOfAt#)#)#;#}#else#{#throw#new#BuildException#(#"no username was given.  Can't authenticate."#)#;#}#if#(#getUserInfo#(#)#.#getPassword#(#)#==#null#&&#getUserInfo#(#)#.#getKeyfile#(#)#==#null#)#{#throw#new#BuildException#(#"neither password nor keyfile for user "#+#getUserInfo#(#)#.#getName#(#)#+#" has been "#+#"given.  Can't authenticate."#)#;#}#int#indexOfPath#=#uri#.#indexOf#(#':'#,#indexOfAt#+#1#)#;#if#(#indexOfPath#==#-#1#)#{#throw#new#BuildException#(#"no remote path in "#+#uri#)#;#}#setHost#(#uri#.#substring#(#indexOfAt#+#1#,#indexOfPath#)#)#;#String#remotePath#=#uri#.#substring#(#indexOfPath#+#1#)#;#if#(#remotePath#.#equals#(#""#)#)#{#remotePath#=#"."#;#}#return#remotePath#;#}##boolean#isRemoteUri#(#String#uri#)#{#boolean#isRemote#=#true#;#int#indexOfAt#=#uri#.#indexOf#(#'@'#)#;#if#(#indexOfAt#<#0#)#{#isRemote#=#false#;#}#return#isRemote#;#}##Directory#createDirectory#(#FileSet#set#)#{#DirectoryScanner#scanner#=#set#.#getDirectoryScanner#(#getProject#(#)#)#;#Directory#root#=#new#Directory#(#scanner#.#getBasedir#(#)#)#;#String#[#]#files#=#scanner#.#getIncludedFiles#(#)#;#if#(#files#.#length#!=#0#)#{#for#(#int#j#=#0#;#j#<#files#.#length#;#j#++#)#{#String#[#]#path#=#Directory#.#getPath#(#files#[#j#]#)#;#Directory#current#=#root#;#File#currentParent#=#scanner#.#getBasedir#(#)#;#for#(#int#i#=#0#;#i#<#path#.#length#;#i#++#)#{#File#file#=#new#File#(#currentParent#,#path#[#i#]#)#;#if#(#file#.#isDirectory#(#)#)#{#current#.#addDirectory#(#new#Directory#(#file#)#)#;#current#=#current#.#getChild#(#file#)#;#currentParent#=#current#.#getDirectory#(#)#;#}#else#if#(#file#.#isFile#(#)#)#{#current#.#addFile#(#file#)#;#}#}#}#}#else#{#// skip#root#=#null#;#}#return#root#;#}##void#setFromUri#(#String#fromUri#)#{#if#(#this#.#fromUri#!=#null#)#{#throw#exactlyOne#(#FROM_ATTRS#)#;#}#this#.#fromUri#=#fromUri#;#}##void#setToUri#(#String#toUri#)#{#if#(#this#.#toUri#!=#null#)#{#throw#exactlyOne#(#TO_ATTRS#)#;#}#this#.#toUri#=#toUri#;#}##BuildException#exactlyOne#(#String#[#]#attrs#)#{#return#exactlyOne#(#attrs#,#null#)#;#}##BuildException#exactlyOne#(#String#[#]#attrs#,#String#alt#)#{#StringBuffer#buf#=#new#StringBuffer#(#"Exactly one of "#)#.#append#(#'['#)#.#append#(#attrs#[#0#]#)#;#for#(#int#i#=#1#;#i#<#attrs#.#length#;#i#++#)#{#buf#.#append#(#'|'#)#.#append#(#attrs#[#i#]#)#;#}#buf#.#append#(#']'#)#;#if#(#alt#!=#null#)#{#buf#.#append#(#" or "#)#.#append#(#alt#)#;#}#return#new#BuildException#(#buf#.#append#(#" is required."#)#.#toString#(#)#)#;#}##