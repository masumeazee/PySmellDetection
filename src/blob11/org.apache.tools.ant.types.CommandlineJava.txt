String#[#]#getVariables#(#)#throws#BuildException#{#List#definitions#=#new#LinkedList#(#)#;#ListIterator#list#=#definitions#.#listIterator#(#)#;#addDefinitionsToList#(#list#)#;#if#(#definitions#.#size#(#)#==#0#)#{#return#null#;#}#else#{#return#(#String#[#]#)#definitions#.#toArray#(#new#String#[#definitions#.#size#(#)#]#)#;#}#}##void#addDefinitionsToList#(#ListIterator#listIt#)#{#String#[#]#props#=#super#.#getVariables#(#)#;#if#(#props#!=#null#)#{#for#(#int#i#=#0#;#i#<#props#.#length#;#i#++#)#{#listIt#.#add#(#"-D"#+#props#[#i#]#)#;#}#}#Properties#propertySetProperties#=#mergePropertySets#(#)#;#for#(#Enumeration#e#=#propertySetProperties#.#keys#(#)#;#e#.#hasMoreElements#(#)#;#)#{#String#key#=#(#String#)#e#.#nextElement#(#)#;#String#value#=#propertySetProperties#.#getProperty#(#key#)#;#listIt#.#add#(#"-D"#+#key#+#"="#+#value#)#;#}#}##int#size#(#)#{#Properties#p#=#mergePropertySets#(#)#;#return#variables#.#size#(#)#+#p#.#size#(#)#;#}##void#setSystem#(#)#throws#BuildException#{#try#{#sys#=#System#.#getProperties#(#)#;#Properties#p#=#new#Properties#(#)#;#for#(#Enumeration#e#=#sys#.#propertyNames#(#)#;#e#.#hasMoreElements#(#)#;#)#{#String#name#=#(#String#)#e#.#nextElement#(#)#;#String#value#=#sys#.#getProperty#(#name#)#;#if#(#name#!=#null#&&#value#!=#null#)#{#p#.#put#(#name#,#value#)#;#}#}#p#.#putAll#(#mergePropertySets#(#)#)#;#for#(#Enumeration#e#=#variables#.#elements#(#)#;#e#.#hasMoreElements#(#)#;#)#{#Environment#.#Variable#v#=#(#Environment#.#Variable#)#e#.#nextElement#(#)#;#v#.#validate#(#)#;#p#.#put#(#v#.#getKey#(#)#,#v#.#getValue#(#)#)#;#}#System#.#setProperties#(#p#)#;#}#catch#(#SecurityException#e#)#{#throw#new#BuildException#(#"Cannot modify system properties"#,#e#)#;#}#}##void#restoreSystem#(#)#throws#BuildException#{#if#(#sys#==#null#)#{#throw#new#BuildException#(#"Unbalanced nesting of SysProperties"#)#;#}#try#{#System#.#setProperties#(#sys#)#;#sys#=#null#;#}#catch#(#SecurityException#e#)#{#throw#new#BuildException#(#"Cannot modify system properties"#,#e#)#;#}#}##Object#clone#(#)#throws#CloneNotSupportedException#{#try#{#SysProperties#c#=#(#SysProperties#)#super#.#clone#(#)#;#c#.#variables#=#(#Vector#)#variables#.#clone#(#)#;#c#.#propertySets#=#(#Vector#)#propertySets#.#clone#(#)#;#return#c#;#}#catch#(#CloneNotSupportedException#e#)#{#return#null#;#}#}##void#addSyspropertyset#(#PropertySet#ps#)#{#propertySets#.#addElement#(#ps#)#;#}##void#addSysproperties#(#SysProperties#ps#)#{#variables#.#addAll#(#ps#.#variables#)#;#propertySets#.#addAll#(#ps#.#propertySets#)#;#}##Properties#mergePropertySets#(#)#{#Properties#p#=#new#Properties#(#)#;#for#(#Enumeration#e#=#propertySets#.#elements#(#)#;#e#.#hasMoreElements#(#)#;#)#{#PropertySet#ps#=#(#PropertySet#)#e#.#nextElement#(#)#;#p#.#putAll#(#ps#.#getProperties#(#)#)#;#}#return#p#;#}##Commandline#.#Argument#createArgument#(#)#{#return#javaCommand#.#createArgument#(#)#;#}##Commandline#.#Argument#createVmArgument#(#)#{#return#vmCommand#.#createArgument#(#)#;#}##void#addSysproperty#(#Environment#.#Variable#sysp#)#{#sysProperties#.#addVariable#(#sysp#)#;#}##void#addSyspropertyset#(#PropertySet#sysp#)#{#sysProperties#.#addSyspropertyset#(#sysp#)#;#}##void#addSysproperties#(#SysProperties#sysp#)#{#sysProperties#.#addSysproperties#(#sysp#)#;#}##void#setVm#(#String#vm#)#{#vmCommand#.#setExecutable#(#vm#)#;#}##void#setVmversion#(#String#value#)#{#vmVersion#=#value#;#}##void#setCloneVm#(#boolean#cloneVm#)#{#this#.#cloneVm#=#cloneVm#;#}##Assertions#getAssertions#(#)#{#return#assertions#;#}##void#setAssertions#(#Assertions#assertions#)#{#this#.#assertions#=#assertions#;#}##void#setJar#(#String#jarpathname#)#{#javaCommand#.#setExecutable#(#jarpathname#)#;#executeJar#=#true#;#}##String#getJar#(#)#{#if#(#executeJar#)#{#return#javaCommand#.#getExecutable#(#)#;#}#return#null#;#}##void#setClassname#(#String#classname#)#{#javaCommand#.#setExecutable#(#classname#)#;#executeJar#=#false#;#}##String#getClassname#(#)#{#if#(#!#executeJar#)#{#return#javaCommand#.#getExecutable#(#)#;#}#return#null#;#}##Path#createClasspath#(#Project#p#)#{#if#(#classpath#==#null#)#{#classpath#=#new#Path#(#p#)#;#}#return#classpath#;#}##Path#createBootclasspath#(#Project#p#)#{#if#(#bootclasspath#==#null#)#{#bootclasspath#=#new#Path#(#p#)#;#}#return#bootclasspath#;#}##String#getVmversion#(#)#{#return#vmVersion#;#}##String#[#]#getCommandline#(#)#{#//create the list#List#commands#=#new#LinkedList#(#)#;#final#ListIterator#listIterator#=#commands#.#listIterator#(#)#;#//fill it#addCommandsToList#(#listIterator#)#;#//convert to an array#return#(#String#[#]#)#commands#.#toArray#(#new#String#[#commands#.#size#(#)#]#)#;#}##void#addCommandsToList#(#final#ListIterator#listIterator#)#{#//create the command to run Java, including user specified options#getActualVMCommand#(#)#.#addCommandToList#(#listIterator#)#;#// properties are part of the vm options...#sysProperties#.#addDefinitionsToList#(#listIterator#)#;#if#(#isCloneVm#(#)#)#{#SysProperties#clonedSysProperties#=#new#SysProperties#(#)#;#PropertySet#ps#=#new#PropertySet#(#)#;#PropertySet#.#BuiltinPropertySetName#sys#=#new#PropertySet#.#BuiltinPropertySetName#(#)#;#sys#.#setValue#(#"system"#)#;#ps#.#appendBuiltin#(#sys#)#;#clonedSysProperties#.#addSyspropertyset#(#ps#)#;#clonedSysProperties#.#addDefinitionsToList#(#listIterator#)#;#}#//boot classpath#Path#bcp#=#calculateBootclasspath#(#true#)#;#if#(#bcp#.#size#(#)#>#0#)#{#listIterator#.#add#(#"-Xbootclasspath:"#+#bcp#.#toString#(#)#)#;#}#//main classpath#if#(#haveClasspath#(#)#)#{#listIterator#.#add#(#"-classpath"#)#;#listIterator#.#add#(#classpath#.#concatSystemClasspath#(#"ignore"#)#.#toString#(#)#)#;#}#//now any assertions are added#if#(#getAssertions#(#)#!=#null#)#{#getAssertions#(#)#.#applyAssertions#(#listIterator#)#;#}#// JDK usage command line says that -jar must be the first option, as there is#// a bug in JDK < 1.4 that forces the jvm type to be specified as the first#// option, it is appended here as specified in the docs even though there is#// in fact no order.#if#(#executeJar#)#{#listIterator#.#add#(#"-jar"#)#;#}#// this is the classname to run as well as its arguments.#// in case of 'executeJar', the executable is a jar file.#javaCommand#.#addCommandToList#(#listIterator#)#;#}##void#setMaxmemory#(#String#max#)#{#this#.#maxMemory#=#max#;#}##String#toString#(#)#{#return#Commandline#.#toString#(#getCommandline#(#)#)#;#}##String#describeCommand#(#)#{#return#Commandline#.#describeCommand#(#getCommandline#(#)#)#;#}##String#describeJavaCommand#(#)#{#return#Commandline#.#describeCommand#(#getJavaCommand#(#)#)#;#}##Commandline#getActualVMCommand#(#)#{#Commandline#actualVMCommand#=#(#Commandline#)#vmCommand#.#clone#(#)#;#if#(#maxMemory#!=#null#)#{#if#(#vmVersion#.#startsWith#(#"1.1"#)#)#{#actualVMCommand#.#createArgument#(#)#.#setValue#(#"-mx"#+#maxMemory#)#;#}#else#{#actualVMCommand#.#createArgument#(#)#.#setValue#(#"-Xmx"#+#maxMemory#)#;#}#}#return#actualVMCommand#;#}##int#size#(#)#{#int#size#=#getActualVMCommand#(#)#.#size#(#)#+#javaCommand#.#size#(#)#+#sysProperties#.#size#(#)#;#// cloned system properties#if#(#isCloneVm#(#)#)#{#size#+=#System#.#getProperties#(#)#.#size#(#)#;#}#// classpath is "-classpath <classpath>" -> 2 args#if#(#haveClasspath#(#)#)#{#size#+=#2#;#}#// bootclasspath is "-Xbootclasspath:<classpath>" -> 1 arg#if#(#calculateBootclasspath#(#true#)#.#size#(#)#>#0#)#{#size#++#;#}#// jar execution requires an additional -jar option#if#(#executeJar#)#{#size#++#;#}#//assertions take up space too#if#(#getAssertions#(#)#!=#null#)#{#size#+=#getAssertions#(#)#.#size#(#)#;#}#return#size#;#}##Commandline#getJavaCommand#(#)#{#return#javaCommand#;#}##Commandline#getVmCommand#(#)#{#return#getActualVMCommand#(#)#;#}##Path#getClasspath#(#)#{#return#classpath#;#}##Path#getBootclasspath#(#)#{#return#bootclasspath#;#}##void#setSystemProperties#(#)#throws#BuildException#{#sysProperties#.#setSystem#(#)#;#}##void#restoreSystemProperties#(#)#throws#BuildException#{#sysProperties#.#restoreSystem#(#)#;#}##SysProperties#getSystemProperties#(#)#{#return#sysProperties#;#}##Object#clone#(#)#throws#CloneNotSupportedException#{#try#{#CommandlineJava#c#=#(#CommandlineJava#)#super#.#clone#(#)#;#c#.#vmCommand#=#(#Commandline#)#vmCommand#.#clone#(#)#;#c#.#javaCommand#=#(#Commandline#)#javaCommand#.#clone#(#)#;#c#.#sysProperties#=#(#SysProperties#)#sysProperties#.#clone#(#)#;#if#(#classpath#!=#null#)#{#c#.#classpath#=#(#Path#)#classpath#.#clone#(#)#;#}#if#(#bootclasspath#!=#null#)#{#c#.#bootclasspath#=#(#Path#)#bootclasspath#.#clone#(#)#;#}#if#(#assertions#!=#null#)#{#c#.#assertions#=#(#Assertions#)#assertions#.#clone#(#)#;#}#return#c#;#}#catch#(#CloneNotSupportedException#e#)#{#throw#new#BuildException#(#e#)#;#}#}##void#clearJavaArgs#(#)#{#javaCommand#.#clearArgs#(#)#;#}##boolean#haveClasspath#(#)#{#Path#fullClasspath#=#classpath#!=#null#?#classpath#.#concatSystemClasspath#(#"ignore"#)#:#null#;#return#fullClasspath#!=#null#&&#fullClasspath#.#toString#(#)#.#trim#(#)#.#length#(#)#>#0#;#}##boolean#haveBootclasspath#(#boolean#log#)#{#return#calculateBootclasspath#(#log#)#.#size#(#)#>#0#;#}##Path#calculateBootclasspath#(#boolean#log#)#{#if#(#vmVersion#.#startsWith#(#"1.1"#)#)#{#if#(#bootclasspath#!=#null#&&#log#)#{#bootclasspath#.#log#(#"Ignoring bootclasspath as "#+#"the target VM doesn't support it."#)#;#}#}#else#{#if#(#bootclasspath#!=#null#)#{#return#bootclasspath#.#concatSystemBootClasspath#(#isCloneVm#(#)#?#"last"#:#"ignore"#)#;#}#else#if#(#isCloneVm#(#)#)#{#return#Path#.#systemBootClasspath#;#}#}#return#new#Path#(#null#)#;#}##boolean#isCloneVm#(#)#{#return#cloneVm#||#"true"#.#equals#(#System#.#getProperty#(#"ant.build.clonevm"#)#)#;#}##