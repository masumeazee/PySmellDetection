String#getRevision#(#)#{#return#rmr#.#getRevision#(#)#;#}##long#getLastModified#(#)#{#return#-#1#;#}##String#getModule#(#)#{#return#module#;#}##void#setModule#(#String#module#)#{#this#.#module#=#module#;#}##String#getOrganisation#(#)#{#return#organisation#;#}##void#setOrganisation#(#String#organisation#)#{#this#.#organisation#=#organisation#;#}##String#getRevision#(#)#{#return#revision#;#}##void#setRevision#(#String#revision#)#{#this#.#revision#=#revision#;#}##String#getBranch#(#)#{#return#branch#;#}##void#setBranch#(#String#branch#)#{#this#.#branch#=#branch#;#}##String#getDefault#(#)#{#return#defaultValue#;#}##void#setDefault#(#String#default1#)#{#defaultValue#=#default1#;#}##String#getResolver#(#)#{#return#resolver#;#}##void#setResolver#(#String#resolver#)#{#this#.#resolver#=#resolver#;#}##String#getPrefix#(#)#{#return#prefix#;#}##void#setPrefix#(#String#prefix#)#{#this#.#prefix#=#prefix#;#}##void#doExecute#(#)#throws#BuildException#{#if#(#organisation#==#null#)#{#throw#new#BuildException#(#"no organisation provided for ivy buildnumber task"#)#;#}#if#(#module#==#null#)#{#throw#new#BuildException#(#"no module name provided for ivy buildnumber task"#)#;#}#if#(#prefix#==#null#)#{#throw#new#BuildException#(#"null prefix not allowed"#)#;#}#Ivy#ivy#=#getIvyInstance#(#)#;#IvySettings#settings#=#ivy#.#getSettings#(#)#;#if#(#branch#==#null#)#{#settings#.#getDefaultBranch#(#new#ModuleId#(#organisation#,#module#)#)#;#}#if#(#revision#==#null#||#revision#.#length#(#)#==#0#)#{#revision#=#"latest.integration"#;#}#else#if#(#!#revision#.#endsWith#(#"+"#)#)#{#revision#=#revision#+#"+"#;#}#if#(#!#prefix#.#endsWith#(#"."#)#&&#prefix#.#length#(#)#>#0#)#{#prefix#=#prefix#+#"."#;#}#SearchEngine#searcher#=#new#SearchEngine#(#settings#)#;#PatternMatcher#patternMatcher#=#new#PatternMatcher#(#)#{#private#PatternMatcher#exact#=#new#ExactPatternMatcher#(#)#;#private#PatternMatcher#regexp#=#new#ExactOrRegexpPatternMatcher#(#)#;#public#Matcher#getMatcher#(#String#expression#)#{#if#(#(#expression#==#organisation#)#||#(#expression#==#module#)#||#(#expression#==#branch#)#)#{#return#exact#.#getMatcher#(#expression#)#;#}#return#regexp#.#getMatcher#(#expression#)#;#}#public#String#getName#(#)#{#return#"buildnumber-matcher"#;#}#}#;#ModuleRevisionId#[#]#revisions#;#if#(#resolver#==#null#)#{#revisions#=#searcher#.#listModules#(#ModuleRevisionId#.#newInstance#(#organisation#,#module#,#branch#,#".*"#)#,#patternMatcher#)#;#}#else#{#DependencyResolver#depResolver#=#settings#.#getResolver#(#resolver#)#;#if#(#depResolver#==#null#)#{#throw#new#BuildException#(#"Unknown resolver: "#+#resolver#)#;#}#revisions#=#searcher#.#listModules#(#depResolver#,#ModuleRevisionId#.#newInstance#(#organisation#,#module#,#branch#,#".*"#)#,#patternMatcher#)#;#}#ArtifactInfo#[#]#infos#=#new#ArtifactInfo#[#revisions#.#length#]#;#for#(#int#i#=#0#;#i#<#revisions#.#length#;#i#++#)#{#infos#[#i#]#=#new#ResolvedModuleRevisionArtifactInfo#(#revisions#[#i#]#)#;#}#VersionMatcher#matcher#=#settings#.#getVersionMatcher#(#)#;#LatestStrategy#latestStrategy#=#settings#.#getLatestStrategy#(#"latest-revision"#)#;#List#sorted#=#latestStrategy#.#sort#(#infos#)#;#ModuleRevisionId#askedMrid#=#ModuleRevisionId#.#newInstance#(#organisation#,#module#,#branch#,#revision#)#;#String#foundRevision#=#null#;#for#(#ListIterator#iter#=#sorted#.#listIterator#(#sorted#.#size#(#)#)#;#iter#.#hasPrevious#(#)#;#)#{#ResolvedModuleRevisionArtifactInfo#info#=#(#ResolvedModuleRevisionArtifactInfo#)#iter#.#previous#(#)#;#if#(#!#matcher#.#accept#(#askedMrid#,#info#.#rmr#)#)#{#continue#;#}#if#(#matcher#.#needModuleDescriptor#(#askedMrid#,#info#.#rmr#)#)#{#ResolvedModuleRevision#rmr#=#ivy#.#findModule#(#info#.#rmr#)#;#if#(#matcher#.#accept#(#askedMrid#,#rmr#.#getDescriptor#(#)#)#)#{#foundRevision#=#info#.#rmr#.#getRevision#(#)#;#}#}#else#{#foundRevision#=#info#.#rmr#.#getRevision#(#)#;#}#if#(#foundRevision#!=#null#)#{#break#;#}#}#NewRevision#newRevision#=#computeNewRevision#(#foundRevision#)#;#setProperty#(#"revision"#,#newRevision#.#getRevision#(#)#)#;#setProperty#(#"new.revision"#,#newRevision#.#getNewRevision#(#)#)#;#setProperty#(#"build.number"#,#newRevision#.#getBuildNumber#(#)#)#;#setProperty#(#"new.build.number"#,#newRevision#.#getNewBuildNumber#(#)#)#;#}##Matcher#getMatcher#(#String#expression#)#{#if#(#(#expression#==#organisation#)#||#(#expression#==#module#)#||#(#expression#==#branch#)#)#{#return#exact#.#getMatcher#(#expression#)#;#}#return#regexp#.#getMatcher#(#expression#)#;#}##String#getName#(#)#{#return#"buildnumber-matcher"#;#}##void#setProperty#(#String#propertyName#,#String#value#)#{#if#(#value#!=#null#)#{#getProject#(#)#.#setProperty#(#prefix#+#propertyName#,#value#)#;#}#}##NewRevision#computeNewRevision#(#String#revision#)#{#String#revPrefix#=#"latest.integration"#.#equals#(#this#.#revision#)#?#""#:#this#.#revision#.#substring#(#0#,#this#.#revision#.#length#(#)#-#1#)#;#if#(#revision#!=#null#&&#!#revision#.#startsWith#(#revPrefix#)#)#{#throw#new#BuildException#(#"invalid exception found in repository: '"#+#revision#+#"' for '"#+#revPrefix#+#"'"#)#;#}#if#(#revision#==#null#)#{#if#(#revPrefix#.#length#(#)#>#0#)#{#return#new#NewRevision#(#revision#,#revPrefix#+#(#revPrefix#.#endsWith#(#revSep#)#?#defaultBuildNumber#:#revSep#+#defaultBuildNumber#)#,#null#,#defaultBuildNumber#)#;#}#else#{#Range#r#=#findLastNumber#(#defaultValue#)#;#if#(#r#==#null#)#{#// no number found#return#new#NewRevision#(#revision#,#defaultValue#,#null#,#null#)#;#}#else#{#long#n#=#Long#.#parseLong#(#defaultValue#.#substring#(#r#.#getStartIndex#(#)#,#r#.#getEndIndex#(#)#)#)#;#return#new#NewRevision#(#revision#,#defaultValue#,#null#,#String#.#valueOf#(#n#)#)#;#}#}#}#Range#r#;#if#(#revPrefix#.#length#(#)#==#0#)#{#r#=#findLastNumber#(#revision#)#;#if#(#r#==#null#)#{#return#new#NewRevision#(#revision#,#revision#+#(#revision#.#endsWith#(#revSep#)#?#"1"#:#revSep#+#"1"#)#,#null#,#"1"#)#;#}#}#else#{#r#=#findFirstNumber#(#revision#,#revPrefix#.#length#(#)#)#;#if#(#r#==#null#)#{#return#new#NewRevision#(#revision#,#revPrefix#+#(#revPrefix#.#endsWith#(#revSep#)#?#"1"#:#revSep#+#"1"#)#,#null#,#"1"#)#;#}#}#long#n#=#Long#.#parseLong#(#revision#.#substring#(#r#.#getStartIndex#(#)#,#r#.#getEndIndex#(#)#)#)#+#1#;#return#new#NewRevision#(#revision#,#revision#.#substring#(#0#,#r#.#getStartIndex#(#)#)#+#n#,#String#.#valueOf#(#n#-#1#)#,#String#.#valueOf#(#n#)#)#;#}##Range#findFirstNumber#(#String#str#,#int#startIndex#)#{#// let's find the first digit in the string#int#startNumberIndex#=#startIndex#;#while#(#startNumberIndex#<#str#.#length#(#)#&&#!#Character#.#isDigit#(#str#.#charAt#(#startNumberIndex#)#)#)#{#startNumberIndex#++#;#}#if#(#startNumberIndex#==#str#.#length#(#)#)#{#return#null#;#}#// let's find the end of the number#int#endNumberIndex#=#startNumberIndex#+#1#;#while#(#endNumberIndex#<#str#.#length#(#)#&&#Character#.#isDigit#(#str#.#charAt#(#endNumberIndex#)#)#)#{#endNumberIndex#++#;#}#return#new#Range#(#startNumberIndex#,#endNumberIndex#)#;#}##Range#findLastNumber#(#String#str#)#{#int#endNumberIndex#=#str#.#length#(#)#-#1#;#while#(#endNumberIndex#>=#0#&&#!#Character#.#isDigit#(#str#.#charAt#(#endNumberIndex#)#)#)#{#endNumberIndex#--#;#}#int#startNumberIndex#=#endNumberIndex#==#-#1#?#-#1#:#endNumberIndex#-#1#;#while#(#startNumberIndex#>=#0#&&#Character#.#isDigit#(#str#.#charAt#(#startNumberIndex#)#)#)#{#startNumberIndex#--#;#}#endNumberIndex#++#;#startNumberIndex#++#;#if#(#startNumberIndex#==#endNumberIndex#)#{#// no number found#return#null#;#}#else#{#return#new#Range#(#startNumberIndex#,#endNumberIndex#)#;#}#}##int#getStartIndex#(#)#{#return#startIndex#;#}##int#getEndIndex#(#)#{#return#endIndex#;#}##String#getRevision#(#)#{#return#revision#;#}##String#getNewRevision#(#)#{#return#newRevision#;#}##String#getBuildNumber#(#)#{#return#buildNumber#;#}##String#getNewBuildNumber#(#)#{#return#newBuildNumber#;#}##String#getRevSep#(#)#{#return#revSep#;#}##void#setRevSep#(#String#revSep#)#{#this#.#revSep#=#revSep#;#}##String#getDefaultBuildNumber#(#)#{#return#defaultBuildNumber#;#}##void#setDefaultBuildNumber#(#String#defaultBuildNumber#)#{#this#.#defaultBuildNumber#=#defaultBuildNumber#;#}##