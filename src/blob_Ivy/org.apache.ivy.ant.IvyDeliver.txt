String#resolve#(#ModuleDescriptor#published#,#String#publishedStatus#,#ModuleRevisionId#depMrid#,#String#depStatus#)#{#if#(#StatusManager#.#getCurrent#(#)#.#isIntegration#(#publishedStatus#)#)#{#// published status is integration one, nothing to ask#return#super#.#resolve#(#published#,#publishedStatus#,#depMrid#,#depStatus#)#;#}#// we are publishing a delivery (a non integration module)#if#(#!#StatusManager#.#getCurrent#(#)#.#isIntegration#(#depStatus#)#)#{#// dependency is already a delivery, nothing to ask#return#super#.#resolve#(#published#,#publishedStatus#,#depMrid#,#depStatus#)#;#}#// the dependency is not a delivery#String#statusProperty#=#depMrid#.#getName#(#)#+#"."#+#depMrid#.#getRevision#(#)#+#".status"#;#String#versionProperty#=#depMrid#.#getName#(#)#+#"."#+#depMrid#.#getRevision#(#)#+#".version"#;#String#deliveredProperty#=#depMrid#.#getName#(#)#+#"."#+#depMrid#.#getRevision#(#)#+#".delivered"#;#String#version#=#getProject#(#)#.#getProperty#(#versionProperty#)#;#String#status#=#getProject#(#)#.#getProperty#(#statusProperty#)#;#String#delivered#=#getProject#(#)#.#getProperty#(#deliveredProperty#)#;#Message#.#debug#(#"found version = "#+#version#+#" status="#+#status#+#" delivered="#+#delivered#)#;#if#(#version#!=#null#&&#status#!=#null#)#{#if#(#"true"#.#equals#(#delivered#)#)#{#// delivery has already been done : just return the value#return#version#;#}#else#{#deliverDependency#(#depMrid#,#version#,#status#,#depStatus#)#;#loadDeliveryList#(#)#;#return#version#;#}#}#/**
             * By setting these properties: recursive.delivery.status and
             * recursive.delivery.version, then if the specific status/version is not found, then we
             * will use the status/version set in these global properties. This will apply to all
             * artifacts in the system. This patch is meant to be used for recursive deliveries so
             * that all deliveries will use the global status/version unless a more specific one is
             * set.
             */#String#globalStatusProperty#=#"recursive.delivery.status"#;#String#globalVersionProperty#=#"recursive.delivery.version"#;#version#=#getProject#(#)#.#getProperty#(#globalVersionProperty#)#;#status#=#getProject#(#)#.#getProperty#(#globalStatusProperty#)#;#if#(#version#!=#null#&&#status#!=#null#)#{#// found global delivery properties#delivered#=#getProject#(#)#.#getProperty#(#"recursive."#+#depMrid#.#getName#(#)#+#".delivered"#)#;#Message#.#debug#(#"found global version = "#+#version#+#" and global status="#+#status#+#" - delivered = "#+#delivered#)#;#if#(#"true"#.#equals#(#delivered#)#)#{#// delivery has already been done : just return the value#return#version#;#}#else#{#getProject#(#)#.#setProperty#(#statusProperty#,#status#)#;#deliverDependency#(#depMrid#,#version#,#status#,#depStatus#)#;#loadDeliveryList#(#)#;#return#version#;#}#}#// we must ask the user what version and status he want to have#// for the dependency#Input#input#=#(#Input#)#getProject#(#)#.#createTask#(#"input"#)#;#input#.#setOwningTarget#(#getOwningTarget#(#)#)#;#input#.#init#(#)#;#// ask status#input#.#setMessage#(#depMrid#.#getName#(#)#+#" "#+#depMrid#.#getRevision#(#)#+#": please enter a status: "#)#;#input#.#setValidargs#(#StatusManager#.#getCurrent#(#)#.#getDeliveryStatusListString#(#)#)#;#input#.#setAddproperty#(#statusProperty#)#;#input#.#perform#(#)#;#status#=#getProject#(#)#.#getProperty#(#statusProperty#)#;#appendDeliveryList#(#statusProperty#+#" = "#+#status#)#;#// ask version#input#.#setMessage#(#depMrid#.#getName#(#)#+#" "#+#depMrid#.#getRevision#(#)#+#": please enter a version: "#)#;#input#.#setValidargs#(#null#)#;#input#.#setAddproperty#(#versionProperty#)#;#input#.#perform#(#)#;#version#=#getProject#(#)#.#getProperty#(#versionProperty#)#;#appendDeliveryList#(#versionProperty#+#" = "#+#version#)#;#deliverDependency#(#depMrid#,#version#,#status#,#depStatus#)#;#loadDeliveryList#(#)#;#return#version#;#}##void#deliverDependency#(#ModuleRevisionId#depMrid#,#String#version#,#String#status#,#String#depStatus#)#{#// call deliver target if any#if#(#deliverTarget#!=#null#&&#deliverTarget#.#trim#(#)#.#length#(#)#>#0#)#{#CallTarget#ct#=#(#CallTarget#)#getProject#(#)#.#createTask#(#"antcall"#)#;#ct#.#setOwningTarget#(#getOwningTarget#(#)#)#;#ct#.#init#(#)#;#ct#.#setTarget#(#deliverTarget#)#;#ct#.#setInheritAll#(#true#)#;#ct#.#setInheritRefs#(#true#)#;#Property#param#=#ct#.#createParam#(#)#;#param#.#setName#(#"dependency.name"#)#;#param#.#setValue#(#depMrid#.#getName#(#)#)#;#param#=#ct#.#createParam#(#)#;#param#.#setName#(#"dependency.published.status"#)#;#param#.#setValue#(#status#)#;#param#=#ct#.#createParam#(#)#;#param#.#setName#(#"dependency.published.version"#)#;#param#.#setValue#(#version#)#;#param#=#ct#.#createParam#(#)#;#param#.#setName#(#"dependency.version"#)#;#param#.#setValue#(#depMrid#.#getRevision#(#)#)#;#param#=#ct#.#createParam#(#)#;#param#.#setName#(#"dependency.status"#)#;#param#.#setValue#(#depStatus#==#null#?#"null"#:#depStatus#)#;#ct#.#perform#(#)#;#String#deliveredProperty#=#depMrid#.#getName#(#)#+#"."#+#depMrid#.#getRevision#(#)#+#".delivered"#;#getProject#(#)#.#setProperty#(#deliveredProperty#,#"true"#)#;#appendDeliveryList#(#deliveredProperty#+#" = true"#)#;#getProject#(#)#.#setProperty#(#"recursive."#+#depMrid#.#getName#(#)#+#".delivered"#,#"true"#)#;#appendDeliveryList#(#"recursive."#+#depMrid#.#getName#(#)#+#".delivered"#+#" = true"#)#;#}#}##void#setCache#(#File#cache#)#{#cacheAttributeNotSupported#(#)#;#}##String#getDeliverpattern#(#)#{#return#deliverpattern#;#}##void#setDeliverpattern#(#String#destivypattern#)#{#this#.#deliverpattern#=#destivypattern#;#}##String#getModule#(#)#{#return#module#;#}##void#setModule#(#String#module#)#{#this#.#module#=#module#;#}##String#getOrganisation#(#)#{#return#organisation#;#}##void#setOrganisation#(#String#organisation#)#{#this#.#organisation#=#organisation#;#}##String#getPubdate#(#)#{#return#pubdate#;#}##void#setPubdate#(#String#pubdate#)#{#this#.#pubdate#=#pubdate#;#}##String#getPubrevision#(#)#{#return#pubRevision#;#}##void#setPubrevision#(#String#pubRevision#)#{#this#.#pubRevision#=#pubRevision#;#}##String#getPubbranch#(#)#{#return#pubBranch#;#}##void#setPubbranch#(#String#pubBranch#)#{#this#.#pubBranch#=#pubBranch#;#}##String#getRevision#(#)#{#return#revision#;#}##void#setRevision#(#String#revision#)#{#this#.#revision#=#revision#;#}##String#getStatus#(#)#{#return#status#;#}##void#setStatus#(#String#status#)#{#this#.#status#=#status#;#}##void#setDelivertarget#(#String#deliverTarget#)#{#this#.#deliverTarget#=#deliverTarget#;#}##void#setDeliveryList#(#File#deliveryList#)#{#this#.#deliveryList#=#deliveryList#;#}##boolean#isReplacedynamicrev#(#)#{#return#replacedynamicrev#;#}##void#setReplacedynamicrev#(#boolean#replacedynamicrev#)#{#this#.#replacedynamicrev#=#replacedynamicrev#;#}##String#getResolveId#(#)#{#return#resolveId#;#}##void#setResolveId#(#String#resolveId#)#{#this#.#resolveId#=#resolveId#;#}##String#getConf#(#)#{#return#conf#;#}##void#setConf#(#String#confs#)#{#conf#=#confs#;#}##boolean#isGenerateRevConstraint#(#)#{#return#generateRevConstraint#;#}##void#setGenerateRevConstraint#(#boolean#generateRevConstraint#)#{#this#.#generateRevConstraint#=#generateRevConstraint#;#}##void#doExecute#(#)#throws#BuildException#{#Ivy#ivy#=#getIvyInstance#(#)#;#IvySettings#settings#=#ivy#.#getSettings#(#)#;#organisation#=#getProperty#(#organisation#,#settings#,#"ivy.organisation"#,#resolveId#)#;#module#=#getProperty#(#module#,#settings#,#"ivy.module"#,#resolveId#)#;#revision#=#getProperty#(#revision#,#settings#,#"ivy.revision"#,#resolveId#)#;#pubBranch#=#getProperty#(#pubBranch#,#settings#,#"ivy.deliver.branch"#)#;#pubRevision#=#getProperty#(#pubRevision#,#settings#,#"ivy.deliver.revision"#)#;#deliverpattern#=#getProperty#(#deliverpattern#,#settings#,#"ivy.deliver.ivy.pattern"#)#;#status#=#getProperty#(#status#,#settings#,#"ivy.status"#)#;#if#(#deliveryList#==#null#)#{#String#deliveryListPath#=#getProperty#(#settings#,#"ivy.delivery.list.file"#)#;#if#(#deliveryListPath#==#null#)#{#deliveryList#=#new#File#(#System#.#getProperty#(#"java.io.tmpdir"#)#+#"/delivery.properties"#)#;#}#else#{#deliveryList#=#getProject#(#)#.#resolveFile#(#settings#.#substitute#(#deliveryListPath#)#)#;#}#}#if#(#resolveId#==#null#)#{#if#(#organisation#==#null#)#{#throw#new#BuildException#(#"no organisation provided for ivy deliver task: "#+#"It can either be set explicitely via the attribute 'organisation' "#+#"or via 'ivy.organisation' property or a prior call to <resolve/>"#)#;#}#if#(#module#==#null#)#{#throw#new#BuildException#(#"no module name provided for ivy deliver task: "#+#"It can either be set explicitely via the attribute 'module' "#+#"or via 'ivy.module' property or a prior call to <resolve/>"#)#;#}#}#if#(#revision#==#null#)#{#revision#=#Ivy#.#getWorkingRevision#(#)#;#}#Date#pubdate#=#getPubDate#(#this#.#pubdate#,#new#Date#(#)#)#;#if#(#pubRevision#==#null#)#{#if#(#revision#.#startsWith#(#"working@"#)#)#{#pubRevision#=#Ivy#.#DATE_FORMAT#.#format#(#pubdate#)#;#}#else#{#pubRevision#=#revision#;#}#}#if#(#deliverpattern#==#null#)#{#throw#new#BuildException#(#"deliver ivy pattern is missing: either provide it as parameters "#+#"or through ivy.deliver.ivy.pattern properties"#)#;#}#if#(#status#==#null#)#{#throw#new#BuildException#(#"no status provided: either provide it as parameter or through "#+#"the ivy.status.default property"#)#;#}#ModuleRevisionId#mrid#=#null#;#if#(#resolveId#==#null#)#{#mrid#=#ModuleRevisionId#.#newInstance#(#organisation#,#module#,#revision#)#;#}#boolean#isLeading#=#false#;#try#{#if#(#!#deliveryList#.#exists#(#)#)#{#isLeading#=#true#;#}#loadDeliveryList#(#)#;#PublishingDependencyRevisionResolver#drResolver#;#if#(#deliverTarget#!=#null#&&#deliverTarget#.#trim#(#)#.#length#(#)#>#0#)#{#drResolver#=#new#DeliverDRResolver#(#)#;#}#else#{#drResolver#=#new#DefaultPublishingDRResolver#(#)#;#}#DeliverOptions#options#=#new#DeliverOptions#(#status#,#pubdate#,#drResolver#,#doValidate#(#settings#)#,#replacedynamicrev#,#splitConfs#(#conf#)#)#.#setResolveId#(#resolveId#)#.#setGenerateRevConstraint#(#generateRevConstraint#)#.#setPubBranch#(#pubBranch#)#;#if#(#mrid#==#null#)#{#ivy#.#deliver#(#pubRevision#,#deliverpattern#,#options#)#;#}#else#{#ivy#.#deliver#(#mrid#,#pubRevision#,#deliverpattern#,#options#)#;#}#}#catch#(#Exception#e#)#{#throw#new#BuildException#(#"impossible to deliver "#+#mrid#==#null#?#resolveId#:#mrid#+#": "#+#e#,#e#)#;#}#finally#{#if#(#isLeading#)#{#if#(#deliveryList#.#exists#(#)#)#{#deliveryList#.#delete#(#)#;#}#}#}#}##void#loadDeliveryList#(#)#{#Property#property#=#(#Property#)#getProject#(#)#.#createTask#(#"property"#)#;#property#.#setOwningTarget#(#getOwningTarget#(#)#)#;#property#.#init#(#)#;#property#.#setFile#(#deliveryList#)#;#property#.#perform#(#)#;#}##void#appendDeliveryList#(#String#msg#)#{#Echo#echo#=#(#Echo#)#getProject#(#)#.#createTask#(#"echo"#)#;#echo#.#setOwningTarget#(#getOwningTarget#(#)#)#;#echo#.#init#(#)#;#echo#.#setFile#(#deliveryList#)#;#echo#.#setMessage#(#msg#+#"\n"#)#;#echo#.#setAppend#(#true#)#;#echo#.#perform#(#)#;#}##