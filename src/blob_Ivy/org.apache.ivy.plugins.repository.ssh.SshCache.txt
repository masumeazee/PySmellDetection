SshCache#getInstance#(#)#{#return#instance#;#}##String#getHost#(#)#{#return#host#;#}##int#getPort#(#)#{#return#port#;#}##String#getUser#(#)#{#return#user#;#}##void#progress#(#IvyEvent#event#)#{#event#.#getSource#(#)#.#removeIvyListener#(#this#)#;#clearSession#(#session#)#;#}##void#setChannelSftp#(#ChannelSftp#newChannel#)#{#if#(#channelSftp#!=#null#&&#newChannel#!=#null#)#{#throw#new#IllegalStateException#(#"Only one sftp channelSftp per session allowed"#)#;#}#this#.#channelSftp#=#newChannel#;#}##ChannelSftp#getChannelSftp#(#)#{#return#channelSftp#;#}##Session#getSession#(#)#{#return#session#;#}##void#releaseChannelSftp#(#)#{#if#(#channelSftp#!=#null#)#{#if#(#channelSftp#.#isConnected#(#)#)#{#Message#.#verbose#(#":: SFTP :: closing sftp connection from "#+#host#+#"..."#)#;#channelSftp#.#disconnect#(#)#;#channelSftp#=#null#;#Message#.#verbose#(#":: SFTP :: sftp connection closed from "#+#host#)#;#}#}#}##Entry#getCacheEntry#(#String#user#,#String#host#,#int#port#)#{#return#(#Entry#)#uriCacheMap#.#get#(#createCacheKey#(#user#,#host#,#port#)#)#;#}##String#createCacheKey#(#String#user#,#String#host#,#int#port#)#{#String#portToUse#=#"22"#;#if#(#port#!=#-#1#&&#port#!=#SSH_DEFAULT_PORT#)#{#portToUse#=#Integer#.#toString#(#port#)#;#}#return#user#.#toLowerCase#(#Locale#.#US#)#.#trim#(#)#+#"@"#+#host#.#toLowerCase#(#Locale#.#US#)#.#trim#(#)#+#":"#+#portToUse#;#}##Entry#getCacheEntry#(#Session#session#)#{#return#(#Entry#)#sessionCacheMap#.#get#(#session#)#;#}##void#setSession#(#String#user#,#String#host#,#int#port#,#Session#newSession#)#{#Entry#entry#=#(#Entry#)#uriCacheMap#.#get#(#createCacheKey#(#user#,#host#,#port#)#)#;#Session#oldSession#=#null#;#if#(#entry#!=#null#)#{#oldSession#=#entry#.#getSession#(#)#;#}#if#(#oldSession#!=#null#&&#!#oldSession#.#equals#(#newSession#)#&&#oldSession#.#isConnected#(#)#)#{#entry#.#releaseChannelSftp#(#)#;#String#oldhost#=#oldSession#.#getHost#(#)#;#Message#.#verbose#(#":: SSH :: closing ssh connection from "#+#oldhost#+#"..."#)#;#oldSession#.#disconnect#(#)#;#Message#.#verbose#(#":: SSH :: ssh connection closed from "#+#oldhost#)#;#}#if#(#(#newSession#==#null#)#&&#(#entry#!=#null#)#)#{#uriCacheMap#.#remove#(#createCacheKey#(#user#,#host#,#port#)#)#;#if#(#entry#.#getSession#(#)#!=#null#)#{#sessionCacheMap#.#remove#(#entry#.#getSession#(#)#)#;#}#}#else#{#Entry#newEntry#=#new#Entry#(#newSession#,#user#,#host#,#port#)#;#uriCacheMap#.#put#(#createCacheKey#(#user#,#host#,#port#)#,#newEntry#)#;#sessionCacheMap#.#put#(#newSession#,#newEntry#)#;#}#}##void#clearSession#(#Session#session#)#{#Entry#entry#=#(#Entry#)#sessionCacheMap#.#get#(#session#)#;#if#(#entry#!=#null#)#{#setSession#(#entry#.#getUser#(#)#,#entry#.#getHost#(#)#,#entry#.#getPort#(#)#,#null#)#;#}#}##ChannelSftp#getChannelSftp#(#Session#session#)#throws#IOException#{#ChannelSftp#channel#=#null#;#Entry#entry#=#getCacheEntry#(#session#)#;#if#(#entry#!=#null#)#{#channel#=#entry#.#getChannelSftp#(#)#;#if#(#channel#!=#null#&&#!#channel#.#isConnected#(#)#)#{#entry#.#releaseChannelSftp#(#)#;#channel#=#null#;#}#}#return#channel#;#}##void#attachChannelSftp#(#Session#session#,#ChannelSftp#channel#)#{#Entry#entry#=#getCacheEntry#(#session#)#;#if#(#entry#==#null#)#{#throw#new#IllegalArgumentException#(#"No entry for "#+#session#+#" in the cache"#)#;#}#entry#.#setChannelSftp#(#channel#)#;#}##Session#getSession#(#String#host#,#int#port#,#String#username#,#String#userPassword#,#File#pemFile#,#String#pemPassword#,#File#passFile#)#throws#IOException#{#Checks#.#checkNotNull#(#host#,#"host"#)#;#Checks#.#checkNotNull#(#username#,#"user"#)#;#Entry#entry#=#getCacheEntry#(#username#,#host#,#port#)#;#Session#session#=#null#;#if#(#entry#!=#null#)#{#session#=#entry#.#getSession#(#)#;#}#if#(#session#==#null#||#!#session#.#isConnected#(#)#)#{#Message#.#verbose#(#":: SSH :: connecting to "#+#host#+#"..."#)#;#try#{#JSch#jsch#=#new#JSch#(#)#;#if#(#port#!=#-#1#)#{#session#=#jsch#.#getSession#(#username#,#host#,#port#)#;#}#else#{#session#=#jsch#.#getSession#(#username#,#host#)#;#}#if#(#pemFile#!=#null#)#{#jsch#.#addIdentity#(#pemFile#.#getAbsolutePath#(#)#,#pemPassword#)#;#}#session#.#setUserInfo#(#new#CfUserInfo#(#host#,#username#,#userPassword#,#pemFile#,#pemPassword#,#passFile#)#)#;#session#.#setDaemonThread#(#true#)#;#session#.#connect#(#)#;#Message#.#verbose#(#":: SSH :: connected to "#+#host#+#"!"#)#;#setSession#(#username#,#host#,#port#,#session#)#;#}#catch#(#JSchException#e#)#{#if#(#passFile#!=#null#&&#passFile#.#exists#(#)#)#{#passFile#.#delete#(#)#;#}#IOException#ex#=#new#IOException#(#e#.#getMessage#(#)#)#;#ex#.#initCause#(#e#)#;#throw#ex#;#}#}#return#session#;#}##void#showMessage#(#String#message#)#{#Message#.#info#(#message#)#;#}##boolean#promptYesNo#(#String#message#)#{#return#true#;#}##boolean#promptPassword#(#String#message#)#{#return#true#;#}##boolean#promptPassphrase#(#String#message#)#{#return#true#;#}##String#getPassword#(#)#{#if#(#userPassword#==#null#)#{#Credentials#c#=#CredentialsUtil#.#promptCredentials#(#new#Credentials#(#null#,#host#,#userName#,#userPassword#)#,#passfile#)#;#if#(#c#!=#null#)#{#userName#=#c#.#getUserName#(#)#;#userPassword#=#c#.#getPasswd#(#)#;#}#}#return#userPassword#;#}##String#getPassphrase#(#)#{#if#(#pemPassword#==#null#&&#pemFile#!=#null#)#{#Credentials#c#=#CredentialsUtil#.#promptCredentials#(#new#Credentials#(#null#,#pemFile#.#getAbsolutePath#(#)#,#userName#,#pemPassword#)#,#passfile#)#;#if#(#c#!=#null#)#{#userName#=#c#.#getUserName#(#)#;#pemPassword#=#c#.#getPasswd#(#)#;#}#}#return#pemPassword#;#}##String#[#]#promptKeyboardInteractive#(#String#destination#,#String#name#,#String#instruction#,#String#[#]#prompt#,#boolean#[#]#echo#)#{#return#new#String#[#]#{#getPassword#(#)#}#;#}##