void#build#(#Resource#packagerResource#,#Map#properties#)#throws#IOException#{#// Sanity check#if#(#this#.#built#)#{#throw#new#IllegalStateException#(#"build in directory `"#+#this#.#dir#+#"' already completed"#)#;#}#// Remove work directory if it exists (e.g. left over from last time)#if#(#this#.#dir#.#exists#(#)#)#{#if#(#!#cleanup#(#)#)#{#throw#new#IOException#(#"can't remove directory `"#+#this#.#dir#+#"'"#)#;#}#}#// Create work directory#if#(#!#this#.#dir#.#mkdirs#(#)#)#{#throw#new#IOException#(#"can't create directory `"#+#this#.#dir#+#"'"#)#;#}#// Write out packager XML#InputStream#packagerXML#=#packagerResource#.#openStream#(#)#;#saveFile#(#"packager.xml"#,#packagerXML#)#;#// Write packager XSLT#saveFile#(#"packager.xsl"#)#;#// Write packager XSD#saveFile#(#"packager-1.0.xsd"#)#;#// Write master Ant build file#saveFile#(#"build.xml"#)#;#// Execute the Ant build file#Project#project#=#new#Project#(#)#;#project#.#init#(#)#;#project#.#setUserProperty#(#"ant.file"#,#new#File#(#dir#,#"build.xml"#)#.#getAbsolutePath#(#)#)#;#ProjectHelper#.#configureProject#(#project#,#new#File#(#dir#,#"build.xml"#)#)#;#project#.#setBaseDir#(#dir#)#;#// Configure logging verbosity#BuildLogger#logger#=#new#DefaultLogger#(#)#;#logger#.#setMessageOutputLevel#(#this#.#verbose#?#Project#.#MSG_VERBOSE#:#this#.#quiet#?#Project#.#MSG_WARN#:#Project#.#MSG_INFO#)#;#logger#.#setOutputPrintStream#(#System#.#out#)#;#logger#.#setErrorPrintStream#(#System#.#err#)#;#project#.#addBuildListener#(#logger#)#;#// Set properties#project#.#setUserProperty#(#"ivy.packager.organisation"#,#""#+#this#.#mr#.#getModuleId#(#)#.#getOrganisation#(#)#)#;#project#.#setUserProperty#(#"ivy.packager.module"#,#""#+#this#.#mr#.#getModuleId#(#)#.#getName#(#)#)#;#project#.#setUserProperty#(#"ivy.packager.revision"#,#""#+#this#.#mr#.#getRevision#(#)#)#;#project#.#setUserProperty#(#"ivy.packager.branch"#,#""#+#this#.#mr#.#getBranch#(#)#)#;#if#(#this#.#resourceCache#!=#null#)#{#project#.#setUserProperty#(#"ivy.packager.resourceCache"#,#""#+#this#.#resourceCache#.#getCanonicalPath#(#)#)#;#}#if#(#this#.#resourceURL#!=#null#)#{#project#.#setUserProperty#(#"ivy.packager.resourceURL"#,#""#+#getResourceURL#(#)#)#;#}#if#(#this#.#validate#)#{#project#.#setUserProperty#(#"ivy.packager.validate"#,#"true"#)#;#}#project#.#setUserProperty#(#"ivy.packager.restricted"#,#""#+#this#.#restricted#)#;#if#(#properties#!=#null#)#{#for#(#Iterator#it#=#properties#.#entrySet#(#)#.#iterator#(#)#;#it#.#hasNext#(#)#;#)#{#Entry#entry#=#(#Entry#)#it#.#next#(#)#;#project#.#setUserProperty#(#(#String#)#entry#.#getKey#(#)#,#(#String#)#entry#.#getValue#(#)#)#;#}#}#// Execute task#Message#.#verbose#(#"performing packager resolver build in "#+#this#.#dir#)#;#try#{#project#.#executeTarget#(#"build"#)#;#this#.#built#=#true#;#}#catch#(#BuildException#e#)#{#e#.#printStackTrace#(#System#.#out#)#;#Message#.#verbose#(#"packager resolver build failed: "#+#e#)#;#throw#e#;#}#}##boolean#isBuilt#(#)#{#return#this#.#built#;#}##ResolvedResource#getBuiltArtifact#(#Artifact#artifact#)#{#if#(#!#this#.#built#)#{#throw#new#IllegalStateException#(#"build in directory `"#+#this#.#dir#+#"' has not yet successfully completed"#)#;#}#return#new#ResolvedResource#(#new#BuiltFileResource#(#this#.#dir#,#artifact#)#,#this#.#mr#.#getRevision#(#)#)#;#}##boolean#cleanup#(#)#{#this#.#built#=#false#;#return#FileUtil#.#forceDelete#(#this#.#dir#)#;#}##void#saveFile#(#String#name#,#InputStream#input#)#throws#IOException#{#FileUtil#.#copy#(#input#,#new#File#(#this#.#dir#,#name#)#,#null#)#;#}##void#saveFile#(#String#name#)#throws#IOException#{#InputStream#input#=#getClass#(#)#.#getResourceAsStream#(#name#)#;#if#(#input#==#null#)#{#throw#new#IOException#(#"can't find resource `"#+#name#+#"'"#)#;#}#saveFile#(#name#,#input#)#;#}##void#finalize#(#)#throws#Throwable#{#try#{#if#(#!#this#.#preserve#)#{#cleanup#(#)#;#}#}#finally#{#super#.#finalize#(#)#;#}#}##String#getResourceURL#(#)#{#String#baseURL#=#IvyPatternHelper#.#substitute#(#this#.#resourceURL#,#this#.#mr#.#getOrganisation#(#)#,#this#.#mr#.#getName#(#)#,#this#.#mr#.#getRevision#(#)#,#null#,#null#,#null#,#null#,#this#.#mr#.#getAttributes#(#)#,#null#)#;#int#slash#=#baseURL#.#lastIndexOf#(#'/'#)#;#if#(#slash#!=#-#1#)#{#baseURL#=#baseURL#.#substring#(#0#,#slash#+#1#)#;#}#return#baseURL#;#}##File#getSubdir#(#File#rootDir#,#ModuleRevisionId#mr#)#{#return#new#File#(#rootDir#,#mr#.#getOrganisation#(#)#+#File#.#separatorChar#+#mr#.#getName#(#)#+#File#.#separatorChar#+#mr#.#getRevision#(#)#)#;#}##